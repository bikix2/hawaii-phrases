<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸšŒãƒãƒ¯ã‚¤æ—…è¡Œãƒ—ãƒ©ãƒ³ã€å®Œå…¨ç‰ˆã€‘</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Yu Gothic', 'Meiryo', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 10px; line-height: 1.7; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; min-height: 80vh;}
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header { background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { font-size: 20px; margin-bottom: 5px; }
        .header .dates { font-size: 14px; opacity: 0.95; }
        
        /* ã‚¿ãƒ–ã‚¨ãƒªã‚¢ */
        .tabs { display: flex; background: #f5f5f5; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tab { flex: 1; min-width: 80px; padding: 12px 5px; text-align: center; background: #e0e0e0; border: none; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s; border-right: 1px solid #ccc; flex-shrink: 0; }
        .tab.active { background: white; color: #FF6B6B; border-bottom: 3px solid #FF6B6B; }
        .tab.note-tab { background: #E1F5FE; color: #0277BD; } 
        .tab.note-tab.active { border-bottom: 3px solid #0277BD; background: white; }

        /* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.5s; padding-bottom: 100px; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«é …ç›® */
        .day-title { color: #FF6B6B; font-size: 20px; margin-bottom: 15px; border-bottom: 3px solid #FF6B6B; }
        .schedule-item { background: #f9f9f9; border-left: 4px solid #4ECDC4; padding: 15px; margin-bottom: 20px; border-radius: 8px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .time { font-weight: bold; color: #FF6B6B; font-size: 15px; }
        .location { font-size: 18px; font-weight: bold; color: #333; margin: 5px 0; }
        .details { color: #555; font-size: 14px; white-space: pre-wrap; margin-bottom: 10px; }

        /* ç”»åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .image-gallery { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .attached-image { height: 100px; width: auto; border-radius: 5px; cursor: pointer; border: 2px solid #ddd; object-fit: cover; }
        .attached-image:hover { border-color: #FF6B6B; }

        /* ãƒãƒ¼ãƒˆç”¨ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ä»˜ãï¼‰ */
        .gallery-item { position: relative; display: inline-block; margin-right: 10px; margin-bottom: 10px; }
        .gallery-item img { height: 100px; width: auto; border-radius: 5px; border: 2px solid #ddd; object-fit: cover; }
        .delete-img-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 20px; height: 20px; text-align: center; line-height: 20px; font-size: 12px; cursor: pointer; border: 1px solid white; box-shadow: 0 2px 2px rgba(0,0,0,0.3); }

        /* ãƒœã‚¿ãƒ³é¡ */
        .link-btn { display: inline-block; padding: 5px 10px; color: white; text-decoration: none; border-radius: 4px; font-size: 12px; margin-right: 5px; margin-bottom: 5px; }
        .link-btn.ref { background: #9C27B0; }
        .link-btn.place { background: #34A853; }
        .link-btn.bus-board { background: #2196F3; }
        .link-btn.bus-drop { background: #FF9800; }

        .edit-controls { position: absolute; top: 10px; right: 10px; }
        .edit-controls button { background: #4A90E2; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px; margin-left: 3px; }
        .edit-controls .delete-btn { background: #FF6B6B; }

        .add-button { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 16px; }

        /* ä»˜ç®‹ï¼ˆSticky Noteï¼‰ã‚¹ã‚¿ã‚¤ãƒ« */
        .note-controls { display: flex; gap: 5px; margin-bottom: 15px; align-items: center; background: #eee; padding: 10px; border-radius: 8px; }
        .color-picker { display: flex; gap: 5px; }
        .color-dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot.selected { border-color: #555; transform: scale(1.1); }
        
        .sticky-notes-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 10px 0; }
        .sticky-note { position: relative; padding: 15px; padding-top: 25px; border-radius: 5px; box-shadow: 2px 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; min-height: 150px; display: flex; flex-direction: column; }
        .sticky-note:hover { transform: translateY(-2px); box-shadow: 3px 3px 8px rgba(0,0,0,0.2); }
        .note-delete-btn { position: absolute; top: 5px; right: 5px; background: transparent; border: none; color: rgba(0,0,0,0.4); font-size: 16px; cursor: pointer; }
        .note-delete-btn:hover { color: #d32f2f; }
        .note-content { width: 100%; flex-grow: 1; background: transparent; border: none; resize: none; font-size: 14px; outline: none; line-height: 1.5; font-family: inherit; }

        /* ãƒãƒ¼ãƒˆã®è‰²å®šç¾© */
        .note-yellow { background-color: #fff740; }
        .note-pink   { background-color: #ffccbc; }
        .note-blue   { background-color: #b3e5fc; }
        .note-green  { background-color: #c8e6c9; }

        /* ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ  */
        .edit-form { background: #f0f8ff; border: 2px solid #4A90E2; padding: 20px; margin-top: 15px; border-radius: 8px; }
        .edit-form label { display: block; margin-top: 10px; font-weight: bold; font-size: 13px; color: #333; }
        .edit-form input[type="text"], .edit-form textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; }
        .file-input-group { background: white; padding: 10px; border: 1px dashed #999; margin-top: 5px; border-radius: 4px; }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="loading-overlay" id="global-loader">
        <div class="loader"></div>
        <div style="margin-top: 10px; font-weight:bold; color:#333;">å‡¦ç†ä¸­...ãã®ã¾ã¾ãŠå¾…ã¡ãã ã•ã„</div>
    </div>

    <div class="container">
        <div class="header">
            <h1>ğŸŒº ãƒãƒ¯ã‚¤æ—…è¡Œãƒ—ãƒ©ãƒ³ ğŸŒº</h1>
            <div class="dates">Day0: 12/12(é‡‘) å‡ºç™º ã€œ Day8: 12/19(é‡‘) å¸°å›½</div>
        </div>
        
        <div class="tabs">
            <button class="tab active" data-day="0">Day0<br>12/12é‡‘</button>
            <button class="tab" data-day="1">Day1<br>12/12é‡‘</button>
            <button class="tab" data-day="2">Day2<br>12/13åœŸ</button>
            <button class="tab" data-day="3">Day3<br>12/14æ—¥</button>
            <button class="tab" data-day="4">Day4<br>12/15æœˆ</button>
            <button class="tab" data-day="5">Day5<br>12/16ç«</button>
            <button class="tab" data-day="6">Day6<br>12/17æ°´</button>
            <button class="tab" data-day="7">Day7<br>12/18æœ¨</button>
            <button class="tab" data-day="8">Day8<br>12/19é‡‘</button>
            <button class="tab note-tab" data-day="99">ğŸ“<br>ãƒãƒ¼ãƒˆ</button>
        </div>
        
        <div id="day0" class="tab-content active"><div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div></div>
        <div id="day1" class="tab-content"></div>
        <div id="day2" class="tab-content"></div>
        <div id="day3" class="tab-content"></div>
        <div id="day4" class="tab-content"></div>
        <div id="day5" class="tab-content"></div>
        <div id="day6" class="tab-content"></div>
        <div id="day7" class="tab-content"></div>
        <div id="day8" class="tab-content"></div>
        
        <div id="day99" class="tab-content">
            <h2 class="day-title">ğŸ“ å…±æœ‰ä»˜ç®‹ãƒãƒ¼ãƒˆ & ãƒ•ã‚©ãƒˆ</h2>
            
            <div class="note-container">
                <div class="note-controls">
                    <span style="font-size:12px; font-weight:bold;">è‰²ã‚’é¸æŠ:</span>
                    <div class="color-picker">
                        <div class="color-dot note-yellow selected" onclick="selectNoteColor('yellow', this)"></div>
                        <div class="color-dot note-pink" onclick="selectNoteColor('pink', this)"></div>
                        <div class="color-dot note-blue" onclick="selectNoteColor('blue', this)"></div>
                        <div class="color-dot note-green" onclick="selectNoteColor('green', this)"></div>
                    </div>
                    <button onclick="addStickyNote()" style="margin-left:auto; padding:5px 15px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer; font-size:12px;">ï¼‹ ä»˜ç®‹ã‚’è¿½åŠ </button>
                </div>
                
                <p style="font-size:11px; color:#666; margin-bottom:5px;">â€»æ–‡å­—ã‚’å…¥åŠ›ã—ã¦å¤–å´ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</p>
                <div id="sticky-notes-area" class="sticky-notes-container">
                    </div>

                <div style="margin-top: 25px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #ddd;">
                    <h3 style="font-size: 16px; margin-bottom: 10px;">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã®æ›¸ãå‡ºã—</h3>
                    
                    <div style="margin-bottom: 10px; font-size: 13px; display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="cursor:pointer;"><input type="checkbox" id="exp-time" checked> æ™‚é–“</label>
                        <label style="cursor:pointer;"><input type="checkbox" id="exp-loc" checked> å ´æ‰€</label>
                        <label style="cursor:pointer;"><input type="checkbox" id="exp-memo"> è©³ç´°ãƒ¡ãƒ¢</label>
                        <label style="cursor:pointer;"><input type="checkbox" id="exp-url"> URLãƒªãƒ³ã‚¯</label>
                    </div>

                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button onclick="copyScheduleToClipboard()" style="flex: 1; padding: 10px; background: #673AB7; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ“‹ é¸æŠé …ç›®ã‚’ã‚³ãƒ”ãƒ¼<br><span style="font-size:10px">(LINEé€ä¿¡å‘ã‘)</span>
                        </button>
                        <button onclick="downloadBackupJSON()" style="flex: 1; padding: 10px; background: #607D8B; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜<br><span style="font-size:10px">(å…¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜)</span>
                        </button>
                    </div>
                </div>
                <hr style="margin: 20px 0;">
                
                <h3>ğŸ“¸ å…±æœ‰ã‚¢ãƒ«ãƒãƒ </h3>
                <p style="font-size:12px; color:#666;">ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦å…±æœ‰ã§ãã¾ã™</p>
                <div style="margin: 10px 0;">
                    <input type="file" id="note-image-upload" accept="image/*">
                    <button onclick="uploadNoteImage()" style="padding:5px 10px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>
                <div id="note-images" class="image-gallery">
                    </div>
            </div>
        </div>
    </div>
    
    <script>
        // ==========================================================
        // 1. Firebaseè¨­å®š
        // ==========================================================
        const firebaseConfig = {
             apiKey: "AIzaSyCiqsqaImSG8DeBD_KAc9OUKd6ZY_QKV8I",
             authDomain: "hawaii-trip-planner.firebaseapp.com",
             projectId: "hawaii-trip-planner",
             storageBucket: "hawaii-trip-planner.firebasestorage.app", 
             messagingSenderId: "785694777772",
             appId: "1:785694777772:web:cac69c49d3386c663c5a09"
        };

        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const storage = firebase.storage();

        let currentDay = 0; 
        let scheduleData = {}; 
        let noteData = { notes: [] }; // ä»˜ç®‹ãƒ‡ãƒ¼ã‚¿ã®ä¿æŒç”¨
        let selectedColor = 'yellow'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä»˜ç®‹è‰²

        function toggleLoader(show) {
            document.getElementById('global-loader').style.display = show ? 'flex' : 'none';
        }

        // ==========================================================
        // 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸé–‹å§‹
        // ==========================================================
        function startRealtimeListener() {
            // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åŒæœŸ
            db.collection('trip-schedule').onSnapshot(snapshot => {
                snapshot.forEach(doc => {
                    if (doc.id !== 'note-data') {
                        scheduleData[doc.id] = doc.data();
                    }
                });
                if (currentDay !== 99) {
                    renderSchedule(currentDay);
                }
            });

            // ãƒãƒ¼ãƒˆåŒæœŸï¼ˆæ§‹é€ å¤‰æ›´ã«å¯¾å¿œï¼‰
            db.collection('trip-schedule').doc('note-data').onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    
                    // æ—§ãƒ‡ãƒ¼ã‚¿(contentæ–‡å­—åˆ—)ãŒã‚ã‚‹å ´åˆã€ä»˜ç®‹ã«ç§»è¡Œã™ã‚‹å‡¦ç†ï¼ˆåˆå›ã®ã¿ï¼‰
                    if (data.content && (!data.notes || data.notes.length === 0)) {
                        const migratedNote = {
                            id: Date.now(),
                            text: data.content,
                            color: 'yellow'
                        };
                        // DBæ›´æ–°
                        db.collection('trip-schedule').doc('note-data').update({
                            notes: [migratedNote],
                            content: firebase.firestore.FieldValue.delete() // å¤ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å‰Šé™¤
                        });
                        return; // æ›´æ–°å¾Œã«å†é€šçŸ¥ãŒæ¥ã‚‹ã®ã§ã“ã“ã§çµ‚äº†
                    }

                    noteData.notes = data.notes || [];
                    renderStickyNotes();
                    renderNoteImages(data.images || []);
                }
            });
        }

        // ==========================================================
        // 3. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«æç”»
        // ==========================================================
        function renderSchedule(dayNum) {
            const dayKey = `day${dayNum}`;
            const contentDiv = document.getElementById(dayKey);
            const dayData = scheduleData[dayKey] || {};
            
            let events = dayData.events || [];
            events.sort((a, b) => {
                const timeA = (a.time || '').toString();
                const timeB = (b.time || '').toString();
                return timeA.localeCompare(timeB);
            });

            let html = `<h2 class="day-title">${dayData.title || (dayNum + 'æ—¥ç›®')}</h2>`;
            
            if (events.length === 0) {
                html += '<p style="text-align:center; color:#888;">äºˆå®šãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            }

            events.forEach((item, index) => {
                let mapButtonsHtml = '';
                if (item.refUrl1 || item.refUrl2 || item.refUrl3 || item.mapUrl_place || item.mapUrl_bus_board || item.mapUrl_bus_drop) {
                     mapButtonsHtml = '<div style="margin-top:8px;">';
                     if (item.refUrl1) mapButtonsHtml += `<a href="${item.refUrl1}" class="link-btn ref" target="_blank">ğŸ  å‚è€ƒ1</a>`;
                     if (item.refUrl2) mapButtonsHtml += `<a href="${item.refUrl2}" class="link-btn ref" target="_blank">ğŸ  å‚è€ƒ2</a>`;
                     if (item.refUrl3) mapButtonsHtml += `<a href="${item.refUrl3}" class="link-btn ref" target="_blank">ğŸ  å‚è€ƒ3</a>`;
                     if (item.mapUrl_place) mapButtonsHtml += `<a href="${item.mapUrl_place}" class="link-btn place" target="_blank">ğŸ—ºï¸ å ´æ‰€</a>`;
                     if (item.mapUrl_bus_board) mapButtonsHtml += `<a href="${item.mapUrl_bus_board}" class="link-btn bus-board" target="_blank">ğŸš ä¹—è»Š</a>`;
                     if (item.mapUrl_bus_drop) mapButtonsHtml += `<a href="${item.mapUrl_bus_drop}" class="link-btn bus-drop" target="_blank">ğŸ é™è»Š</a>`;
                     mapButtonsHtml += '</div>';
                }

                let imagesHtml = '';
                if (item.imgUrl1 || item.imgUrl2) {
                    imagesHtml = '<div class="image-gallery">';
                    if (item.imgUrl1) imagesHtml += `<a href="${item.imgUrl1}" target="_blank"><img src="${item.imgUrl1}" class="attached-image"></a>`;
                    if (item.imgUrl2) imagesHtml += `<a href="${item.imgUrl2}" target="_blank"><img src="${item.imgUrl2}" class="attached-image"></a>`;
                    imagesHtml += '</div>';
                }

                const formattedDetails = (item.details || '').replace(/\n/g, '<br>');

                html += `
                    <div class="schedule-item">
                        <div class="edit-controls">
                            <button onclick="showForm(${dayNum}, ${index})">âœï¸ ç·¨é›†</button>
                            <button onclick="deleteEvent(${dayNum}, ${index}, '${item.location}')" class="delete-btn">ğŸ—‘ï¸</button>
                        </div>
                        <div class="time">${item.time || ''}</div>
                        <div class="location">${item.location || ''}</div>
                        <div class="details">${formattedDetails}</div>
                        ${mapButtonsHtml}
                        ${imagesHtml}
                    </div>
                `;
            });
            
            html += `<button class="add-button" onclick="showForm(${dayNum}, -1)">â• æ–°ã—ã„äºˆå®šã‚’è¿½åŠ </button>`;
            html += `<div id="form-container-${dayNum}"></div>`; 

            contentDiv.innerHTML = html;
        }

        // ==========================================================
        // 4. ä»˜ç®‹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ (Sticky Notes)
        // ==========================================================
        function selectNoteColor(color, el) {
            selectedColor = color;
            document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
            el.classList.add('selected');
        }

        function renderStickyNotes() {
            const container = document.getElementById('sticky-notes-area');
            if (noteData.notes.length === 0) {
                container.innerHTML = '<p style="color:#aaa; width:100%;">ä»˜ç®‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„...</p>';
                return;
            }

            let html = '';
            // æ–°ã—ã„é †ã«è¡¨ç¤º
            const sortedNotes = [...noteData.notes].sort((a,b) => b.id - a.id);

            sortedNotes.forEach(note => {
                html += `
                    <div class="sticky-note note-${note.color}">
                        <button class="note-delete-btn" onclick="deleteStickyNote(${note.id})">Ã—</button>
                        <textarea 
                            class="note-content" 
                            onblur="updateStickyNote(${note.id}, this.value)"
                            placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›...">${note.text || ''}</textarea>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function addStickyNote() {
            const newNote = {
                id: Date.now(), // ä¸€æ„ã®ID
                text: "",
                color: selectedColor
            };
            
            const newNotes = [...noteData.notes, newNote];
            
            db.collection('trip-schedule').doc('note-data').set({
                notes: newNotes
            }, { merge: true })
            .catch(err => alert("è¿½åŠ ã‚¨ãƒ©ãƒ¼: " + err));
        }

        function updateStickyNote(id, text) {
            const target = noteData.notes.find(n => n.id === id);
            if(target && target.text === text) return;

            const updatedNotes = noteData.notes.map(n => {
                if (n.id === id) return { ...n, text: text };
                return n;
            });

            db.collection('trip-schedule').doc('note-data').update({
                notes: updatedNotes
            }).catch(err => console.error("ä¿å­˜ã‚¨ãƒ©ãƒ¼", err));
        }

        function deleteStickyNote(id) {
            if(!confirm("ã“ã®ä»˜ç®‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            
            const filteredNotes = noteData.notes.filter(n => n.id !== id);
            db.collection('trip-schedule').doc('note-data').update({
                notes: filteredNotes
            }).catch(err => alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + err));
        }

        // ==========================================================
        // 5. å…±æœ‰ã‚¢ãƒ«ãƒãƒ æ©Ÿèƒ½ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»å‰Šé™¤ï¼‰
        // ==========================================================
        async function uploadNoteImage() {
            const fileInput = document.getElementById('note-image-upload');
            if (fileInput.files.length === 0) return alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            toggleLoader(true);
            const file = fileInput.files[0];
            const storageRef = storage.ref(`note_images/${Date.now()}_${file.name}`);
            
            try {
                await storageRef.put(file);
                const url = await storageRef.getDownloadURL();
                await db.collection('trip-schedule').doc('note-data').update({
                    images: firebase.firestore.FieldValue.arrayUnion(url)
                });
                fileInput.value = '';
                toggleLoader(false);
            } catch (error) {
                if (error.code === 'not-found' || error.message.includes('No document')) {
                     await db.collection('trip-schedule').doc('note-data').set({ images: [url], notes: [] }, { merge: true });
                     toggleLoader(false);
                } else {
                    alert("ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: " + error.message);
                    toggleLoader(false);
                }
            }
        }

        function renderNoteImages(images) {
            const container = document.getElementById('note-images');
            if (!images || images.length === 0) { container.innerHTML = ''; return; }
            let html = '';
            images.forEach(url => {
                html += `
                <div class="gallery-item">
                    <a href="${url}" target="_blank"><img src="${url}"></a>
                    <div class="delete-img-btn" onclick="deleteUploadedImage('${url}')">Ã—</div>
                </div>`;
            });
            container.innerHTML = html;
        }

        async function deleteUploadedImage(url) {
            if(!confirm("ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;

            toggleLoader(true);
            try {
                // 1. Firestoreé…åˆ—ã‹ã‚‰å‰Šé™¤
                await db.collection('trip-schedule').doc('note-data').update({
                    images: firebase.firestore.FieldValue.arrayRemove(url)
                });

                // 2. Storageã‹ã‚‰å®Ÿãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                const fileRef = firebase.storage().refFromURL(url);
                await fileRef.delete();

                toggleLoader(false);
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");

            } catch (error) {
                console.error(error);
                alert("å‰Šé™¤å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆæ—¢ã«å‰Šé™¤ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰: " + error.message);
                toggleLoader(false);
            }
        }

        // ==========================================================
        // 6. ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½
        // ==========================================================
        function copyScheduleToClipboard() {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã‚’å–å¾—
            const withTime = document.getElementById('exp-time').checked;
            const withLoc  = document.getElementById('exp-loc').checked;
            const withMemo = document.getElementById('exp-memo').checked;
            const withUrl  = document.getElementById('exp-url').checked;

            let text = "ğŸŒº ãƒãƒ¯ã‚¤æ—…è¡Œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« ğŸŒº\n";
            
            for (let i = 0; i <= 8; i++) {
                const dayKey = `day${i}`;
                const dayData = scheduleData[dayKey];
                
                if (dayData && dayData.events && dayData.events.length > 0) {
                    text += `\nã€${dayData.title || 'Day ' + i}ã€‘\n`;
                    
                    const events = [...dayData.events].sort((a, b) => (a.time || '').localeCompare(b.time || ''));
                    
                    events.forEach(e => {
                        let line = "â–«ï¸ ";
                        if (withTime && e.time) line += `${e.time} `;
                        if (withLoc && e.location) line += `${e.location}`;

                        if (line !== "â–«ï¸ ") text += line + "\n";

                        if (withMemo && e.details) {
                            const cleanDetails = e.details.replace(/\n/g, "\n    ");
                            text += `    â”” ${cleanDetails}\n`;
                        }

                        if (withUrl) {
                            if(e.refUrl1) text += `    ğŸ”— ${e.refUrl1}\n`;
                            if(e.mapUrl_place) text += `    ğŸ—ºï¸ ${e.mapUrl_place}\n`;
                        }
                    });
                }
            }
            
            navigator.clipboard.writeText(text).then(() => {
                alert("é¸æŠã•ã‚ŒãŸé …ç›®ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼");
            }).catch(err => {
                console.error("ã‚³ãƒ”ãƒ¼å¤±æ•—:", err);
                alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            });
        }

        function downloadBackupJSON() {
            const backupData = {
                schedule: scheduleData,
                notes: noteData,
                exportedAt: new Date().toLocaleString()
            };
            
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(backupData, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "hawaii_trip_backup_" + Date.now() + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        // ==========================================================
        // 7. ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã¨ä¿å­˜ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ï¼‰
        // ==========================================================
        function showForm(dayNum, itemIndex) {
            const dayKey = `day${dayNum}`;
            const isNew = itemIndex === -1;
            let item = { 
                time: '', location: '', details: '', 
                refUrl1: '', refUrl2: '', refUrl3: '', 
                mapUrl_place: '', mapUrl_bus_board: '', mapUrl_bus_drop: '',
                imgUrl1: '', imgUrl2: '' 
            };
            
            if (!isNew && scheduleData[dayKey] && scheduleData[dayKey].events[itemIndex]) {
                item = scheduleData[dayKey].events[itemIndex];
            }

            const formHtml = `
                <div class="edit-form">
                    <h3>${isNew ? 'äºˆå®šè¿½åŠ ' : 'ç·¨é›†'}</h3>
                    <label>æ™‚é–“ (ä¾‹: 09:00, 14:00-16:00)</label>
                    <input type="text" id="edit-time" value="${item.time}" placeholder="ä¾‹: 10:00 - 12:00">
                    
                    <label>å ´æ‰€/ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" id="edit-location" value="${item.location}" placeholder="å ´æ‰€å">
                    
                    <label>è©³ç´°ãƒ¡ãƒ¢</label>
                    <textarea id="edit-details" rows="4">${item.details}</textarea>
                    
                    <div style="background:#e8f5e9; padding:10px; margin-top:10px; border-radius:5px;">
                        <label>ğŸ“ ç”»åƒæ·»ä»˜ (æœ€å¤§2ã¤)</label>
                        <div class="file-input-group">
                            <span>ãƒ•ã‚¡ã‚¤ãƒ«1: </span>
                            <input type="file" id="edit-file1" accept="image/*,application/pdf">
                            ${item.imgUrl1 ? `<br><small>â€»è¨­å®šæ¸ˆ: <a href="${item.imgUrl1}" target="_blank">ç¢ºèª</a></small>` : ''}
                        </div>
                        <div class="file-input-group">
                            <span>ãƒ•ã‚¡ã‚¤ãƒ«2: </span>
                            <input type="file" id="edit-file2" accept="image/*,application/pdf">
                            ${item.imgUrl2 ? `<br><small>â€»è¨­å®šæ¸ˆ: <a href="${item.imgUrl2}" target="_blank">ç¢ºèª</a></small>` : ''}
                        </div>
                    </div>

                    <label style="margin-top:15px;">ğŸ”— å‚è€ƒãƒ»åœ°å›³ãƒªãƒ³ã‚¯ (ä»»æ„)</label>
                    <input type="text" id="edit-refUrl1" value="${item.refUrl1}" placeholder="å‚è€ƒã‚µã‚¤ãƒˆURL 1">
                    <input type="text" id="edit-refUrl2" value="${item.refUrl2}" placeholder="å‚è€ƒã‚µã‚¤ãƒˆURL 2">
                    <input type="text" id="edit-refUrl3" value="${item.refUrl3}" placeholder="å‚è€ƒã‚µã‚¤ãƒˆURL 3">
                    
                    <div style="margin-top:5px; padding-top:5px; border-top:1px dashed #ccc;">
                        <input type="text" id="edit-mapUrl_place" value="${item.mapUrl_place}" placeholder="ğŸ—ºï¸ å ´æ‰€ã®åœ°å›³ URL">
                        <input type="text" id="edit-mapUrl_bus_board" value="${item.mapUrl_bus_board}" placeholder="ğŸš ä¹—è»Šãƒã‚¹åœ URL">
                        <input type="text" id="edit-mapUrl_bus_drop" value="${item.mapUrl_bus_drop}" placeholder="ğŸ é™è»Šãƒã‚¹åœ URL">
                    </div>

                    <div style="margin-top:20px; display:flex; gap:10px;">
                        <button onclick="saveEventWithImage(${dayNum}, ${itemIndex})" class="add-button" style="margin:0;">ğŸ’¾ ä¿å­˜</button>
                        <button onclick="hideForm(${dayNum})" style="background:#999; border:none; color:white; padding:10px; border-radius:8px; cursor:pointer;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    </div>
                    <input type="hidden" id="current-imgUrl1" value="${item.imgUrl1}">
                    <input type="hidden" id="current-imgUrl2" value="${item.imgUrl2}">
                </div>
            `;
            document.querySelectorAll('[id^="form-container-"]').forEach(c => c.innerHTML = '');
            document.getElementById(`form-container-${dayNum}`).innerHTML = formHtml;
        }

        function hideForm(dayNum) {
            document.getElementById(`form-container-${dayNum}`).innerHTML = '';
        }

        async function saveEventWithImage(dayNum, itemIndex) {
            const time = document.getElementById('edit-time').value.trim();
            const location = document.getElementById('edit-location').value.trim();
            if (!time || !location) return alert("æ™‚é–“ã¨å ´æ‰€ã¯å¿…é ˆã§ã™");

            toggleLoader(true);
            try {
                const file1 = document.getElementById('edit-file1').files[0];
                const file2 = document.getElementById('edit-file2').files[0];
                
                let imgUrl1 = document.getElementById('current-imgUrl1').value;
                let imgUrl2 = document.getElementById('current-imgUrl2').value;

                if (file1) {
                    const ref = storage.ref(`schedule_images/${Date.now()}_1_${file1.name}`);
                    await ref.put(file1);
                    imgUrl1 = await ref.getDownloadURL();
                }
                if (file2) {
                    const ref = storage.ref(`schedule_images/${Date.now()}_2_${file2.name}`);
                    await ref.put(file2);
                    imgUrl2 = await ref.getDownloadURL();
                }

                const newEvent = {
                    time, location,
                    details: document.getElementById('edit-details').value,
                    refUrl1: document.getElementById('edit-refUrl1').value.trim(),
                    refUrl2: document.getElementById('edit-refUrl2').value.trim(),
                    refUrl3: document.getElementById('edit-refUrl3').value.trim(),
                    mapUrl_place: document.getElementById('edit-mapUrl_place').value.trim(),
                    mapUrl_bus_board: document.getElementById('edit-mapUrl_bus_board').value.trim(),
                    mapUrl_bus_drop: document.getElementById('edit-mapUrl_bus_drop').value.trim(),
                    imgUrl1, imgUrl2
                };

                const dayKey = `day${dayNum}`;
                let events = (scheduleData[dayKey] && scheduleData[dayKey].events) ? [...scheduleData[dayKey].events] : [];
                
                if (itemIndex === -1) {
                    events.push(newEvent);
                } else {
                    events[itemIndex] = { ...events[itemIndex], ...newEvent };
                }
                await db.collection('trip-schedule').doc(dayKey).set({ events: events }, { merge: true });
                toggleLoader(false);
                hideForm(dayNum);

            } catch (error) {
                console.error(error);
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + error.message);
                toggleLoader(false);
            }
        }

        function deleteEvent(dayNum, itemIndex, title) {
            if(!confirm(`ã€Œ${title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
            const dayKey = `day${dayNum}`;
            const events = [...scheduleData[dayKey].events];
            events.splice(itemIndex, 1);
            db.collection('trip-schedule').doc(dayKey).update({ events: events });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const dayVal = parseInt(e.currentTarget.getAttribute('data-day'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    document.getElementById('day' + dayVal).classList.add('active');
                    currentDay = dayVal;
                    if(dayVal !== 99) renderSchedule(dayVal);
                });
            });
            startRealtimeListener();
        });
    </script>
</body>
</html>