<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>CrossTalk V19</title>
    <link rel="icon" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">

    <style>
        :root {
            --bg-color: #000000;
            --bg-partner: #111111;
            --text-color: #ffffff;
            --sub-text: #888888;
            --bubble-self: #2ed573;
            --bubble-partner: #ff4757;
            --bubble-ai: #00d2d3;
            --bubble-bg: #222222;
            --border-color: #333;
        }

        [data-theme="light"] {
            --bg-color: #f2f2f7;
            --bg-partner: #e5e5ea;
            --text-color: #000000;
            --sub-text: #666666;
            --bubble-self: #34c759;
            --bubble-partner: #ff3b30;
            --bubble-ai: #5ac8fa;
            --bubble-bg: #ffffff;
            --border-color: #d1d1d6;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            overflow: hidden; touch-action: manipulation;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container { 
            display: flex; flex-direction: column; 
            height: 100%; width: 100%;
            position: fixed; top: 0; left: 0; bottom: 0; right: 0;
        }

        .area {
            flex: 1; display: flex; flex-direction: column; 
            padding: 10px; position: relative; overflow: hidden; 
        }

        .partner-area {
            background-color: var(--bg-partner); 
            transform: rotate(180deg); 
            border-bottom: 1px solid var(--border-color);
            z-index: 10; 
        }

        .self-area { background-color: var(--bg-color); z-index: 10; }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .controls-bar {
            display: flex; gap: 6px; align-items: center;
            margin-bottom: 5px; z-index: 100; min-height: 44px; width: 100%;
            overflow-x: auto; white-space: nowrap;
            position: relative;
        }
        .controls-bar::-webkit-scrollbar { display: none; }

        button.icon-btn, .lang-trigger, input[type="text"] {
            padding: 8px 12px; font-size: 0.95rem; background-color: var(--bubble-bg);
            color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 16px; outline: none; appearance: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* è¨€èªé¸æŠãƒˆãƒªã‚¬ãƒ¼ãƒœã‚¿ãƒ³ */
        .lang-trigger { 
            cursor: pointer; min-width: 110px; text-align: center; 
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }

        /* è¨€èªé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
        .lang-modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 3000;
            justify-content: center; align-items: center;
            backdrop-filter: blur(3px);
        }
        .lang-modal-content {
            background: var(--bubble-bg); border: 1px solid var(--border-color);
            border-radius: 20px; width: 80%; max-height: 70%; overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }
        /* ç›¸æ‰‹å´ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯å›è»¢ã•ã›ã‚‹ */
        .lang-modal-overlay.partner-mode .lang-modal-content {
            transform: rotate(180deg);
        }
        
        .lang-option {
            padding: 15px; border-bottom: 1px solid var(--border-color);
            color: var(--text-color); font-size: 1.1rem; text-align: center;
            cursor: pointer;
        }
        .lang-option:active { background: var(--bubble-self); color: white; }
        .lang-option.selected { background: #333; font-weight: bold; color: var(--bubble-self); }

        /* Autoå†ç”Ÿãƒœã‚¿ãƒ³ */
        #autoplay-btn { 
            position: relative; width: 46px; height: 40px; 
            font-size: 1.3rem; padding: 0; display: flex; justify-content: center; align-items: center;
        }
        #autoplay-btn.active { background-color: #2ecc71; border-color: #2ecc71; color: white; }
        
        .x-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff4757; font-size: 1.8rem; font-weight: 900; pointer-events: none;
            text-shadow: 0 0 3px black; line-height: 1;
        }

        /* AIç›¸è«‡ãƒœã‚¿ãƒ³ */
        #consult-btn { font-size: 0.9rem; font-weight: bold; padding: 8px 12px;}
        #consult-btn.active { background-color: var(--bubble-ai); color: black; }

        /* ã‚·ãƒ¼ãƒ³é¸æŠ */
        #scenario-trigger { 
            margin-left: auto; font-weight: bold; background: #333; color: white;
        }

        /* å±¥æ­´ã‚¨ãƒªã‚¢ */
        .history-container {
            flex: 1; width: 100%; overflow-y: auto; 
            display: flex; flex-direction: column;
            padding-bottom: 170px; 
            -webkit-overflow-scrolling: touch;
        }
        .history-container::-webkit-scrollbar { display: none; }

        .message-row { display: flex; width: 100%; margin-bottom: 10px; align-items: flex-end; gap: 5px;}
        .row-self { justify-content: flex-end; }
        .row-partner { justify-content: flex-start; }

        .message-bubble {
            max-width: 85%; border-radius: 18px; padding: 12px 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; word-wrap: break-word;
        }

        .bubble-self { background-color: var(--bubble-bg); border-right: 5px solid var(--bubble-self); }
        .bubble-partner { background-color: var(--bubble-bg); border-left: 5px solid var(--bubble-partner); }
        .bubble-ai { background-color: var(--bubble-bg); border-left: 5px solid var(--bubble-ai); }

        .text-primary { font-size: 1.5rem; font-weight: bold; line-height: 1.2; display: block; }
        .text-secondary { font-size: 0.9rem; color: var(--sub-text); margin-bottom: 4px; line-height: 1.4; display: block; }
        .corrected-mark { color: var(--bubble-self); font-size: 0.75rem; font-weight: bold; margin-left: 4px; }

        .replay-btn {
            background: var(--bubble-bg); border: 1px solid var(--border-color);
            border-radius: 50%; width: 36px; height: 36px; flex-shrink: 0;
            font-size: 1.1rem; cursor: pointer; color: var(--text-color);
            display: flex; justify-content: center; align-items: center;
        }

        /* å›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .bottom-fixed-wrapper {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 160px; 
            display: flex; flex-direction: column; 
            justify-content: flex-end; align-items: center;
            padding-bottom: 15px;
            background: linear-gradient(to top, var(--bg-color) 50%, transparent 100%);
            z-index: 50; pointer-events: none;
        }
        .partner-area .bottom-fixed-wrapper {
            background: linear-gradient(to top, var(--bg-partner) 50%, transparent 100%);
        }

        /* ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ */
        .mic-controls {
            display: flex; align-items: center; justify-content: center; gap: 20px;
            width: 100%; pointer-events: auto; margin-bottom: 8px;
        }

        .mic-btn {
            width: 85px; height: 85px; border-radius: 50%; border: none;
            font-size: 36px; cursor: pointer; 
            display: flex; justify-content: center; align-items: center;
            position: relative; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            transition: transform 0.1s; background: white;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .mic-btn.active { transform: scale(0.95); filter: brightness(0.9); }
        #btn-partner { background: var(--bubble-partner); color: white; }
        #btn-self { background: var(--bubble-self); color: white; }
        #btn-self.consult-mode { background: var(--bubble-ai); }

        .remote-mic-btn {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--bubble-partner);
            background: #333; color: var(--bubble-partner); font-size: 20px;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: auto;
        }
        .remote-mic-btn:active { background: var(--bubble-partner); color: white; }

        .visualizer-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; border-radius: 50%;
            border: 4px solid currentColor; opacity: 0; pointer-events: none;
        }
        .mic-btn.active .visualizer-ring, .remote-mic-btn.active .visualizer-ring {
            animation: pulseRing 1.5s infinite; opacity: 1;
        }
        @keyframes pulseRing {
            0% { width: 100%; height: 100%; opacity: 0.8; border-width: 4px; }
            100% { width: 150%; height: 150%; opacity: 0; border-width: 0px; }
        }
        #btn-partner .visualizer-ring { color: rgba(255, 255, 255, 0.8); }
        #btn-self .visualizer-ring { color: rgba(255, 255, 255, 0.8); }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ–‡å­—ï¼ˆå·¨å¤§åŒ–ï¼‰ */
        .status-text {
            font-size: 1.3rem; font-weight: bold; color: var(--text-color);
            margin-bottom: 8px; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            background: rgba(0,0,0,0.3); padding: 2px 10px; border-radius: 10px;
        }

        /* ãƒãƒ£ãƒƒãƒˆå…¥åŠ› */
        .chat-input-area {
            display: flex; width: 94%; gap: 5px; pointer-events: auto; margin-bottom: 5px; position: relative;
        }
        .chat-input-wrapper {
            position: relative; flex: 1; display: flex; align-items: center;
        }
        .chat-input {
            width: 100%; background: rgba(255,255,255,0.1); color: var(--text-color);
            border: 1px solid var(--border-color); padding: 12px 35px 12px 15px; border-radius: 25px; font-size: 1rem;
        }
        .chat-clear-btn {
            position: absolute; right: 10px; color: #ccc; background: #555; border: none;
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 1rem; line-height: 1; cursor: pointer; padding: 0; display: none;
            align-items: center; justify-content: center;
        }
        .send-btn {
            background: var(--bubble-self); color: white; border: none;
            padding: 0 18px; border-radius: 25px; font-weight: bold; cursor: pointer; font-size: 1.2rem;
        }
        .partner-area .send-btn { background: var(--bubble-partner); }

        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒœã‚¿ãƒ³ï¼ˆä½ç½®èª¿æ•´ï¼‰ */
        .utility-btns {
            position: fixed; 
            bottom: 140px; /* ãƒãƒ£ãƒƒãƒˆã‚ˆã‚Šå°‘ã—ä¸Š */
            right: 15px;
            display: flex; flex-direction: column; gap: 12px; z-index: 200;
            opacity: 0.5; transition: opacity 0.3s;
        }
        .utility-btns:hover, .utility-btns:active { opacity: 1.0; }
        
        .fab {
            width: 44px; height: 44px; border-radius: 50%; background: #222; color: white;
            border: 1px solid #444; font-size: 1.3rem; cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;
        }
        .exit-fab { color: #ff4757; border-color: #ff4757; }

        /* ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ */
        #onboarding-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 1000;
            display: flex; flex-direction: column;
        }
        .onboard-part {
            flex: 1; display: flex; justify-content: center; align-items: center;
            color: white; font-size: 1.8rem; font-weight: bold; text-align: center; padding: 20px;
        }
        .onboard-partner { transform: rotate(180deg); border-bottom: 1px solid #555; }
        .onboard-arrow { font-size: 4rem; display: block; margin-bottom: 15px; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bubble-bg); color: var(--text-color); padding: 25px; border-radius: 20px; max-width: 90%; border: 1px solid var(--border-color); text-align: center; }
        .btn-primary { width: 100%; padding: 12px; background: var(--bubble-self); border: none; border-radius: 12px; color: white; font-weight: bold; margin-top: 15px; }
        .input-key { width: 90%; padding: 12px; margin-top: 10px; border-radius: 8px; border: 1px solid #555; background: #111; color: white; font-size: 1rem; }
        
        .help-item { display: flex; gap: 15px; margin-bottom: 15px; font-size: 1rem; align-items: center; text-align: left;}
        .help-icon { font-size: 1.8rem; width: 40px; text-align: center;}

        /* å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰é¸æŠ */
        #target-lang-wrapper { display: none; align-items: center; gap: 5px; margin-left: auto;}
        #target-lang-label { font-size: 0.8rem; color: #f1c40f; font-weight: bold; }
        #target-trigger { font-size: 0.8rem; padding: 6px 10px; min-width: 60px; }
    </style>
</head>
<body>

<div id="onboarding-overlay" onclick="this.style.display='none'; unlockAudio();">
    <div class="onboard-part onboard-partner">
        <div><span class="onboard-arrow">ğŸ‘‡</span><br><span id="guide-text-partner">Hold button to speak</span></div>
    </div>
    <div class="onboard-part onboard-self">
        <div><span class="onboard-arrow">ğŸ‘‡</span><br><span id="guide-text-self">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã™</span></div>
    </div>
</div>

<div id="key-modal" class="modal-overlay" style="display: flex;">
    <div class="modal-content">
        <h2>Setup</h2>
        <p>Gemini API Key</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="Paste Key here...">
        <button class="btn-primary" onclick="saveApiKey()">Start</button>
        <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #666;">Get API Key Here</a>
        </p>
    </div>
</div>

<div id="lang-modal" class="lang-modal-overlay" onclick="closeLangModal()">
    <div class="lang-modal-content" onclick="event.stopPropagation()" id="lang-modal-list">
        </div>
</div>

<div id="help-modal" class="modal-overlay" onclick="toggleHelp()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2>Help</h2>
        <div class="help-item">
            <span class="help-icon">ğŸ‘‚</span>
            <div><strong>Remote Mic</strong><br>ç›¸æ‰‹ãŒæ“ä½œã§ããªã„æ™‚ã€ä»£ã‚ã‚Šã«ã“ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ç›¸æ‰‹ã®è¨€è‘‰ã‚’èãå–ã‚Šã¾ã™ã€‚</div>
        </div>
        <div class="help-item">
            <span class="help-icon">ğŸ™‹â€â™‚ï¸</span>
            <div><strong>AI Consult</strong><br>ç¿»è¨³ã‚’ä¸­æ–­ã—ã¦ã€AIã«æ—¥æœ¬èªã§è³ªå•ã§ãã¾ã™ã€‚</div>
        </div>
        <div class="help-item">
            <span class="help-icon">ğŸŒ</span>
            <div><strong>Learning Mode</strong><br>ãŠäº’ã„ã«åŒã˜è¨€èªã‚’é¸ã¶ã¨ã€ç¿»è¨³å…ˆã®å¤–å›½èªã‚’é¸æŠã—ã¦å­¦ç¿’ã§ãã¾ã™ã€‚</div>
        </div>
        <button class="btn-primary" onclick="toggleHelp()">Close</button>
    </div>
</div>

<div class="utility-btns">
    <button class="fab" onclick="toggleHelp()" title="Help">â“</button>
    <button class="fab" onclick="toggleTheme()" title="Theme">ğŸŒ“</button>
    <button class="fab" onclick="downloadLog()" title="Save">ğŸ’¾</button>
    <button class="fab exit-fab" onclick="resetApp()" title="Exit">âœ–</button>
</div>

<div class="container">
    <div class="partner-area area">
        <div class="controls-bar">
            <div class="lang-trigger" id="partner-lang-trigger" onclick="openLangModal('partner')">English</div>
        </div>
        
        <div class="history-container" id="partner-history"></div>

        <div class="bottom-fixed-wrapper">
            <div class="status-text" id="partner-status">Hold to speak</div>
            <div class="mic-controls">
                <button id="btn-partner" class="mic-btn">
                    <div class="visualizer-ring"></div>ğŸ™ï¸
                </button>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-partner" class="chat-input" placeholder="Type..." oninput="toggleClearBtn('chat-partner')">
                    <button class="chat-clear-btn" id="clear-chat-partner" onclick="clearChat('chat-partner')">Ã—</button>
                </div>
                <button class="send-btn" onclick="sendChat('partner')">â¤</button>
            </div>
        </div>
    </div>

    <div class="self-area area">
        <div class="controls-bar">
            <div class="lang-trigger" id="self-lang-trigger" onclick="openLangModal('self')">Japanese</div>
            
            <button id="autoplay-btn" class="icon-btn" onclick="toggleAutoPlay()">
                <span id="autoplay-icon">ğŸ”Š</span>
                <span id="autoplay-x" class="x-overlay">Ã—</span>
            </button>

            <button id="consult-btn" class="icon-btn" onclick="toggleConsultMode()">
                ğŸ™‹â€â™‚ï¸ AIç›¸è«‡
            </button>

            <div id="target-lang-wrapper">
                <span id="target-lang-label">Target:</span>
                <div class="lang-trigger" id="target-trigger" onclick="openLangModal('target')">ENG</div>
            </div>

             <div class="lang-trigger" id="scenario-trigger" onclick="openLangModal('scenario')">Daily</div>
        </div>

        <div class="history-container" id="self-history"></div>

        <div class="bottom-fixed-wrapper">
            <div class="status-text" id="self-status">é•·æŠ¼ã—ã§è©±ã™</div>
            
            <div class="mic-controls">
                <button id="btn-self" class="mic-btn">
                    <div class="visualizer-ring"></div>ğŸ™ï¸
                </button>
                <button id="btn-remote-partner" class="remote-mic-btn" title="Listen for Partner">ğŸ‘‚</button>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input type="text" id="chat-self" class="chat-input" placeholder="å…¥åŠ›..." oninput="toggleClearBtn('chat-self')">
                    <button class="chat-clear-btn" id="clear-chat-self" onclick="clearChat('chat-self')">Ã—</button>
                </div>
                <button class="send-btn" onclick="sendChat('self')">â¤</button>
            </div>
        </div>
    </div>
</div>

<script>
    let API_KEY = ""; 
    const MODEL_ID = "gemini-2.5-flash"; 
    
    let isConsultMode = false; 
    let isAutoPlay = false; 
    let chatLog = [];
    
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†ç”¨å¤‰æ•°
    let state = {
        selfLang: 'ja-JP',
        partnerLang: 'en-US',
        targetLang: 'en-US',
        scenario: 'Daily'
    };

    const LANG_LIST = [
        { code: 'ja-JP', label: 'Japanese (æ—¥æœ¬èª)' },
        { code: 'en-US', label: 'English (è‹±èª)' },
        { code: 'zh-CN', label: 'Chinese (ä¸­å›½èª)' },
        { code: 'ko-KR', label: 'Korean (éŸ“å›½èª)' },
        { code: 'de-DE', label: 'German (ãƒ‰ã‚¤ãƒ„èª)' },
        { code: 'fr-FR', label: 'French (ãƒ•ãƒ©ãƒ³ã‚¹èª)' },
        { code: 'es-ES', label: 'Spanish (ã‚¹ãƒšã‚¤ãƒ³èª)' },
        { code: 'ar-SA', label: 'Arabic (ã‚¢ãƒ©ãƒ“ã‚¢èª)' },
        { code: 'vi-VN', label: 'Vietnamese (ãƒ™ãƒˆãƒŠãƒ èª)' },
        { code: 'it-IT', label: 'Italian (ã‚¤ã‚¿ãƒªã‚¢èª)' },
        { code: 'ru-RU', label: 'Russian (ãƒ­ã‚·ã‚¢èª)' },
        { code: 'pt-PT', label: 'Portuguese (ãƒãƒ«ãƒˆã‚¬ãƒ«èª)' },
        { code: 'th-TH', label: 'Thai (ã‚¿ã‚¤èª)' },
        { code: 'id-ID', label: 'Indonesian (ã‚¤ãƒ³ãƒ‰ãƒã‚·ã‚¢èª)' }
    ];

    const SCENARIO_LIST = [
        { code: 'Daily', label: 'Daily (æ—¥å¸¸)' },
        { code: 'Travel', label: 'Travel (æ—…è¡Œ)' },
        { code: 'Business', label: 'Business (ä»•äº‹)' },
        { code: 'Medical', label: 'Medical (ç—…é™¢)' },
        { code: 'Dining', label: 'Dining (é£Ÿäº‹)' }
    ];

    const UI_TEXT = {
        'ja-JP': 'é•·æŠ¼ã—ã§è©±ã™', 'en-US': 'Hold to speak', 'zh-CN': 'é•¿æŒ‰è¯´è¯', 'ko-KR': 'ê¸¸ê²Œ ëˆŒëŸ¬ ë§í•˜ê¸°',
        'de-DE': 'Zum Sprechen halten', 'fr-FR': 'Maintenir pour parler', 'es-ES': 'Mantener para hablar',
        'ar-SA': 'Ø§Ø¶ØºØ· Ù„Ù„ØªØ­Ø¯Ø«', 'vi-VN': 'Nháº¥n giá»¯ Ä‘á»ƒ nÃ³i', 'it-IT': 'Tenere premuto', 'ru-RU': 'Ğ£Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹Ñ‚Ğµ',
        'pt-PT': 'Segure para falar', 'th-TH': 'à¸à¸”à¸„à¹‰à¸²à¸‡à¹€à¸à¸·à¹ˆà¸­à¸à¸¹à¸”', 'id-ID': 'Tahan untuk bicara'
    };

    window.onload = function() {
        loadSettings();
        checkApiKey();
        setupScrollObserver('self-history');
        setupScrollObserver('partner-history');
        
        setupMicEvents('btn-self', 'self', 'self-status', 'ring-self', true);
        setupMicEvents('btn-partner', 'partner', 'partner-status', 'ring-partner', false);
        setupMicEvents('btn-remote-partner', 'partner', 'partner-status', 'ring-partner', false);

        updateUI();
        updateAutoPlayUI();
    };

    function unlockAudio() {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance(" "); u.volume = 0; window.speechSynthesis.speak(u);
        }
    }

    function toggleAutoPlay() {
        isAutoPlay = !isAutoPlay;
        updateAutoPlayUI();
        if(isAutoPlay) unlockAudio();
    }
    function updateAutoPlayUI() {
        const btn = document.getElementById('autoplay-btn');
        const xIcon = document.querySelector('.x-overlay');
        if (isAutoPlay) {
            btn.classList.add('active');
            xIcon.style.display = 'none';
        } else {
            btn.classList.remove('active');
            xIcon.style.display = 'block';
        }
    }

    function toggleClearBtn(id) {
        const val = document.getElementById(id).value;
        const btn = document.getElementById('clear-' + id);
        btn.style.display = val ? 'flex' : 'none';
    }
    function clearChat(id) {
        document.getElementById(id).value = '';
        document.getElementById('clear-' + id).style.display = 'none';
    }

    // è¨€èªé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«å‡¦ç†
    let currentModalType = ''; // self, partner, target, scenario

    function openLangModal(type) {
        currentModalType = type;
        const modal = document.getElementById('lang-modal');
        const list = document.getElementById('lang-modal-list');
        
        // ç›¸æ‰‹å´ã®å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸­èº«ã‚’å›è»¢ã•ã›ã‚‹
        if (type === 'partner') {
            modal.classList.add('partner-mode');
        } else {
            modal.classList.remove('partner-mode');
        }

        list.innerHTML = '';
        
        if (type === 'scenario') {
            SCENARIO_LIST.forEach(item => {
                const div = document.createElement('div');
                div.className = 'lang-option ' + (state.scenario === item.code ? 'selected' : '');
                div.innerText = item.label;
                div.onclick = () => selectScenario(item.code);
                list.appendChild(div);
            });
        } else {
            const currentVal = type === 'self' ? state.selfLang : (type === 'partner' ? state.partnerLang : state.targetLang);
            LANG_LIST.forEach(item => {
                const div = document.createElement('div');
                div.className = 'lang-option ' + (currentVal === item.code ? 'selected' : '');
                div.innerText = item.label;
                div.onclick = () => selectLang(type, item.code);
                list.appendChild(div);
            });
        }
        modal.style.display = 'flex';
    }

    function closeLangModal() {
        document.getElementById('lang-modal').style.display = 'none';
    }

    function selectLang(type, code) {
        if (type === 'self') state.selfLang = code;
        else if (type === 'partner') state.partnerLang = code;
        else if (type === 'target') state.targetLang = code;
        
        updateUI();
        closeLangModal();
    }

    function selectScenario(code) {
        state.scenario = code;
        updateUI();
        closeLangModal();
    }

    function updateUI() {
        saveSettings();
        
        // ãƒ©ãƒ™ãƒ«æ›´æ–° (çŸ­ç¸®å½¢)
        const getLabel = (code) => LANG_LIST.find(l => l.code === code).label.split(' ')[0];
        
        document.getElementById('self-lang-trigger').innerText = getLabel(state.selfLang);
        document.getElementById('partner-lang-trigger').innerText = getLabel(state.partnerLang);
        document.getElementById('target-trigger').innerText = getLabel(state.targetLang);
        document.getElementById('scenario-trigger').innerText = state.scenario;

        // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        document.getElementById('guide-text-self').innerText = UI_TEXT[state.selfLang] || "Hold to speak";
        document.getElementById('guide-text-partner').innerText = UI_TEXT[state.partnerLang] || "Hold to speak";

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
        if (!isConsultMode) {
            document.getElementById('self-status').innerText = UI_TEXT[state.selfLang] || "Hold to speak";
            document.getElementById('partner-status').innerText = UI_TEXT[state.partnerLang] || "Hold to speak";
        } else {
            document.getElementById('self-status').innerText = "AIã«ç›¸è«‡ï¼ˆæ—¥æœ¬èªï¼‰";
        }

        // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤ºåˆ‡æ›¿
        const targetWrapper = document.getElementById('target-lang-wrapper');
        if (state.selfLang === state.partnerLang) {
            targetWrapper.style.display = 'flex';
        } else {
            targetWrapper.style.display = 'none';
        }
    }

    function toggleConsultMode() {
        isConsultMode = !isConsultMode;
        const btn = document.getElementById('consult-btn');
        const micBtn = document.getElementById('btn-self');
        if (isConsultMode) {
            btn.classList.add('active');
            btn.innerText = "ğŸ‘¨â€ğŸ’» ç›¸è«‡ä¸­";
            micBtn.classList.add('consult-mode');
        } else {
            btn.classList.remove('active');
            btn.innerText = "ğŸ™‹â€â™‚ï¸ AIç›¸è«‡";
            micBtn.classList.remove('consult-mode');
        }
        updateUI();
    }

    function toggleHelp() {
        const modal = document.getElementById('help-modal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    async function sendChat(sender) {
        const inputId = sender === 'self' ? 'chat-self' : 'chat-partner';
        const inputEl = document.getElementById(inputId);
        const text = inputEl.value.trim();
        if(!text) return;
        inputEl.value = ""; 
        toggleClearBtn(inputId);
        
        const sCode = sender === 'self' ? state.selfLang : state.partnerLang;
        const tCode = sender === 'self' ? state.partnerLang : state.selfLang;
        
        await processTranslation(text, sCode, tCode, (sender === 'self'));
    }

    function addLogToUI(result, speakerType) {
        const isAI = (isConsultMode && speakerType === 'partner');
        const selfContainer = document.getElementById('self-history');
        selfContainer.appendChild(createBubble(result, speakerType, (speakerType === 'self'), false, isAI));
        scrollToBottom(selfContainer);

        if (!isConsultMode) {
            const partnerContainer = document.getElementById('partner-history');
            partnerContainer.appendChild(createBubble(result, speakerType, (speakerType === 'partner'), true, false));
            scrollToBottom(partnerContainer);
        }
        chatLog.push({t:new Date().toLocaleTimeString(), s:speakerType, o:result.original, tr:result.translation});
    }

    function createBubble(result, speakerType, isPrimaryOriginal, isForPartnerScreen, isAI) {
        const row = document.createElement('div');
        row.className = 'message-row ' + (
            !isForPartnerScreen ? 
                (speakerType === 'self' ? 'row-self' : 'row-partner') : 
                (speakerType === 'partner' ? 'row-self' : 'row-partner')
        );

        let bubbleClass = '';
        if (!isForPartnerScreen) {
            if (speakerType === 'self') bubbleClass = 'bubble-self';
            else bubbleClass = isAI ? 'bubble-ai' : 'bubble-partner';
        } else {
            if (speakerType === 'partner') bubbleClass = isAI ? 'bubble-ai' : 'bubble-partner';
            else bubbleClass = 'bubble-self';
        }

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${bubbleClass}`;

        const isCorrected = result.corrected_source && result.corrected_source.toLowerCase() !== result.original.toLowerCase().trim();
        const originalText = isCorrected 
            ? `<span style="text-decoration:line-through; opacity:0.6">${result.original}</span> <span class="corrected-mark">â¤ ${result.corrected_source}</span>`
            : result.original;
        
        const pClass = isPrimaryOriginal ? 'text-primary' : 'text-secondary';
        const sClass = isPrimaryOriginal ? 'text-secondary' : 'text-primary';

        bubble.innerHTML = `<div class="${pClass}">${originalText}</div><div class="${sClass}">${result.translation}</div>`;
        
        let showReplay = false;
        let textToSpeak = "";
        let langToSpeak = "";

        if (!isForPartnerScreen) {
            if (speakerType === 'self') {
                showReplay = true;
                textToSpeak = result.translation;
                // å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè¨€èª
                langToSpeak = (state.selfLang === state.partnerLang) ? state.targetLang : state.partnerLang;
            } else if (speakerType === 'partner' || isAI) {
                showReplay = true;
                textToSpeak = isAI ? result.translation : result.original; 
                langToSpeak = isAI ? 'ja-JP' : state.partnerLang;
            }
        }

        if (showReplay && textToSpeak) {
             const safeText = textToSpeak.replace(/'/g, "\\'").replace(/"/g, '\\"');
             const btn = document.createElement('button');
             btn.className = 'replay-btn';
             btn.innerHTML = 'ğŸ”Š';
             btn.onclick = function() { speakText(safeText, langToSpeak); };
             
             if ((!isForPartnerScreen && speakerType === 'self') || (isForPartnerScreen && speakerType !== 'partner')) {
                 row.appendChild(btn); row.appendChild(bubble);
             } else {
                 row.appendChild(bubble); row.appendChild(btn);
             }
        } else {
            row.appendChild(bubble);
        }
        return row;
    }

    function scrollToBottom(element) { element.scrollTop = element.scrollHeight; }
    function setupScrollObserver(id) {
        const target = document.getElementById(id);
        const observer = new MutationObserver(() => scrollToBottom(target));
        observer.observe(target, { childList: true });
    }
    function checkApiKey() {
        const storedKey = localStorage.getItem('crosstalk_api_key');
        if (storedKey) {
            API_KEY = storedKey;
            document.getElementById('key-modal').style.display = 'none';
        } else { document.getElementById('key-modal').style.display = 'flex'; }
    }
    function saveApiKey() {
        const input = document.getElementById('api-key-input').value.trim();
        if (input.length > 10) {
            localStorage.setItem('crosstalk_api_key', input);
            API_KEY = input;
            document.getElementById('key-modal').style.display = 'none';
        } else { alert("Valid API Key required"); }
    }
    function resetApp() { if(confirm("ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ã—ã¾ã™ã‹ï¼Ÿ")) { location.reload(); } }
    
    function saveSettings() {
        localStorage.setItem('crosstalk_settings', JSON.stringify(state));
    }
    function loadSettings() {
        const saved = localStorage.getItem('crosstalk_settings');
        if (saved) {
            try { state = JSON.parse(saved); } catch(e) {}
        }
    }
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
    }
    function downloadLog() {
        if (chatLog.length === 0) { alert("å±¥æ­´ãªã—"); return; }
        const text = chatLog.map(l => `[${l.t}] ${l.s}: ${l.o} -> ${l.tr}`).join("\n");
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `log.txt`;
        a.click();
    }

    async function processTranslation(text, sCode, tCode, isSelf) {
        if (sCode === tCode) {
            tCode = state.targetLang;
        }
        
        const statusId = isSelf ? 'self-status' : 'partner-status';
        document.getElementById(statusId).innerText = "Thinking...";

        const result = await translateWithGemini(text, sCode, tCode, state.scenario, isSelf);
        updateUI();

        if (result) {
            result.original = text;
            if (isConsultMode && isSelf) {
                addLogToUI(result, 'partner'); 
            } else {
                addLogToUI(result, isSelf ? 'self' : 'partner');
                if (isAutoPlay) speakText(result.translation, tCode);
            }
        }
    }

    async function translateWithGemini(text, sourceCode, targetCode, scenario, isSelf) {
        if (!text) return null;
        const getLabel = (code) => LANG_LIST.find(l => l.code === code).label;
        const sName = getLabel(sourceCode);
        const tName = getLabel(targetCode);

        let prompt = "";
        if (isConsultMode && isSelf) {
            prompt = `Role: Language Tutor. Question in ${sName}. Answer in ${sName}. Input:"${text}". JSON:{"corrected_source":"${text}","translation":"Answer","advice":null}`;
        } else {
            prompt = `Role: Interpreter. Context:${scenario}. ${sName}->${tName}. Correct errors. Input:"${text}". JSON:{"corrected_source":"corrected input","translation":"translated text","advice":null}`;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${API_KEY}`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
            const jsonText = rawText.match(/\{[\s\S]*\}/)?.[0] || "{}";
            return JSON.parse(jsonText);
        } catch (e) {
            return { translation: "Error", corrected_source: text, advice: null };
        }
    }

    function speakText(text, langCode) {
        if (!text) return;
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = langCode;
        window.speechSynthesis.speak(uttr);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function setupMicEvents(btnId, langType, statusId, ringId, isSelf) {
        const btn = document.getElementById(btnId);
        const statusEl = document.getElementById(statusId);
        
        if (!SpeechRecognition) return;

        const recognition = new SpeechRecognition();
        recognition.interimResults = true;
        recognition.continuous = true;
        
        recognition.onerror = (event) => {
            console.error("Mic Error", event.error);
            btn.classList.remove('active');
        };

        const startRec = (e) => {
            if(e.cancelable) e.preventDefault();
            if (!API_KEY) return;
            if (isConsultMode && !isSelf) return;

            // langTypeã‹ã‚‰ç¾åœ¨ã®è¨€èªã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
            let langCode = '';
            if (langType === 'self') langCode = state.selfLang;
            else if (langType === 'partner') langCode = state.partnerLang;

            recognition.lang = langCode;
            btn.classList.add('active');
            statusEl.innerText = "Listening...";
            try { recognition.start(); } catch(e) {}
        };

        const stopRec = (e) => {
            if(e.cancelable) e.preventDefault();
            btn.classList.remove('active');
            if (!isConsultMode) updateUI();
            try { recognition.stop(); } catch(e) {}
        };

        btn.addEventListener('mousedown', startRec);
        btn.addEventListener('mouseup', stopRec);
        btn.addEventListener('mouseleave', stopRec);
        btn.addEventListener('touchstart', startRec, {passive: false});
        btn.addEventListener('touchend', stopRec, {passive: false});

        recognition.onresult = async (event) => {
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    const text = event.results[i][0].transcript;
                    
                    const sCode = (langType === 'self') ? state.selfLang : state.partnerLang;
                    let tCode = "";
                    
                    if (btnId === 'btn-remote-partner') {
                        tCode = state.selfLang;
                    } else {
                        tCode = isSelf ? state.partnerLang : state.selfLang;
                    }
                    const logicalIsSelf = (btnId === 'btn-remote-partner') ? false : isSelf;
                    await processTranslation(text, sCode, tCode, logicalIsSelf);
                }
            }
        };
    }
</script>
</body>
</html>