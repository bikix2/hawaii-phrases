<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>CrossTalk V12</title>
    <link rel="icon" href="icon.jpg">
    <link rel="apple-touch-icon" href="icon.jpg">

    <style>
        :root {
            --bg-color: #000000;
            --bg-partner: #111111;
            --text-color: #ffffff;
            --sub-text: #888888;
            --bubble-self: #2ed573;
            --bubble-partner: #ff4757;
            --bubble-ai: #00d2d3;
            --bubble-bg: #222222;
            --border-color: #333;
        }

        [data-theme="light"] {
            --bg-color: #f2f2f7;
            --bg-partner: #e5e5ea;
            --text-color: #000000;
            --sub-text: #666666;
            --bubble-self: #34c759;
            --bubble-partner: #ff3b30;
            --bubble-ai: #5ac8fa;
            --bubble-bg: #ffffff;
            --border-color: #d1d1d6;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Hiragino Sans", sans-serif;
            overflow: hidden; touch-action: manipulation;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container { 
            display: flex; flex-direction: column; 
            height: 100%; width: 100%;
            position: fixed; top: 0; left: 0; bottom: 0; right: 0;
        }

        .area {
            flex: 1; display: flex; flex-direction: column; 
            padding: 10px; position: relative; overflow: hidden; 
        }

        .partner-area {
            background-color: var(--bg-partner); 
            transform: rotate(180deg); 
            border-bottom: 1px solid var(--border-color);
        }

        .self-area { background-color: var(--bg-color); }

        /* „Ç≥„É≥„Éà„É≠„Éº„É´„Éê„Éº */
        .controls-bar {
            display: flex; gap: 8px; align-items: center;
            margin-bottom: 8px; z-index: 20; min-height: 44px; width: 100%;
        }

        select, button.icon-btn, .custom-select-trigger {
            padding: 10px 12px; font-size: 0.95rem; background-color: var(--bubble-bg);
            color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 20px; outline: none; appearance: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* „Ç´„Çπ„Çø„É†„Éó„É´„ÉÄ„Ç¶„É≥ */
        .custom-select { position: relative; display: inline-block; }
        .custom-select-trigger { cursor: pointer; min-width: 120px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .custom-options {
            display: none; position: absolute; top: 100%; left: 0;
            background: var(--bubble-bg); border: 1px solid var(--border-color);
            border-radius: 10px; z-index: 200; width: 200px;
            max-height: 250px; overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .custom-option {
            padding: 12px; cursor: pointer; border-bottom: 1px solid #333;
            color: var(--text-color); font-size: 1rem; text-align: left;
        }
        .custom-option:hover { background: #444; }
        .custom-select.open .custom-options { display: block; }

        /* „Ç∑„Éº„É≥ÈÅ∏Êäû */
        #scenario-select {
            background: #333; color: white; border: 1px solid #555;
            font-weight: bold; margin-left: auto;
        }

        /* AIÁõ∏Ë´á„Éú„Çø„É≥ */
        #consult-btn.active {
            background-color: var(--bubble-ai); color: black; border-color: var(--bubble-ai); font-weight: bold;
        }

        /* Ëá™ÂãïË™≠„Åø‰∏ä„Åí„Éú„Çø„É≥ */
        #autoplay-btn {
            width: 80px; font-weight: bold; color: var(--sub-text); border-color: var(--sub-text);
        }
        #autoplay-btn.active {
            background-color: #f1c40f; color: black; border-color: #f1c40f;
        }

        /* Â±•Ê≠¥„Ç®„É™„Ç¢ */
        .history-container {
            flex: 1; width: 100%; overflow-y: auto; 
            display: flex; flex-direction: column;
            padding-bottom: 140px; 
            -ms-overflow-style: none; scrollbar-width: none;
            -webkit-overflow-scrolling: touch;
        }
        .history-container::-webkit-scrollbar { display: none; }

        .message-row { display: flex; width: 100%; margin-bottom: 12px; align-items: flex-end; gap: 8px;}
        .row-self { justify-content: flex-end; }
        .row-partner { justify-content: flex-start; }

        .message-bubble {
            max-width: 80%; border-radius: 18px; padding: 14px 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); position: relative; word-wrap: break-word;
        }

        .bubble-self { background-color: var(--bubble-bg); border-right: 5px solid var(--bubble-self); }
        .bubble-partner { background-color: var(--bubble-bg); border-left: 5px solid var(--bubble-partner); }
        .bubble-ai { background-color: var(--bubble-bg); border-left: 5px solid var(--bubble-ai); }

        .text-primary { font-size: 1.6rem; font-weight: bold; line-height: 1.2; display: block; }
        .text-secondary { font-size: 0.9rem; color: var(--sub-text); margin-bottom: 4px; line-height: 1.4; display: block; }
        .corrected-mark { color: var(--bubble-self); font-size: 0.8rem; font-weight: bold; margin-left: 4px; }

        /* ÂÜçÁîü„Éú„Çø„É≥ */
        .replay-btn {
            background: var(--bubble-bg); border: 1px solid var(--border-color);
            border-radius: 50%; width: 36px; height: 36px; flex-shrink: 0;
            font-size: 1.2rem; cursor: pointer; color: var(--text-color);
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .replay-btn:active { transform: scale(0.9); background: #444; }

        /* ‰∏ãÈÉ®Âõ∫ÂÆö„Ç®„É™„Ç¢ */
        .bottom-fixed-wrapper {
            position: absolute; bottom: 0; left: 0; right: 0;
            height: 130px; 
            display: flex; flex-direction: column; 
            justify-content: flex-end; align-items: center;
            padding-bottom: 20px;
            background: linear-gradient(to top, var(--bg-color) 20%, transparent 100%);
            z-index: 50; pointer-events: none;
        }
        .partner-area .bottom-fixed-wrapper {
            background: linear-gradient(to top, var(--bg-partner) 20%, transparent 100%);
        }

        .mic-btn {
            width: 90px; height: 90px; border-radius: 50%; border: none;
            font-size: 38px; cursor: pointer; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            position: relative; box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            transition: transform 0.1s, filter 0.1s; background: white;
            -webkit-tap-highlight-color: transparent; touch-action: manipulation;
        }
        .mic-btn.active { transform: scale(0.9); filter: brightness(0.8); }
        #btn-partner { background: var(--bubble-partner); color: white; }
        #btn-self { background: var(--bubble-self); color: white; }
        
        #btn-self.consult-mode { background: var(--bubble-ai); }

        .visualizer-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; border-radius: 50%;
            border: 5px solid currentColor; opacity: 0.5; pointer-events: none;
        }
        #btn-partner .visualizer-ring { color: rgba(255, 255, 255, 0.7); }
        #btn-self .visualizer-ring { color: rgba(255, 255, 255, 0.7); }

        .status-text {
            font-size: 1.1rem; font-weight: bold; color: var(--sub-text);
            margin-top: 10px; text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .live-monitor {
            position: absolute; bottom: 130px; left: 20px; right: 20px;
            text-align: center; font-size: 1.3rem; font-weight: 600;
            text-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 1.5em;
            pointer-events: none; z-index: 40; color: var(--bubble-self);
        }
        .partner-area .live-monitor { color: var(--bubble-partner); }

        /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£ */
        .utility-btns {
            position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); right: 20px;
            display: flex; flex-direction: column; gap: 15px; z-index: 100;
            opacity: 0.3; transition: opacity 0.3s;
        }
        .utility-btns:hover, .utility-btns:active { opacity: 1.0; }

        .fab {
            width: 48px; height: 48px; border-radius: 50%; background: #222; color: white;
            border: 1px solid #444; font-size: 1.4rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
        }
        .exit-fab { color: #ff4757; border-color: #ff4757; font-size: 1.2rem;}

        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bubble-bg); color: var(--text-color); padding: 25px;
            border-radius: 20px; max-width: 90%; width: 320px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center;
        }
        .btn-primary { 
            width: 100%; padding: 14px; background: var(--bubble-self); border: none; 
            border-radius: 12px; color: white; font-weight: bold; font-size: 1.1rem; cursor: pointer; margin-top: 15px;
        }
        .input-key {
            width: 90%; padding: 12px; margin-top: 10px; font-size: 1rem;
            border-radius: 8px; border: 1px solid #555; background: #111; color: white;
        }
    </style>
</head>
<body>

<div id="key-modal" class="modal-overlay" style="display: flex;">
    <div class="modal-content">
        <h2>Setup</h2>
        <p style="font-size: 0.9rem; color: #888;">Gemini API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="Paste API Key here...">
        <button class="btn-primary" onclick="saveApiKey()">Start App</button>
        <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #666;">Get API Key Here</a>
        </p>
    </div>
</div>

<div class="utility-btns">
    <button class="fab" onclick="toggleTheme()" title="„ÉÜ„Éº„ÉûÂàáÊõø">üåì</button>
    <button class="fab" onclick="downloadLog()" title="‰øùÂ≠ò">üíæ</button>
    <button class="fab exit-fab" onclick="resetApp()" title="Exit">‚úñ</button>
</div>

<div class="container">
    <div class="partner-area area">
        <div class="controls-bar">
            <div class="custom-select" id="partner-custom-select">
                <div class="custom-select-trigger" onclick="toggleCustomSelect()">English</div>
                <div class="custom-options">
                    <div class="custom-option" onclick="setPartnerLang('en-US', 'English')">English</div>
                    <div class="custom-option" onclick="setPartnerLang('zh-CN', 'Chinese')">Chinese</div>
                    <div class="custom-option" onclick="setPartnerLang('ko-KR', 'Korean')">Korean</div>
                    <div class="custom-option" onclick="setPartnerLang('ja-JP', 'Japanese')">Japanese</div>
                    <div class="custom-option" onclick="setPartnerLang('de-DE', 'German')">German</div>
                    <div class="custom-option" onclick="setPartnerLang('fr-FR', 'French')">French</div>
                    <div class="custom-option" onclick="setPartnerLang('es-ES', 'Spanish')">Spanish</div>
                    <div class="custom-option" onclick="setPartnerLang('ar-SA', 'Arabic')">Arabic</div>
                    <div class="custom-option" onclick="setPartnerLang('vi-VN', 'Vietnamese')">Vietnamese</div>
                </div>
            </div>
            <select id="partner-lang" style="display:none">
                <option value="en-US">English</option>
                <option value="zh-CN">Chinese</option>
                <option value="ko-KR">Korean</option>
                <option value="ja-JP">Japanese</option>
                <option value="de-DE">German</option>
                <option value="fr-FR">French</option>
                <option value="es-ES">Spanish</option>
                <option value="ar-SA">Arabic</option>
                <option value="vi-VN">Vietnamese</option>
            </select>
        </div>
        
        <div class="history-container" id="partner-history"></div>
        <div id="partner-live" class="live-monitor"></div>

        <div class="bottom-fixed-wrapper">
            <button id="btn-partner" class="mic-btn">
                <div class="visualizer-ring" id="ring-partner"></div>
                üéôÔ∏è
            </button>
            <div id="partner-status" class="status-text">Hold to speak</div>
        </div>
    </div>

    <div class="self-area area">
        <div class="controls-bar">
            
            <select id="self-lang" onchange="handleLangChange()">
                <option value="ja-JP" selected>Japanese</option>
                <option value="en-US">English</option>
                <option value="zh-CN">Chinese</option>
                <option value="ko-KR">Korean</option>
                <option value="de-DE">German</option>
                <option value="fr-FR">French</option>
                <option value="es-ES">Spanish</option>
                <option value="ar-SA">Arabic</option>
                <option value="vi-VN">Vietnamese</option>
            </select>
            
            <button id="autoplay-btn" class="icon-btn" onclick="toggleAutoPlay()">
                üîá Off
            </button>

            <button id="consult-btn" class="icon-btn" onclick="toggleConsultMode()">
                üôã‚Äç‚ôÇÔ∏è AIÁõ∏Ë´á
            </button>

             <select id="scenario-select" onchange="saveSettings()">
                <option value="general">Daily (Êó•Â∏∏)</option>
                <option value="travel">Travel (ÊóÖË°å)</option>
                <option value="business">Business (‰ªï‰∫ã)</option>
                <option value="medical">Medical (ÁóÖÈô¢)</option>
                <option value="restaurant">Dining (È£ü‰∫ã)</option>
            </select>
        </div>

        <div class="history-container" id="self-history"></div>
        <div id="self-live" class="live-monitor"></div>

        <div class="bottom-fixed-wrapper">
            <button id="btn-self" class="mic-btn">
                <div class="visualizer-ring" id="ring-self"></div>
                üéôÔ∏è
            </button>
            <div id="self-status" class="status-text">Èï∑Êäº„Åó„ÅßË©±„Åô</div>
        </div>
    </div>
</div>

<script>
    let API_KEY = ""; 
    const MODEL_ID = "gemini-2.5-flash"; 
    
    let isConsultMode = false; 
    let isAutoPlay = false; // „Éá„Éï„Ç©„É´„ÉàOFF
    let chatLog = [];
    
    const LANG_MAP = {
        'ja-JP': 'Japanese', 'en-US': 'English', 'zh-CN': 'Chinese', 'ko-KR': 'Korean',
        'de-DE': 'German', 'fr-FR': 'French', 'es-ES': 'Spanish', 'ar-SA': 'Arabic', 'vi-VN': 'Vietnamese'
    };

    const UI_TEXT = {
        'ja-JP': 'Èï∑Êäº„Åó„ÅßË©±„Åô', 'en-US': 'Hold to speak', 'zh-CN': 'ÈïøÊåâËØ¥ËØù', 'ko-KR': 'Í∏∏Í≤å ÎàåÎü¨ ÎßêÌïòÍ∏∞',
        'de-DE': 'Zum Sprechen halten', 'fr-FR': 'Maintenir pour parler', 'es-ES': 'Mantener para hablar',
        'ar-SA': 'ÿßÿ∂ÿ∫ÿ∑ ŸÑŸÑÿ™ÿ≠ÿØÿ´', 'vi-VN': 'Nh·∫•n gi·ªØ ƒë·ªÉ n√≥i'
    };

    window.onload = function() {
        loadSettings();
        checkApiKey();
        setupScrollObserver('self-history');
        setupScrollObserver('partner-history');
        setupMicEvents('btn-self', 'self-lang', 'self-live', 'ring-self', true);
        setupMicEvents('btn-partner', 'partner-lang', 'partner-live', 'ring-partner', false);
        handleLangChange(); 
        updatePartnerSelectUI();
        updateAutoPlayUI();
    };

    // Ëá™ÂãïË™≠„Åø‰∏ä„ÅíÂàáÊõø
    function toggleAutoPlay() {
        isAutoPlay = !isAutoPlay;
        updateAutoPlayUI();
    }
    function updateAutoPlayUI() {
        const btn = document.getElementById('autoplay-btn');
        if (isAutoPlay) {
            btn.classList.add('active');
            btn.innerText = "üîä Auto";
        } else {
            btn.classList.remove('active');
            btn.innerText = "üîá Off";
        }
    }

    // Èü≥Â£∞„Ç®„É≥„Ç∏„É≥„ÅÆ„Ç¶„Ç©„Éº„É†„Ç¢„ÉÉ„Éó (iOSÂØæÁ≠ñ)
    function unlockAudio() {
        if ('speechSynthesis' in window) {
            const u = new SpeechSynthesisUtterance("");
            u.volume = 0; // ÁÑ°Èü≥
            window.speechSynthesis.speak(u);
        }
    }

    function toggleCustomSelect() {
        document.getElementById('partner-custom-select').classList.toggle('open');
    }
    function setPartnerLang(val, text) {
        document.getElementById('partner-lang').value = val;
        document.querySelector('.custom-select-trigger').innerText = text;
        document.getElementById('partner-custom-select').classList.remove('open');
        handleLangChange();
    }
    function updatePartnerSelectUI() {
        const select = document.getElementById('partner-lang');
        const text = select.options[select.selectedIndex].text;
        document.querySelector('.custom-select-trigger').innerText = text.split(' ')[0];
    }
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.custom-select')) {
            document.getElementById('partner-custom-select').classList.remove('open');
        }
    });

    function toggleConsultMode() {
        isConsultMode = !isConsultMode;
        const btn = document.getElementById('consult-btn');
        const selfStatus = document.getElementById('self-status');
        const micBtn = document.getElementById('btn-self');

        if (isConsultMode) {
            btn.classList.add('active');
            btn.innerText = "üë®‚Äçüíª Áõ∏Ë´á‰∏≠";
            selfStatus.innerText = "AI„Å´Áõ∏Ë´áÔºàÊó•Êú¨Ë™ûÔºâ";
            micBtn.classList.add('consult-mode');
        } else {
            btn.classList.remove('active');
            btn.innerText = "üôã‚Äç‚ôÇÔ∏è AIÁõ∏Ë´á";
            micBtn.classList.remove('consult-mode');
            handleLangChange(); 
        }
    }

    function handleLangChange() {
        saveSettings();
        const selfLang = document.getElementById('self-lang').value;
        const partnerLang = document.getElementById('partner-lang').value;
        
        if (!isConsultMode) {
            document.getElementById('self-status').innerText = UI_TEXT[selfLang] || "Hold to speak";
            document.getElementById('partner-status').innerText = UI_TEXT[partnerLang] || "Hold to speak";
        }
    }

    function addLogToUI(result, speakerType) {
        const isAI = (isConsultMode && speakerType === 'partner');
        
        const selfContainer = document.getElementById('self-history');
        const selfBubble = createBubble(result, speakerType, (speakerType === 'self'), false, isAI);
        selfContainer.appendChild(selfBubble);
        scrollToBottom(selfContainer);

        if (!isConsultMode) {
            const partnerContainer = document.getElementById('partner-history');
            const partnerBubble = createBubble(result, speakerType, (speakerType === 'partner'), true, false);
            partnerContainer.appendChild(partnerBubble);
            scrollToBottom(partnerContainer);
        }

        chatLog.push({
            time: new Date().toLocaleTimeString(),
            speaker: speakerType,
            original: result.corrected_source || result.original,
            translated: result.translation
        });
    }

    function createBubble(result, speakerType, isPrimaryOriginal, isForPartnerScreen, isAI) {
        const row = document.createElement('div');
        row.className = 'message-row';

        let bubbleClass = '';
        let rowClass = '';

        if (!isForPartnerScreen) { 
            if (speakerType === 'self') {
                rowClass = 'row-self'; bubbleClass = 'bubble-self';
            } else {
                rowClass = 'row-partner'; 
                bubbleClass = isAI ? 'bubble-ai' : 'bubble-partner';
            }
        } else { 
            if (speakerType === 'partner') {
                rowClass = 'row-self'; bubbleClass = 'bubble-partner'; 
            } else {
                rowClass = 'row-partner'; bubbleClass = 'bubble-self'; 
            }
        }

        row.classList.add(rowClass);
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${bubbleClass}`;

        const isCorrected = result.corrected_source && result.corrected_source.toLowerCase() !== result.original.toLowerCase().trim();
        const originalText = isCorrected 
            ? `<span style="text-decoration:line-through; opacity:0.6">${result.original}</span> <span class="corrected-mark">‚û§ ${result.corrected_source}</span>`
            : result.original;
        
        const translatedText = result.translation;
        const originalClass = isPrimaryOriginal ? 'text-primary' : 'text-secondary';
        const translatedClass = isPrimaryOriginal ? 'text-secondary' : 'text-primary';

        let html = `
            <div class="${originalClass}">${originalText}</div>
            <div class="${translatedClass}">${translatedText}</div>
        `;
        
        bubble.innerHTML = html;
        
        // ÂÜçÁîü„Éú„Çø„É≥ÈÖçÁΩÆ
        let showReplay = false;
        let textToSpeak = "";
        let langToSpeak = "";

        if (!isForPartnerScreen) {
            if (speakerType === 'self') {
                showReplay = true;
                textToSpeak = result.translation;
                langToSpeak = document.getElementById('partner-lang').value;
            } else if (speakerType === 'partner' || isAI) {
                showReplay = true;
                textToSpeak = isAI ? result.translation : result.original; 
                langToSpeak = isAI ? 'ja-JP' : document.getElementById('partner-lang').value;
            }
        }

        if (showReplay && textToSpeak) {
             const safeText = textToSpeak.replace(/'/g, "\\'").replace(/"/g, '\\"');
             const btn = document.createElement('button');
             btn.className = 'replay-btn';
             btn.innerHTML = 'üîä';
             btn.onclick = function() { speakText(safeText, langToSpeak); };
             
             if (speakerType === 'self' && !isForPartnerScreen) {
                 row.appendChild(btn);
                 row.appendChild(bubble);
             } else {
                 row.appendChild(bubble);
                 row.appendChild(btn);
             }
        } else {
            row.appendChild(bubble);
        }

        return row;
    }

    function scrollToBottom(element) { element.scrollTop = element.scrollHeight; }
    function setupScrollObserver(id) {
        const target = document.getElementById(id);
        const observer = new MutationObserver(() => scrollToBottom(target));
        observer.observe(target, { childList: true });
    }
    function checkApiKey() {
        const storedKey = localStorage.getItem('crosstalk_api_key');
        if (storedKey) {
            API_KEY = storedKey;
            document.getElementById('key-modal').style.display = 'none';
        } else { document.getElementById('key-modal').style.display = 'flex'; }
    }
    function saveApiKey() {
        const input = document.getElementById('api-key-input').value.trim();
        if (input.length > 10) {
            localStorage.setItem('crosstalk_api_key', input);
            API_KEY = input;
            document.getElementById('key-modal').style.display = 'none';
        } else { alert("Valid API Key required"); }
    }
    function resetApp() { if(confirm("„Ç¢„Éó„É™„ÇíÁµÇ‰∫ÜÔºà„É™„Çª„ÉÉ„ÉàÔºâ„Åó„Åæ„Åô„ÅãÔºü")) { location.reload(); } }
    function saveSettings() {
        const settings = {
            partnerLang: document.getElementById('partner-lang').value,
            selfLang: document.getElementById('self-lang').value,
            scenario: document.getElementById('scenario-select').value,
            theme: document.documentElement.getAttribute('data-theme')
        };
        localStorage.setItem('crosstalk_settings', JSON.stringify(settings));
    }
    function loadSettings() {
        const saved = localStorage.getItem('crosstalk_settings');
        if (saved) {
            try {
                const s = JSON.parse(saved);
                if(s.partnerLang) {
                    document.getElementById('partner-lang').value = s.partnerLang;
                    updatePartnerSelectUI();
                }
                if(s.selfLang) document.getElementById('self-lang').value = s.selfLang;
                if(s.scenario) document.getElementById('scenario-select').value = s.scenario;
                if(s.theme) document.documentElement.setAttribute('data-theme', s.theme);
            } catch(e) {}
        }
    }
    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
        saveSettings();
    }
    function downloadLog() {
        if (chatLog.length === 0) { alert("Â±•Ê≠¥„Å™„Åó"); return; }
        const text = chatLog.map(l => `[${l.time}] ${l.speaker}: ${l.original} -> ${l.translated}`).join("\n");
        const blob = new Blob([text], { type: 'text/plain' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `log_${new Date().toISOString().slice(0,10)}.txt`;
        a.click();
    }

    let audioContext, analyser, dataArray, microphone, animationId;
    let isAudioInit = false;
    async function initAudio() {
        if (isAudioInit) return;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 128;
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            isAudioInit = true;
        } catch (e) { console.error("Audio Init Failed", e); }
    }
    function updateVisualizer(ringId) {
        if (!isAudioInit) return;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
        let vol = sum / dataArray.length;
        let scale = 1 + (vol / 40); 
        const ring = document.getElementById(ringId);
        if (ring) {
            ring.style.width = `${100 * scale}%`;
            ring.style.height = `${100 * scale}%`;
            ring.style.opacity = `${0.4 + (vol / 200)}`;
        }
        animationId = requestAnimationFrame(() => updateVisualizer(ringId));
    }

    async function translateWithGemini(text, sourceCode, targetCode, scenario, isSelf) {
        if (!text) return null;
        const sName = LANG_MAP[sourceCode] || sourceCode;
        const tName = LANG_MAP[targetCode] || targetCode;

        let prompt = "";
        
        if (isConsultMode && isSelf) {
            prompt = `
            You are a helpful language tutor. 
            The user is asking a question in ${sName} (likely Japanese).
            Answer the question in ${sName}.
            Input: "${text}"
            Output JSON: { "corrected_source": "${text}", "translation": "Your Answer Here", "advice": null }
            `;
        } else {
            prompt = `
            Role: Professional Interpreter. Context: ${scenario}.
            Source: ${sName}, Target: ${tName}.
            Task: Correct errors & Translate naturally.
            Input: "${text}"
            Output JSON: { "corrected_source": "string", "translation": "string", "advice": null }
            `;
        }

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${API_KEY}`;
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
            const jsonText = rawText.match(/\{[\s\S]*\}/)?.[0] || "{}";
            return JSON.parse(jsonText);
        } catch (e) {
            return { translation: "Error", corrected_source: text, advice: null };
        }
    }

    function speakText(text, langCode) {
        if (!text) return;
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = langCode;
        window.speechSynthesis.speak(uttr);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function setupMicEvents(btnId, langSelectId, liveId, ringId, isSelf) {
        const btn = document.getElementById(btnId);
        const langSelect = document.getElementById(langSelectId);
        const targetLangSelect = isSelf ? document.getElementById('partner-lang') : document.getElementById('self-lang');
        const liveEl = document.getElementById(liveId);
        const statusEl = document.getElementById(isSelf ? 'self-status' : 'partner-status');
        
        const recognition = new SpeechRecognition();
        recognition.interimResults = true;
        recognition.continuous = true;

        let finalTranscript = '';

        const startRec = async (e) => {
            if(e.cancelable) e.preventDefault();
            if (!API_KEY) return;
            
            // ÈáçË¶Å: „Éû„Ç§„ÇØ„ÇíÊäº„Åó„ÅüÁû¨Èñì„Å´ÁÑ°Èü≥ÂÜçÁîü„Åó„Å¶„Ç™„Éº„Éá„Ç£„Ç™„Ç®„É≥„Ç∏„É≥„ÇíËµ∑„Åì„Åô
            unlockAudio();

            if (isConsultMode && !isSelf) return;

            if (!audioContext) await initAudio();
            if (audioContext.state === 'suspended') await audioContext.resume();

            recognition.lang = langSelect.value;
            btn.classList.add('active');
            
            let statusMsg = "Listening...";
            if(isSelf) statusMsg = UI_TEXT[langSelect.value].replace("Hold to speak", "Listening").replace("Èï∑Êäº„Åó„ÅßË©±„Åô", "ËÅû„ÅÑ„Å¶„ÅÑ„Åæ„Åô");
            
            statusEl.innerText = statusMsg;
            statusEl.style.color = isSelf ? (isConsultMode ? "var(--bubble-ai)" : "var(--bubble-self)") : "var(--bubble-partner)";
            
            liveEl.innerText = "";
            updateVisualizer(ringId);
            try { recognition.start(); } catch(e) {}
            finalTranscript = '';
        };

        const stopRec = (e) => {
            if(e.cancelable) e.preventDefault();
            btn.classList.remove('active');
            
            if (isConsultMode && !isSelf) return;

            if (!isConsultMode || !isSelf) {
                const currentLang = langSelect.value;
                statusEl.innerText = UI_TEXT[currentLang] || "Hold to speak";
                statusEl.style.color = "var(--sub-text)";
            } else {
                 statusEl.innerText = "AI„Å´Áõ∏Ë´áÔºàÊó•Êú¨Ë™ûÔºâ";
            }
            
            liveEl.innerText = "";
            if(animationId) cancelAnimationFrame(animationId);
            const ring = document.getElementById(ringId);
            if(ring) { ring.style.width = '100%'; ring.style.height = '100%'; ring.style.opacity = '0'; }
            try { recognition.stop(); } catch(e) {}
        };

        btn.addEventListener('mousedown', startRec);
        btn.addEventListener('mouseup', stopRec);
        btn.addEventListener('mouseleave', stopRec);
        btn.addEventListener('touchstart', startRec, {passive: false});
        btn.addEventListener('touchend', stopRec, {passive: false});

        recognition.onresult = async (event) => {
            let interim = '';
            let newFinal = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) newFinal += event.results[i][0].transcript;
                else interim += event.results[i][0].transcript;
            }
            if (interim || newFinal) liveEl.innerText = finalTranscript + newFinal + interim;

            if (newFinal) {
                finalTranscript += newFinal;
                liveEl.innerText = "";
                statusEl.innerText = "Thinking...";
                
                const sCode = langSelect.value;
                const tCode = targetLangSelect.value;
                const scenario = document.getElementById('scenario-select').value;

                const result = await translateWithGemini(newFinal, sCode, tCode, scenario, isSelf);
                
                if(!isConsultMode) {
                     statusEl.innerText = UI_TEXT[langSelect.value] || "Hold to speak";
                } else {
                     statusEl.innerText = "AI„Å´Áõ∏Ë´áÔºàÊó•Êú¨Ë™ûÔºâ";
                }

                if (result) {
                    result.original = newFinal;
                    if (isConsultMode && isSelf) {
                        addLogToUI(result, 'partner'); 
                    } else {
                        addLogToUI(result, isSelf ? 'self' : 'partner');
                        // Ëá™ÂãïË™≠„Åø‰∏ä„ÅíON„Å™„ÇâÂÜçÁîü
                        if (isAutoPlay) {
                            speakText(result.translation, tCode);
                        }
                    }
                }
            }
        };
    }

</script>
</body>
</html>