<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>CrossTalk AI V4 (Safe)</title>
    <link rel="manifest" href="manifest.json">

    <style>
        :root {
            --bg-color: #000000;
            --bg-partner: #111111;
            --text-color: #ffffff;
            --sub-text: #888888;
            --bubble-bg: #222222;
            --accent-partner: #ff4757;
            --accent-self: #2ed573;
            --advice-color: #f1c40f;
            --border-color: #333;
        }

        [data-theme="light"] {
            --bg-color: #f5f5f7;
            --bg-partner: #e5e5e7;
            --text-color: #1d1d1f;
            --sub-text: #86868b;
            --bubble-bg: #ffffff;
            --border-color: #d2d2d7;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color); color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden; touch-action: manipulation;
        }

        .container { display: flex; flex-direction: column; height: 100vh; }

        .area {
            flex: 1; display: flex; flex-direction: column; padding: 10px;
            position: relative; overflow: hidden; transition: background-color 0.3s;
        }

        .partner-area {
            background-color: var(--bg-partner); transform: rotate(180deg);
            border-bottom: 2px solid var(--border-color);
        }
        .self-area { background-color: var(--bg-color); }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒãƒ¼ */
        .controls-bar {
            display: flex; gap: 8px; justify-content: center; align-items: center;
            margin-bottom: 5px; z-index: 20; flex-wrap: wrap;
        }

        select, button.icon-btn {
            padding: 6px 12px; font-size: 0.85rem; background-color: var(--bubble-bg);
            color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 18px; outline: none; appearance: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* å±¥æ­´ã‚¨ãƒªã‚¢ */
        .history-container {
            flex: 1; width: 100%; overflow-y: auto; display: flex;
            flex-direction: column-reverse; padding-bottom: 120px;
            mask-image: linear-gradient(to top, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to top, black 85%, transparent 100%);
        }

        .message-bubble {
            background-color: var(--bubble-bg); border-radius: 16px;
            padding: 12px 16px; margin: 6px 10px;
            animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 4px solid #555;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            word-wrap: break-word;
        }
        
        .partner-area .message-bubble { border-left-color: var(--accent-partner); }
        .self-area .message-bubble { border-left-color: var(--accent-self); }

        .original-text { font-size: 0.85rem; color: var(--sub-text); margin-bottom: 4px; line-height: 1.4; }
        .translated-text { font-size: 1.35rem; font-weight: 700; line-height: 1.3; letter-spacing: 0.02em; }
        .corrected-mark { color: var(--accent-self); font-size: 0.8rem; font-weight: bold; margin-left: 4px; }

        .advice-box {
            margin-top: 10px; padding-top: 8px; border-top: 1px dashed var(--border-color);
            font-size: 0.9rem; color: var(--advice-color); display: flex; align-items: start; gap: 6px;
        }

        @keyframes popIn { from { opacity: 0; transform: scale(0.9) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å­—å¹• */
        .live-monitor {
            position: absolute; bottom: 100px; left: 20px; right: 20px;
            text-align: center; font-size: 1.2rem; font-weight: 600;
            text-shadow: 0 0 10px rgba(0,0,0,0.5); min-height: 1.5em;
            pointer-events: none; z-index: 15; color: var(--accent-self);
        }
        .partner-area .live-monitor { color: var(--accent-partner); }

        /* ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ */
        .mic-wrapper {
            position: absolute; bottom: 20px; left: 0; right: 0;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; z-index: 30;
        }

        .mic-btn {
            width: 80px; height: 80px; border-radius: 50%; border: none;
            font-size: 32px; cursor: pointer; pointer-events: auto;
            display: flex; justify-content: center; align-items: center;
            position: relative; box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: transform 0.1s; background: white;
            -webkit-tap-highlight-color: transparent;
        }
        
        #btn-partner { background: linear-gradient(135deg, #ff6b81, #ff4757); color: white; }
        #btn-self { background: linear-gradient(135deg, #7bed9f, #2ed573); color: white; }
        .mic-btn:active { transform: scale(0.92); }

        /* ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ */
        .visualizer-ring {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 100%; height: 100%; border-radius: 50%;
            border: 4px solid currentColor; opacity: 0.4; pointer-events: none;
        }
        #btn-partner .visualizer-ring { color: rgba(255, 71, 87, 0.6); }
        #btn-self .visualizer-ring { color: rgba(46, 213, 115, 0.6); }

        .status-text {
            position: absolute; bottom: 5px; width: 100%; text-align: center;
            font-size: 0.7rem; color: var(--sub-text);
        }

        /* ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ & ã‚·ãƒãƒ¥ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
        .utility-btns {
            position: fixed; bottom: 20px; right: 20px;
            display: flex; flex-direction: column; gap: 10px; z-index: 100;
        }
        .fab {
            width: 44px; height: 44px; border-radius: 50%; background: #333; color: white;
            border: 1px solid #555; font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center;
        }
        
        #context-overlay {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 5px 15px; border-radius: 20px;
            z-index: 100; backdrop-filter: blur(5px); display: flex; gap: 10px;
            border: 1px solid #444; white-space: nowrap;
        }
        .context-badge { font-size: 0.8rem; color: #ccc; display: flex; align-items: center; gap: 5px;}

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bubble-bg); color: var(--text-color); padding: 25px;
            border-radius: 20px; max-width: 90%; width: 320px; border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
        }
        .modal-content h2 { margin-top: 0; font-size: 1.2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .help-item { display: flex; gap: 10px; margin-bottom: 12px; font-size: 0.9rem; align-items: center; text-align: left;}
        .help-icon { font-size: 1.5rem; width: 30px; text-align: center;}
        
        .btn-primary { 
            width: 100%; padding: 12px; background: var(--accent-self); border: none; 
            border-radius: 10px; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 15px;
        }
        .input-key {
            width: 90%; padding: 10px; margin-top: 10px; font-size: 1rem;
            border-radius: 8px; border: 1px solid #555; background: #111; color: white;
        }
    </style>
</head>
<body>

<div id="key-modal" class="modal-overlay" style="display: flex;">
    <div class="modal-content">
        <h2>Initial Setup</h2>
        <p style="font-size: 0.9rem; color: #ccc; text-align: left;">
            Google Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>
            â€»ã‚­ãƒ¼ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«ã®ã¿ä¿å­˜ã•ã‚Œã¾ã™ã€‚
        </p>
        <input type="password" id="api-key-input" class="input-key" placeholder="Paste API Key here...">
        <button class="btn-primary" onclick="saveApiKey()">Start App</button>
        <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: #666;">Get API Key Here</a>
        </p>
    </div>
</div>

<div id="help-modal" class="modal-overlay" onclick="toggleHelp()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2>æ©Ÿèƒ½èª¬æ˜</h2>
        <div class="help-item">
            <span class="help-icon">ğŸ”‘</span>
            <div><strong>API Key</strong><br>å³ä¸‹ã®è¨­å®šãƒœã‚¿ãƒ³ã‹ã‚‰ã‚­ãƒ¼ã®å¤‰æ›´ãƒ»å‰Šé™¤ãŒã§ãã¾ã™ã€‚</div>
        </div>
        <div class="help-item">
            <span class="help-icon">ğŸ“</span>
            <div><strong>Scene (å ´é¢)</strong><br>ã€Œæ—…è¡Œã€ãªã©ã‚’é¸ã¶ã¨ã€AIãŒç©ºæ°—ã‚’èª­ã‚“ã§ç¿»è¨³ã—ã¾ã™ã€‚</div>
        </div>
        <div class="help-item">
            <span class="help-icon">ğŸ‘¨â€ğŸ«</span>
            <div><strong>Coach (å­¦ç¿’)</strong><br>ONã«ã™ã‚‹ã¨ã€ã‚ˆã‚Šè‡ªç„¶ãªè¨€ã„å›ã—ã‚’ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¾ã™ã€‚</div>
        </div>
        <button class="btn-primary" onclick="toggleHelp()">Close</button>
    </div>
</div>

<div id="reset-modal" class="modal-overlay">
    <div class="modal-content">
        <h2>Reset Settings</h2>
        <p>APIã‚­ãƒ¼ã¨è¨­å®šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
        <button class="btn-primary" style="background:#ff4757" onclick="resetAll()">Reset & Reload</button>
        <button class="btn-primary" style="background:#555; margin-top:10px" onclick="document.getElementById('reset-modal').style.display='none'">Cancel</button>
    </div>
</div>

<div id="context-overlay">
    <span class="context-badge">ğŸ“ Scene:</span>
    <select id="scenario-select" onchange="saveSettings()" style="background:transparent; border:none; color:white; padding:0;">
        <option value="general">Daily (æ—¥å¸¸)</option>
        <option value="travel">Travel (æ—…è¡Œ)</option>
        <option value="business">Business (ä»•äº‹)</option>
        <option value="medical">Medical (ç—…é™¢)</option>
        <option value="restaurant">Dining (é£Ÿäº‹)</option>
    </select>
</div>

<div class="utility-btns">
    <button class="fab" onclick="toggleHelp()" title="ãƒ˜ãƒ«ãƒ—">â“</button>
    <button class="fab" onclick="document.getElementById('reset-modal').style.display='flex'" title="è¨­å®šãƒªã‚»ãƒƒãƒˆ">âš™ï¸</button>
    <button class="fab" onclick="toggleTheme()" title="ãƒ†ãƒ¼ãƒåˆ‡æ›¿">ğŸŒ“</button>
    <button class="fab" onclick="downloadLog()" title="ãƒ­ã‚°ä¿å­˜">ğŸ’¾</button>
</div>

<div class="container">
    <div class="partner-area area">
        <div class="controls-bar">
            <select id="partner-lang" onchange="saveSettings()">
                <option value="en-US">English (è‹±èª)</option>
                <option value="zh-CN">Chinese (ä¸­å›½èª)</option>
                <option value="ko-KR">Korean (éŸ“å›½èª)</option>
                <option value="ja-JP">Japanese (æ—¥æœ¬èª)</option>
                <option value="de-DE">German (ãƒ‰ã‚¤ãƒ„èª)</option>
                <option value="fr-FR">French (ãƒ•ãƒ©ãƒ³ã‚¹èª)</option>
                <option value="es-ES">Spanish (ã‚¹ãƒšã‚¤ãƒ³èª)</option>
                <option value="ar-SA">Arabic (ã‚¢ãƒ©ãƒ“ã‚¢èª)</option>
            </select>
        </div>
        
        <div class="history-container" id="partner-history"></div>
        <div id="partner-live" class="live-monitor"></div>

        <div class="mic-wrapper">
            <button id="btn-partner" class="mic-btn">
                <div class="visualizer-ring" id="ring-partner"></div>
                ğŸ™ï¸
            </button>
        </div>
        <div id="partner-status" class="status-text">Hold to speak</div>
    </div>

    <div class="self-area area">
        <div class="controls-bar">
            <select id="self-lang" onchange="saveSettings()">
                <option value="ja-JP" selected>Japanese (æ—¥æœ¬èª)</option>
                <option value="en-US">English (è‹±èª)</option>
                <option value="zh-CN">Chinese (ä¸­å›½èª)</option>
                <option value="ko-KR">Korean (éŸ“å›½èª)</option>
                <option value="de-DE">German (ãƒ‰ã‚¤ãƒ„èª)</option>
                <option value="fr-FR">French (ãƒ•ãƒ©ãƒ³ã‚¹èª)</option>
                <option value="es-ES">Spanish (ã‚¹ãƒšã‚¤ãƒ³èª)</option>
                <option value="ar-SA">Arabic (ã‚¢ãƒ©ãƒ“ã‚¢èª)</option>
            </select>
            
            <select id="tone-select" onchange="saveSettings()">
                <option value="normal">Standard</option>
                <option value="polite">Polite (ä¸å¯§)</option>
                <option value="casual">Casual (ãƒ•ãƒ©ãƒ³ã‚¯)</option>
            </select>

            <button id="coach-toggle" class="icon-btn" onclick="toggleCoachMode()" style="opacity: 0.5;">
                ğŸ‘¨â€ğŸ« OFF
            </button>
        </div>

        <div class="history-container" id="self-history"></div>
        <div id="self-live" class="live-monitor"></div>

        <div class="mic-wrapper">
            <button id="btn-self" class="mic-btn">
                <div class="visualizer-ring" id="ring-self"></div>
                ğŸ™ï¸
            </button>
        </div>
        <div id="self-status" class="status-text">é•·æŠ¼ã—ã—ã¦è©±ã™</div>
    </div>
</div>

<script>
    // ==========================================
    // è¨­å®š & APIã‚­ãƒ¼ç®¡ç† (ã‚»ã‚­ãƒ¥ã‚¢ç‰ˆ)
    // ==========================================
    let API_KEY = ""; // ã‚³ãƒ¼ãƒ‰ã«ã¯æ›¸ã‹ãªã„
    const MODEL_ID = "gemini-2.5-flash"; 
    
    let isCoachMode = false;
    let chatLog = [];
    
    const LANG_MAP = {
        'ja-JP': 'Japanese', 'en-US': 'English', 'zh-CN': 'Chinese', 'ko-KR': 'Korean',
        'de-DE': 'German', 'fr-FR': 'French', 'es-ES': 'Spanish', 'ar-SA': 'Arabic'
    };

    // èµ·å‹•æ™‚å‡¦ç†
    window.onload = function() {
        loadSettings();
        checkApiKey();
    };

    function checkApiKey() {
        const storedKey = localStorage.getItem('crosstalk_api_key');
        if (storedKey) {
            API_KEY = storedKey;
            document.getElementById('key-modal').style.display = 'none';
        } else {
            document.getElementById('key-modal').style.display = 'flex';
        }
    }

    function saveApiKey() {
        const input = document.getElementById('api-key-input').value.trim();
        if (input.length > 10) {
            localStorage.setItem('crosstalk_api_key', input);
            API_KEY = input;
            document.getElementById('key-modal').style.display = 'none';
        } else {
            alert("Please enter a valid API Key");
        }
    }

    function resetAll() {
        localStorage.removeItem('crosstalk_api_key');
        localStorage.removeItem('crosstalk_settings');
        location.reload();
    }

    // ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºåˆ‡æ›¿
    function toggleHelp() {
        const modal = document.getElementById('help-modal');
        modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
    }

    // è¨­å®šä¿å­˜ãƒ»èª­ã¿è¾¼ã¿
    function saveSettings() {
        const settings = {
            partnerLang: document.getElementById('partner-lang').value,
            selfLang: document.getElementById('self-lang').value,
            tone: document.getElementById('tone-select').value,
            scenario: document.getElementById('scenario-select').value,
            theme: document.documentElement.getAttribute('data-theme')
        };
        localStorage.setItem('crosstalk_settings', JSON.stringify(settings));
    }

    function loadSettings() {
        const saved = localStorage.getItem('crosstalk_settings');
        if (saved) {
            try {
                const s = JSON.parse(saved);
                if(s.partnerLang) document.getElementById('partner-lang').value = s.partnerLang;
                if(s.selfLang) document.getElementById('self-lang').value = s.selfLang;
                if(s.tone) document.getElementById('tone-select').value = s.tone;
                if(s.scenario) document.getElementById('scenario-select').value = s.scenario;
                if(s.theme) document.documentElement.setAttribute('data-theme', s.theme);
            } catch(e) {}
        } else {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        }
    }

    function toggleCoachMode() {
        isCoachMode = !isCoachMode;
        const btn = document.getElementById('coach-toggle');
        if (isCoachMode) {
            btn.innerHTML = "ğŸ‘¨â€ğŸ« ON";
            btn.style.opacity = "1";
            btn.style.backgroundColor = "#f1c40f";
            btn.style.color = "black";
        } else {
            btn.innerHTML = "ğŸ‘¨â€ğŸ« OFF";
            btn.style.opacity = "0.5";
            btn.style.backgroundColor = "";
            btn.style.color = "";
        }
    }

    function toggleTheme() {
        const current = document.documentElement.getAttribute('data-theme');
        document.documentElement.setAttribute('data-theme', current === 'light' ? 'dark' : 'light');
        saveSettings();
    }

    function downloadLog() {
        if (chatLog.length === 0) { alert("å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“"); return; }
        const textContent = chatLog.map(l => `[${l.time}] ${l.speaker}: ${l.original} -> ${l.translated}`).join("\n");
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `log_${new Date().toISOString().slice(0,19).replace(/[-T:]/g,'')}.txt`;
        a.click();
    }

    // Audio Visualizer
    let audioContext, analyser, dataArray, microphone, animationId;
    let isAudioInit = false;

    async function initAudio() {
        if (isAudioInit) return;
        try {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 128;
            microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            isAudioInit = true;
        } catch (e) { console.error("Audio Init Failed", e); }
    }

    function updateVisualizer(ringId) {
        if (!isAudioInit) return;
        analyser.getByteFrequencyData(dataArray);
        let sum = 0;
        for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
        let vol = sum / dataArray.length;
        let scale = 1 + (vol / 40); 
        
        const ring = document.getElementById(ringId);
        if (ring) {
            ring.style.width = `${100 * scale}%`;
            ring.style.height = `${100 * scale}%`;
            ring.style.opacity = `${0.4 + (vol / 200)}`;
        }
        animationId = requestAnimationFrame(() => updateVisualizer(ringId));
    }

    // Gemini API Logic
    async function translateWithGemini(text, sourceCode, targetCode, tone, scenario) {
        if (!text) return null;
        const sName = LANG_MAP[sourceCode] || sourceCode;
        const tName = LANG_MAP[targetCode] || targetCode;

        const prompt = `
        Role: Professional Interpreter & Language Coach.
        Context: ${scenario} setting.
        Source Language: ${sName}
        Target Language: ${tName}
        Desired Tone: ${tone}

        Instruction:
        1. "Correction": Identify potential speech recognition errors based on context. If no error, keep same.
        2. "Translation": Translate the (Corrected) Source Text to Target Language.
        3. "Advice": (Only if enabled) Provide brief advice for the speaker in ${sName}.

        Source Text: "${text}"
        Coach Mode: ${isCoachMode}

        Output Format: JSON ONLY.
        {
            "corrected_source": "string",
            "translation": "string",
            "advice": "string or null"
        }
        `;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_ID}:generateContent?key=${API_KEY}`;
        
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            const rawText = data.candidates?.[0]?.content?.parts?.[0]?.text || "{}";

            const jsonMatch = rawText.match(/\{[\s\S]*\}/);
            const jsonText = jsonMatch ? jsonMatch[0] : "{}";

            return JSON.parse(jsonText);
        } catch (e) {
            console.error("Translation Error:", e);
            return { translation: "(Check API Key)", corrected_source: text, advice: "API Error" };
        }
    }

    function speakText(text, langCode) {
        if (!text) return;
        window.speechSynthesis.cancel();
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = langCode;
        uttr.rate = 1.0; 
        window.speechSynthesis.speak(uttr);
    }

    function addHistory(historyId, resultObj, speaker) {
        const container = document.getElementById(historyId);
        const div = document.createElement('div');
        div.className = 'message-bubble';
        
        const isCorrected = resultObj.corrected_source.trim().toLowerCase() !== resultObj.original.trim().toLowerCase();
        
        const sourceDisplay = isCorrected 
            ? `<span style="text-decoration:line-through; opacity:0.6">${resultObj.original}</span> <span class="corrected-mark">â¤ ${resultObj.corrected_source}</span>`
            : resultObj.original;

        let html = `
            <div class="original-text">${sourceDisplay}</div>
            <div class="translated-text">${resultObj.translation}</div>
        `;

        if (resultObj.advice) {
            html += `<div class="advice-box"><span>ğŸ‘¨â€ğŸ« ${resultObj.advice}</span></div>`;
        }

        div.innerHTML = html;
        container.insertBefore(div, container.firstChild);

        chatLog.push({
            time: new Date().toLocaleTimeString(),
            speaker: speaker,
            original: resultObj.corrected_source,
            translated: resultObj.translation
        });
    }

    // éŸ³å£°èªè­˜
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    function setupRecognition(btnId, langSelectId, historyId, statusId, liveId, ringId, isSelf) {
        const btn = document.getElementById(btnId);
        const langSelect = document.getElementById(langSelectId);
        const targetLangSelect = isSelf ? document.getElementById('partner-lang') : document.getElementById('self-lang');
        const statusEl = document.getElementById(statusId);
        const liveEl = document.getElementById(liveId);
        
        const recognition = new SpeechRecognition();
        recognition.interimResults = true;
        recognition.continuous = true;

        let finalTranscript = '';

        const startRec = async (e) => {
            e.preventDefault();
            if (!API_KEY) { alert("Please set API Key first."); return; }
            if (!audioContext) await initAudio();
            if (audioContext.state === 'suspended') await audioContext.resume();

            recognition.lang = langSelect.value;
            btn.classList.add('active');
            statusEl.innerText = "Listening...";
            liveEl.innerText = "";
            updateVisualizer(ringId);
            try { recognition.start(); } catch(e) {}
            finalTranscript = '';
        };

        const stopRec = (e) => {
            e.preventDefault();
            btn.classList.remove('active');
            statusEl.innerText = "";
            liveEl.innerText = "";
            if(animationId) cancelAnimationFrame(animationId);
            const ring = document.getElementById(ringId);
            if(ring) { ring.style.width = '100%'; ring.style.height = '100%'; ring.style.opacity = '0'; }
            try { recognition.stop(); } catch(e) {}
        };

        btn.addEventListener('mousedown', startRec);
        btn.addEventListener('mouseup', stopRec);
        btn.addEventListener('touchstart', startRec);
        btn.addEventListener('touchend', stopRec);

        recognition.onresult = async (event) => {
            let interim = '';
            let newFinal = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) newFinal += event.results[i][0].transcript;
                else interim += event.results[i][0].transcript;
            }
            if (interim || newFinal) liveEl.innerText = finalTranscript + newFinal + interim;

            if (newFinal) {
                finalTranscript += newFinal;
                liveEl.innerText = "";
                statusEl.innerText = "Gemini thinking...";
                
                const sCode = langSelect.value;
                const tCode = targetLangSelect.value;
                const tone = isSelf ? document.getElementById('tone-select').value : "normal";
                const scenario = document.getElementById('scenario-select').value;

                const result = await translateWithGemini(newFinal, sCode, tCode, tone, scenario);
                statusEl.innerText = "";

                if (result) {
                    result.original = newFinal;
                    addHistory(historyId, result, isSelf ? "Self" : "Partner");
                    speakText(result.translation, tCode);
                }
            }
        };
    }

    setupRecognition('btn-self', 'self-lang', 'self-history', 'self-status', 'self-live', 'ring-self', true);
    setupRecognition('btn-partner', 'partner-lang', 'partner-history', 'partner-status', 'partner-live', 'ring-partner', false);

</script>
</body>
</html>