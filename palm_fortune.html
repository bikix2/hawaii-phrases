<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ‹ AIæ‰‹ç›¸å ã„ V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FFD700;
            --accent: #E0AAFF;
            --bg: #10002b;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
        }
        
        body {
            font-family: 'Shippori Mincho', serif;
            background: linear-gradient(135deg, #10002b 0%, #240046 100%);
            margin: 0; padding: 20px;
            color: var(--text); min-height: 100vh;
        }

        .container { max-width: 600px; margin: 0 auto; text-align: center; padding-bottom: 80px; }

        h1 {
            color: var(--primary); font-size: 1.8rem; margin: 10px 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¿ãƒ– */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn {
            flex: 1; padding: 12px; border: 1px solid var(--primary);
            background: transparent; color: var(--primary);
            border-radius: 25px; cursor: pointer; font-weight: bold;
            transition: all 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: #10002b; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-wrapper { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        
        .upload-area {
            position: relative; width: 48%; aspect-ratio: 3/4;
            border: 2px dashed var(--accent); border-radius: 15px;
            background: rgba(0,0,0,0.3); display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer; overflow: hidden;
        }
        .upload-area.full-width { width: 80%; } /* ã‚·ãƒ³ã‚°ãƒ«ãƒ¢ãƒ¼ãƒ‰ç”¨ */

        .upload-icon { font-size: 2rem; opacity: 0.8; margin-bottom: 5px; }
        .upload-label { font-size: 0.8rem; color: var(--accent); }
        .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; }

        .btn-main {
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #1a0b2e; border: none; padding: 15px 50px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            width: 100%; margin-top: 10px;
        }
        .btn-main:disabled { background: #555; color: #aaa; box-shadow: none; }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-wrapper { display: none; animation: fadeIn 0.5s ease; text-align: left; }
        
        /* ã‚¬ã‚¤ãƒ‰å›³ (SVG) */
        .guide-container {
            background: rgba(255,255,255,0.95); border-radius: 15px;
            padding: 15px; margin-bottom: 20px; text-align: center; color: #333;
        }
        .guide-title { font-weight: bold; margin-bottom: 10px; color: #333; }
        
        /* é‘‘å®šã‚«ãƒ¼ãƒ‰ */
        .fortune-card {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .line-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .line-name { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .color-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; }
        .stars { color: #FFD700; letter-spacing: 2px; }
        ul { margin: 0; padding-left: 20px; color: #eee; font-size: 0.95rem; }
        li { margin-bottom: 5px; }

        /* ç›¸æ€§è¨ºæ–­ç”¨ */
        .compatibility-score {
            font-size: 3rem; font-weight: bold; color: #FF4081; text-align: center;
            text-shadow: 0 0 10px rgba(255, 64, 129, 0.5); margin: 10px 0;
        }

        /* ä¿å­˜ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-sub { flex: 1; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: #00b894; color: white; }
        .btn-retry { background: #636e72; color: white; }

        /* Modal & Loading */
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(16,0,43,0.95); z-index:100; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .crystal-ball { font-size: 4rem; animation: glow 1.5s infinite alternate; margin-bottom: 20px; }
        .loading-msg { color: var(--primary); }
        @keyframes glow { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: #240046; padding: 30px; border-radius: 20px; width: 85%; border: 1px solid var(--primary); text-align: center; }
        .input-key { width: 90%; padding: 12px; margin: 20px 0; background: #10002b; color: white; border: 1px solid var(--primary); border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="key-modal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”‘ APIè¨­å®š</h2>
        <p>Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="API Key">
        <button class="btn-main" onclick="saveApiKey()">OK</button>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="crystal-ball">ğŸ”®</div>
    <div class="loading-msg" id="loading-msg">é‹å‘½ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...</div>
</div>

<div class="container">
    <h1>âœ‹ AIæ‰‹ç›¸å ã„ V3</h1>
    
    <div class="tabs">
        <button class="tab-btn active" onclick="setMode('single')">ã²ã¨ã‚Šã§é‘‘å®š</button>
        <button class="tab-btn" onclick="setMode('pair')">ãµãŸã‚Šã§ç›¸æ€§</button>
    </div>

    <div class="upload-wrapper" id="upload-wrapper">
        <div class="upload-area full-width" id="box1" onclick="triggerUpload('input1')">
            <div id="ph1">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-label" id="label1">æ‰‹ç›¸ã‚’æ’®å½±</div>
            </div>
            <img id="preview1" class="preview-img">
            <input type="file" id="input1" accept="image/*" style="display:none" onchange="handleFile(this, 'preview1', 'ph1')">
        </div>
        <div class="upload-area" id="box2" onclick="triggerUpload('input2')" style="display:none;">
            <div id="ph2">
                <div class="upload-icon">ğŸ¤</div>
                <div class="upload-label">ç›¸æ‰‹ã®æ‰‹ç›¸</div>
            </div>
            <img id="preview2" class="preview-img">
            <input type="file" id="input2" accept="image/*" style="display:none" onchange="handleFile(this, 'preview2', 'ph2')">
        </div>
    </div>

    <button id="analyze-btn" class="btn-main" onclick="startAnalysis()" disabled>é‘‘å®šã™ã‚‹</button>

    <div id="result-wrapper">
        <div id="capture-target" style="background: #10002b; padding: 20px; border-radius: 15px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color:var(--primary); margin:0;">âœ¨ é‘‘å®šçµæœ âœ¨</h2>
                <div style="font-size:0.8rem; color:#aaa;" id="date-label"></div>
            </div>

            <div class="guide-container" id="guide-container">
                <div class="guide-title">âœ‹ æ‰‹ç›¸ã®ã‚¬ã‚¤ãƒ‰ãƒãƒƒãƒ—</div>
                <svg viewBox="0 0 200 220" width="150" height="165" style="display:block; margin:0 auto;">
                    <path d="M40,200 Q10,150 10,100 Q10,50 30,30 L40,80 L50,10 L70,10 L80,80 L90,5 L110,5 L120,80 L130,10 L150,10 L160,90 L180,60 L190,80 Q190,150 160,200 Z" fill="#ffe0bd" stroke="#555" stroke-width="2"/>
                    
                    <path d="M190,90 Q140,110 60,70" fill="none" stroke="#ff4081" stroke-width="3" /> <path d="M180,110 Q100,120 40,90" fill="none" stroke="#2196f3" stroke-width="3" /> <path d="M170,120 Q100,150 80,200" fill="none" stroke="#4caf50" stroke-width="3" /> <path d="M100,200 L100,90" fill="none" stroke="#9c27b0" stroke-width="2" stroke-dasharray="4" /> <path d="M130,100 L130,80" fill="none" stroke="#ff9800" stroke-width="2" /> <path d="M160,100 L160,90" fill="none" stroke="#ffd700" stroke-width="2" /> <path d="M190,85 L180,85" fill="none" stroke="#e91e63" stroke-width="2" /> </svg>
                <div style="font-size:0.7rem; margin-top:5px; display:flex; flex-wrap:wrap; justify-content:center; gap:5px;">
                    <span style="color:#ff4081">â—æ„Ÿæƒ…</span> <span style="color:#2196f3">â—é ­è„³</span> <span style="color:#4caf50">â—ç”Ÿå‘½</span>
                    <span style="color:#9c27b0">â—é‹å‘½</span> <span style="color:#ff9800">â—å¤ªé™½</span> <span style="color:#ffd700">â—è²¡é‹</span> <span style="color:#e91e63">â—çµå©š</span>
                </div>
            </div>

            <div id="result-content"></div>
        </div>

        <div class="action-btns">
            <button class="btn-sub btn-retry" onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
            <button class="btn-sub btn-save" onclick="saveResultImage()">ç”»åƒã‚’ä¿å­˜ ğŸ“¸</button>
        </div>
    </div>
</div>

<script>
    let API_KEY = "";
    const GEMINI_MODEL = "gemini-2.5-flash"; 
    let mode = 'single';
    let img1Base64 = null;
    let img2Base64 = null;

    window.onload = function() {
        checkApiKey();
        document.getElementById('date-label').innerText = new Date().toLocaleDateString();
    };

    function checkApiKey() {
        const stored = localStorage.getItem('gemini_api_key_palm');
        if (stored) { API_KEY = stored; document.getElementById('key-modal').classList.add('hidden'); }
    }
    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) { API_KEY = key; localStorage.setItem('gemini_api_key_palm', key); document.getElementById('key-modal').classList.add('hidden'); }
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        const box1 = document.getElementById('box1');
        const box2 = document.getElementById('box2');
        const label1 = document.getElementById('label1');

        if (mode === 'single') {
            box1.classList.add('full-width');
            box1.style.width = '80%';
            box2.style.display = 'none';
            label1.innerText = 'æ‰‹ç›¸ã‚’æ’®å½±';
            checkReady();
        } else {
            box1.classList.remove('full-width');
            box1.style.width = '48%';
            box2.style.display = 'flex';
            label1.innerText = 'ã‚ãªãŸ';
            checkReady();
        }
    }

    function triggerUpload(id) { document.getElementById(id).click(); }

    function handleFile(input, previewId, placeholderId) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // åœ§ç¸®å‡¦ç†
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    const max = 800;
                    if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
                    canvas.width = w; canvas.height = h;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, w, h);
                    const b64 = canvas.toDataURL('image/jpeg', 0.8);

                    document.getElementById(previewId).src = b64;
                    document.getElementById(previewId).style.display = 'block';
                    document.getElementById(placeholderId).style.display = 'none';

                    if (previewId === 'preview1') img1Base64 = b64;
                    else img2Base64 = b64;
                    
                    checkReady();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    function checkReady() {
        const btn = document.getElementById('analyze-btn');
        if (mode === 'single') {
            btn.disabled = !img1Base64;
        } else {
            btn.disabled = (!img1Base64 || !img2Base64);
        }
    }

    // æ˜Ÿã®ç”Ÿæˆ
    function stars(n) {
        let s = "";
        for(let i=0; i<5; i++) s += (i<n) ? "â˜…" : "â˜†";
        return s;
    }

    // HTMLç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼
    function createCard(title, score, points, color) {
        return `
        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name"><span class="color-dot" style="background:${color}"></span> ${title}</span>
                ${score ? `<span class="stars">${stars(score)}</span>` : ''}
            </div>
            <ul>${points.map(p => `<li>${p}</li>`).join('')}</ul>
        </div>`;
    }

    async function startAnalysis() {
        const btn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        btn.disabled = true;
        loading.style.display = 'flex';

        const b64_1 = img1Base64.replace(/^data:image\/\w+;base64,/, "");
        const b64_2 = img2Base64 ? img2Base64.replace(/^data:image\/\w+;base64,/, "") : null;

        let prompt = "";
        
        if (mode === 'single') {
            prompt = `
            æ‰‹ç›¸å ã„å¸«ã¨ã—ã¦ã€ç”»åƒã®æ‰‹ç›¸ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
            ä»¥ä¸‹ã®7é …ç›®ã«ã¤ã„ã¦ã€ç‚¹æ•°(1-5)ã¨çŸ­ã„ç®‡æ¡æ›¸ã(2-3ç‚¹)ã§JSONå‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            å£èª¿ã¯ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ç¥ç§˜çš„ã«ã€‚

            Format:
            {
                "heart": {"score":4, "points":["..."]},  // æ„Ÿæƒ…ç·š
                "head": {"score":5, "points":["..."]},   // é ­è„³ç·š
                "life": {"score":3, "points":["..."]},   // ç”Ÿå‘½ç·š
                "fate": {"score":4, "points":["..."]},   // é‹å‘½ç·šï¼ˆä»•äº‹ï¼‰
                "sun": {"score":3, "points":["..."]},    // å¤ªé™½ç·šï¼ˆäººæ°—ãƒ»æˆåŠŸï¼‰
                "money": {"score":4, "points":["..."]},  // è²¡é‹ç·šï¼ˆé‡‘é‹ï¼‰
                "marriage": {"score":3, "points":["..."]}, // çµå©šç·šï¼ˆæ‹æ„›ï¼‰
                "message": "ç·åˆçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ä¸€è¨€"
            }
            `;
        } else {
            prompt = `
            2ã¤ã®æ‰‹ç›¸ï¼ˆ1æšç›®:ã‚ãªãŸ, 2æšç›®:ç›¸æ‰‹ï¼‰ã‚’æ¯”è¼ƒã—ã€ã‚«ãƒƒãƒ—ãƒ«ã®ç›¸æ€§è¨ºæ–­ã‚’ã—ã¦ãã ã•ã„ã€‚
            æ€§æ ¼ã®ãƒãƒ©ãƒ³ã‚¹ã€ä¾¡å€¤è¦³ã®ä¸€è‡´åº¦ãªã©ã‚’åˆ†æã—ã€JSONå‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

            Format:
            {
                "score": 85,
                "compatibility_desc": "ç›¸æ€§ã®è‰¯ã•ã‚„æ³¨æ„ç‚¹ãªã©ã®è§£èª¬ï¼ˆ100æ–‡å­—ç¨‹åº¦ï¼‰",
                "points": [
                    "ã‚ãªãŸã®ç‰¹å¾´: ...",
                    "ç›¸æ‰‹ã®ç‰¹å¾´: ...",
                    "äºŒäººã®æœªæ¥: ..."
                ],
                "advice": "ä»²è‰¯ãã™ã‚‹ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹"
            }
            `;
        }

        try {
            const contents = [{
                parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: b64_1 } }]
            }];
            if (mode === 'pair') {
                contents[0].parts.push({ inline_data: { mime_type: "image/jpeg", data: b64_2 } });
            }

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const jsonStr = text.match(/\{[\s\S]*\}/)?.[0];
            const res = JSON.parse(jsonStr || "{}");

            // çµæœè¡¨ç¤ºã®æ§‹ç¯‰
            let html = "";
            if (mode === 'single') {
                document.getElementById('guide-container').style.display = 'block'; // ã‚¬ã‚¤ãƒ‰å›³è¡¨ç¤º
                html += createCard("æ„Ÿæƒ…ç·š (æ€§æ ¼)", res.heart?.score, res.heart?.points, "#ff4081");
                html += createCard("é ­è„³ç·š (æ‰èƒ½)", res.head?.score, res.head?.points, "#2196f3");
                html += createCard("ç”Ÿå‘½ç·š (å¥åº·)", res.life?.score, res.life?.points, "#4caf50");
                html += createCard("é‹å‘½ç·š (ä»•äº‹)", res.fate?.score, res.fate?.points, "#9c27b0");
                html += createCard("å¤ªé™½ç·š (äººæ°—)", res.sun?.score, res.sun?.points, "#ff9800");
                html += createCard("è²¡é‹ç·š (é‡‘é‹)", res.money?.score, res.money?.points, "#ffd700");
                html += createCard("çµå©šç·š (æ‹æ„›)", res.marriage?.score, res.marriage?.points, "#e91e63");
                html += `<div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin-top:10px;"><strong>ğŸ”® ç·åˆ:</strong> ${res.message}</div>`;
            } else {
                document.getElementById('guide-container').style.display = 'none'; // ãƒšã‚¢æ™‚ã¯ã‚¬ã‚¤ãƒ‰éè¡¨ç¤º
                html += `<div class="compatibility-score">ç›¸æ€§ ${res.score}%</div>`;
                html += `<div style="margin-bottom:20px; line-height:1.6;">${res.compatibility_desc}</div>`;
                html += createCard("é‘‘å®šè©³ç´°", null, res.points, "#FFD700");
                html += `<div style="background:rgba(255,64,129,0.2); padding:15px; border-radius:10px; border:1px solid #FF4081;"><strong>ğŸ’˜ ã‚¢ãƒ‰ãƒã‚¤ã‚¹:</strong> ${res.advice}</div>`;
            }

            document.getElementById('result-content').innerHTML = html;
            document.getElementById('result-wrapper').style.display = 'block';
            document.getElementById('upload-wrapper').style.display = 'none';
            btn.style.display = 'none';
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('result-wrapper').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    }

    // ç”»åƒä¿å­˜æ©Ÿèƒ½
    function saveResultImage() {
        const target = document.getElementById("capture-target");
        
        // ä¿å­˜æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã•ã›ã‚‹
        const name = prompt("ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "æ‰‹ç›¸å ã„çµæœ");
        if (!name) return;

        // html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£
        html2canvas(target, {
            backgroundColor: "#10002b", // èƒŒæ™¯è‰²ã‚’æŒ‡å®š
            scale: 2 // ç”»è³ªã‚’è‰¯ãã™ã‚‹
        }).then(canvas => {
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = `${name}.png`;
            link.click();
        }).catch(err => {
            alert("ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + err);
        });
    }
</script>
</body>
</html>