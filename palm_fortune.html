<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ‹ AIæ‰‹ç›¸å ã„</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d4af37; /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
            --bg: #2c003e; /* æ¿ƒã„ç´« */
            --card-bg: #4a148c;
            --text: #f3e5f5;
        }
        
        body {
            font-family: 'Shippori Mincho', serif;
            background: radial-gradient(circle at center, #4a148c 0%, #1a0033 100%);
            margin: 0; padding: 20px;
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 600px; margin: 0 auto;
            text-align: center;
            padding-bottom: 50px;
        }

        h1 {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.5);
        }

        .subtitle { font-size: 0.9rem; color: #d1c4e9; margin-bottom: 30px; }

        /* ã‚«ãƒ¡ãƒ©ãƒ»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area {
            position: relative;
            width: 280px; height: 380px;
            margin: 0 auto 30px auto;
            border: 3px solid var(--primary);
            border-radius: 200px 200px 60px 60px; /* æ‰‹ã®ã²ã‚‰ã£ã½ã„å½¢ */
            background: rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(212, 175, 55, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:active { transform: scale(0.98); }

        .guide-line {
            position: absolute;
            width: 80%; height: 80%;
            border: 2px dashed rgba(255,255,255,0.3);
            border-radius: 150px 150px 40px 40px;
            pointer-events: none;
        }

        .upload-text { margin-top: 10px; color: var(--primary); font-weight: bold; }
        .upload-icon { font-size: 3rem; opacity: 0.8; }

        #preview-img {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover; display: none;
        }

        .btn-main {
            background: linear-gradient(45deg, #d4af37, #f9a825);
            color: #1a0033;
            border: none; padding: 15px 40px;
            font-size: 1.2rem; font-weight: bold;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
            font-family: 'Shippori Mincho', serif;
            transition: transform 0.2s;
        }
        .btn-main:disabled { background: #7f8c8d; color: #ccc; box-shadow: none; }
        .btn-main:active { transform: scale(0.95); }

        /* çµæœè¡¨ç¤º */
        #result-area { display: none; animation: fadeIn 1s ease; text-align: left; }

        .fortune-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--primary);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .fortune-title {
            color: var(--primary);
            font-size: 1.3rem; border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px; margin-bottom: 15px;
            display: flex; justify-content: space-between;
        }

        .line-name { font-weight: bold; }
        .fortune-text { line-height: 1.8; font-size: 1rem; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 0, 51, 0.9); z-index: 100;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .crystal-ball {
            font-size: 4rem; animation: glow 2s infinite alternate; margin-bottom: 20px;
        }
        .loading-msg { color: var(--primary); font-size: 1.2rem; }

        @keyframes glow { from { text-shadow: 0 0 10px #d4af37; opacity: 0.8; } to { text-shadow: 0 0 30px #fff; opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* API Modal */
        .modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: #2c003e; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 1px solid var(--primary); }
        .input-key { width: 90%; padding: 12px; margin: 20px 0; border: 1px solid var(--primary); background: #1a0033; color: white; border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="key-modal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”‘ é‹å‘½ã®éµ (API Key)</h2>
        <p style="font-size:0.9rem;">Geminiã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="Paste API Key here">
        <button class="btn-main" onclick="saveApiKey()">æ‰‰ã‚’é–‹ã</button>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="crystal-ball">ğŸ”®</div>
    <div class="loading-msg">æ‰‹ç›¸ã‚’éœŠè¦–ä¸­...</div>
</div>

<div class="container">
    <h1>âœ‹ AIæ‰‹ç›¸å ã„</h1>
    <div class="subtitle">ã‚ãªãŸã®æ‰‹ã®ã²ã‚‰ã«åˆ»ã¾ã‚ŒãŸ<br>é‹å‘½ã‚’èª­ã¿è§£ãã¾ã™</div>

    <div class="upload-area" onclick="document.getElementById('camera-input').click()">
        <div id="placeholder">
            <div class="guide-line"></div>
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦<br>æ‰‹ç›¸ã‚’æ’®å½±</div>
        </div>
        <img id="preview-img">
        <input type="file" id="camera-input" accept="image/*" style="display: none" onchange="handleFile(this)">
    </div>

    <button id="analyze-btn" class="btn-main" onclick="analyzePalm()" disabled>é‘‘å®šã™ã‚‹</button>

    <div id="result-area">
        <div style="margin: 30px 0; text-align: center;">
            <span style="font-size: 2rem;">âœ¨ é‘‘å®šçµæœ âœ¨</span>
        </div>

        <div class="fortune-card">
            <div class="fortune-title"><span class="line-name">â¤ï¸ æ„Ÿæƒ…ç·š (æ€§æ ¼ãƒ»æ‹æ„›)</span></div>
            <div class="fortune-text" id="res-heart">...</div>
        </div>

        <div class="fortune-card">
            <div class="fortune-title"><span class="line-name">ğŸ§  é ­è„³ç·š (æ‰èƒ½ãƒ»è€ƒãˆæ–¹)</span></div>
            <div class="fortune-text" id="res-head">...</div>
        </div>

        <div class="fortune-card">
            <div class="fortune-title"><span class="line-name">ğŸŒ± ç”Ÿå‘½ç·š (å¥åº·ãƒ»ãƒã‚¤ã‚¿ãƒªãƒ†ã‚£)</span></div>
            <div class="fortune-text" id="res-life">...</div>
        </div>

        <div class="fortune-card" style="border-color: #ff6b81; background: rgba(255,107,129,0.1);">
            <div class="fortune-title">ğŸ”® ç·åˆé‹å‹¢ & ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
            <div class="fortune-text" id="res-overall">...</div>
        </div>

        <button class="btn-main" style="background:#555; color:white; margin-top:20px;" onclick="location.reload()">ã‚‚ã†ä¸€åº¦å ã†</button>
    </div>
</div>

<script>
    let API_KEY = "";
    const GEMINI_MODEL = "gemini-2.5-flash"; // æŒ‡å®šã®ãƒ¢ãƒ‡ãƒ«
    let currentImageBase64 = null;

    window.onload = function() { checkApiKey(); };

    function checkApiKey() {
        const stored = localStorage.getItem('gemini_api_key_palm');
        if (stored) {
            API_KEY = stored;
            document.getElementById('key-modal').classList.add('hidden');
        }
    }
    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) {
            API_KEY = key;
            localStorage.setItem('gemini_api_key_palm', key);
            document.getElementById('key-modal').classList.add('hidden');
        }
    }

    // ç”»åƒå‡¦ç†ï¼ˆåœ§ç¸®ã—ã¦è¡¨ç¤ºï¼‰
    function handleFile(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // çˆ†é€ŸåŒ–ã®ãŸã‚ãƒªã‚µã‚¤ã‚º (é•·è¾º800px)
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 800;

                    if (width > height) {
                        if (width > maxSize) { height *= maxSize / width; width = maxSize; }
                    } else {
                        if (height > maxSize) { width *= maxSize / height; height = maxSize; }
                    }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
                    const preview = document.getElementById('preview-img');
                    currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8); // ä¿æŒ
                    preview.src = currentImageBase64;
                    preview.style.display = 'block';
                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('analyze-btn').disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    // Geminiã§è§£æ
    async function analyzePalm() {
        if (!currentImageBase64) return;

        const btn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        
        btn.disabled = true;
        loading.style.display = 'flex';

        // ãƒ˜ãƒƒãƒ€ãƒ¼å‰Šé™¤
        const cleanBase64 = currentImageBase64.replace(/^data:image\/\w+;base64,/, "");

        const prompt = `
        ã‚ãªãŸã¯ç†Ÿç·´ã®æ‰‹ç›¸å ã„å¸«ã§ã™ã€‚æä¾›ã•ã‚ŒãŸã€Œæ‰‹ã®ã²ã‚‰ã®å†™çœŸã€ã‚’è©³ã—ãéœŠè¦–ï¼ˆç”»åƒåˆ†æï¼‰ã—ã¦ãã ã•ã„ã€‚
        ä»¥ä¸‹ã®4ã¤ã®è¦³ç‚¹ã§ã€ç·šï¼ˆé•·ã•ã€æ¿ƒã•ã€ã‚«ãƒ¼ãƒ–ãªã©ï¼‰ã®ç‰¹å¾´ã‚’å…·ä½“çš„ã«æŒ™ã’ãªãŒã‚‰å ã£ã¦ãã ã•ã„ã€‚
        
        â€»ä¸­é«˜ç”ŸãŒæ¥½ã—ã‚ã‚‹ã‚ˆã†ã€å°‘ã—ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‹ã¤ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã§ã€Œå½“ãŸã£ã¦ã‚‹æ„Ÿã€ã®ã‚ã‚‹å£èª¿ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
        â€»JSONå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚

        ã€å‡ºåŠ›ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã€‘
        {
            "heart_line": "æ„Ÿæƒ…ç·šï¼ˆå°æŒ‡ã®ä¸‹ã‹ã‚‰äººå·®ã—æŒ‡æ–¹å‘ã¸ä¼¸ã³ã‚‹ç·šï¼‰ã®åˆ†æã€‚æ‹æ„›å‚¾å‘ã‚„æ€§æ ¼ã€‚",
            "head_line": "é ­è„³ç·šï¼ˆè¦ªæŒ‡ã¨äººå·®ã—æŒ‡ã®é–“ã‹ã‚‰æ¨ªåˆ‡ã‚‹ç·šï¼‰ã®åˆ†æã€‚æ‰èƒ½ã‚„è€ƒãˆæ–¹ã€‚",
            "life_line": "ç”Ÿå‘½ç·šï¼ˆè¦ªæŒ‡ã®ä»˜ã‘æ ¹ã‚’å›²ã‚€ç·šï¼‰ã®åˆ†æã€‚ä½“åŠ›ã‚„ãƒã‚¤ã‚¿ãƒªãƒ†ã‚£ã€‚",
            "overall": "å…¨ä½“çš„ãªé‹å‹¢ã¨ã€ä»Šé€±ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‚"
        }
        `;

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                        ]
                    }],
                    // æ‰‹ç›¸ç”»åƒãŒèª¤æ¤œçŸ¥ã•ã‚Œãªã„ã‚ˆã†å®‰å…¨è¨­å®šã‚’è§£é™¤
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("æ‰‹ç›¸ãŒèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");

            // JSONãƒ‘ãƒ¼ã‚¹
            const jsonStr = text.match(/\{[\s\S]*\}/)?.[0];
            const result = JSON.parse(jsonStr || "{}");

            // çµæœè¡¨ç¤º
            document.getElementById('res-heart').innerText = result.heart_line || "èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
            document.getElementById('res-head').innerText = result.head_line || "èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
            document.getElementById('res-life').innerText = result.life_line || "èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸ";
            document.getElementById('res-overall').innerText = result.overall || "å…¨ä½“é‹ã®èª­ã¿å–ã‚Šã«å¤±æ•—ã—ã¾ã—ãŸ";

            document.getElementById('result-area').style.display = 'block';
            document.querySelector('.upload-area').style.display = 'none';
            btn.style.display = 'none';
            
            // çµæœã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            document.getElementById('result-area').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            alert("é‘‘å®šã‚¨ãƒ©ãƒ¼: " + e.message + "\nã‚‚ã£ã¨æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã™ã‚‹ã‹ã€APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    }
</script>
</body>
</html>