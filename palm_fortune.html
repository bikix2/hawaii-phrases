<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ‹ AIæ‰‹ç›¸å ã„ V5</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FFD700;
            --accent: #E0AAFF;
            --bg: #10002b;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
        }
        
        body {
            font-family: 'Shippori Mincho', serif;
            background: linear-gradient(135deg, #10002b 0%, #240046 100%);
            margin: 0; padding: 20px;
            color: var(--text); min-height: 100vh;
        }

        .container { max-width: 600px; margin: 0 auto; text-align: center; padding-bottom: 80px; }

        h1 {
            color: var(--primary); font-size: 1.8rem; margin: 10px 0 5px 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* å·¦å³é¸æŠãƒœã‚¿ãƒ³ */
        .hand-selector {
            display: flex; gap: 15px; justify-content: center; margin: 20px 0;
        }
        .hand-btn {
            background: rgba(255,255,255,0.1); border: 2px solid #555;
            color: #aaa; padding: 10px 20px; border-radius: 30px;
            cursor: pointer; font-weight: bold; transition: all 0.3s;
            flex: 1; max-width: 150px;
        }
        .hand-btn.active {
            border-color: var(--primary); background: var(--primary); color: #10002b;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }
        .hand-desc { font-size: 0.8rem; display: block; margin-top: 5px; font-weight: normal; }

        /* ã‚«ãƒ¡ãƒ©ã‚¨ãƒªã‚¢ */
        .camera-container {
            position: relative;
            width: 100%; max-width: 350px; aspect-ratio: 3/4;
            margin: 0 auto 20px auto;
            background: #000; border-radius: 20px;
            overflow: hidden; border: 2px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        video {
            width: 100%; height: 100%; object-fit: cover;
            transform: scaleX(1); /* ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ã®å ´åˆã¯åè»¢ãŒå¿…è¦ã ãŒã€èƒŒé¢ã‚«ãƒ¡ãƒ©æƒ³å®š */
        }

        /* æ‰‹å½¢ã‚¬ã‚¤ãƒ‰ (SVG) */
        .hand-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; opacity: 0.6; z-index: 10;
            transition: transform 0.3s ease;
        }
        /* å³æ‰‹ãƒ¢ãƒ¼ãƒ‰ã®ã¨ãã¯åè»¢ã•ã›ã‚‹ */
        .hand-overlay.right-hand { transform: scaleX(-1); }

        .shutter-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: #fff; border: 5px solid rgba(255,255,255,0.3);
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            cursor: pointer; z-index: 20; transition: all 0.2s;
        }
        .shutter-btn:active { transform: translateX(-50%) scale(0.9); background: var(--primary); }

        /* æ’®å½±å¾Œã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
        #captured-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; display: none; z-index: 15;
        }
        
        .retake-btn {
            position: absolute; top: 10px; right: 10px; z-index: 30;
            background: rgba(0,0,0,0.6); color: white; border: none;
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            display: none;
        }

        /* äºˆå‚™ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ (ã‚«ãƒ¡ãƒ©èµ·å‹•ã—ãªã„äººç”¨) */
        .fallback-upload {
            margin-top: 10px; font-size: 0.85rem; color: #aaa; text-decoration: underline; cursor: pointer;
        }

        /* ãƒ¡ã‚¤ãƒ³ãƒœã‚¿ãƒ³ */
        .btn-main {
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #1a0b2e; border: none; padding: 15px 50px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            width: 100%; max-width: 350px; margin-top: 10px;
        }
        .btn-main:disabled { background: #555; color: #aaa; box-shadow: none; }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-wrapper { display: none; animation: fadeIn 0.5s ease; text-align: left; }
        
        /* ã‚¬ã‚¤ãƒ‰å›³ (ã•ã‚‰ã«æ”¹å–„) */
        .guide-container {
            background: #1a0b2e; /* æš—ã„èƒŒæ™¯ */
            border: 1px solid var(--primary);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            text-align: center; color: #fff;
        }
        .guide-title { font-weight: bold; margin-bottom: 15px; color: var(--primary); }
        
        /* é‘‘å®šã‚«ãƒ¼ãƒ‰ */
        .fortune-card {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .line-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .line-name { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .stars { color: #FFD700; letter-spacing: 2px; }
        ul { margin: 0; padding-left: 20px; color: #eee; font-size: 0.95rem; }
        li { margin-bottom: 5px; }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(16,0,43,0.95); z-index:100; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .crystal-ball { font-size: 4rem; animation: glow 1.5s infinite alternate; margin-bottom: 20px; }
        .loading-msg { color: var(--primary); }
        @keyframes glow { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: #240046; padding: 30px; border-radius: 20px; width: 85%; border: 1px solid var(--primary); text-align: center; }
        .input-key { width: 90%; padding: 12px; margin: 20px 0; background: #10002b; color: white; border: 1px solid var(--primary); border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="key-modal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”‘ APIè¨­å®š</h2>
        <p>Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="API Key">
        <button class="btn-main" onclick="saveApiKey()">OK</button>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="crystal-ball">ğŸ”®</div>
    <div class="loading-msg">é‹å‘½ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...</div>
</div>

<div class="container">
    <h1>âœ‹ AIæ‰‹ç›¸å ã„ V5</h1>
    
    <div class="hand-selector">
        <button class="hand-btn active" onclick="selectHand('left')">
            ğŸ‘ˆ å·¦æ‰‹<span class="hand-desc">ç”Ÿã¾ã‚Œã¤ãã®é‹å‹¢</span>
        </button>
        <button class="hand-btn" onclick="selectHand('right')">
            å³æ‰‹ ğŸ‘‰<span class="hand-desc">ç¾åœ¨ã®é‹å‹¢</span>
        </button>
    </div>

    <div class="camera-container">
        <video id="video" autoplay playsinline></video>
        
        <div class="hand-overlay" id="hand-guide">
            <svg viewBox="0 0 200 260" width="100%" height="100%" style="fill:none; stroke:#FFD700; stroke-width:2; stroke-dasharray:5,5;">
                <path d="M40,260 L40,150 Q10,130 10,100 Q10,50 30,40 L45,90 L55,20 L75,20 L85,90 L95,10 L115,10 L125,90 L135,20 L155,20 L165,100 L185,80 L195,100 Q195,150 160,260" />
            </svg>
            <div style="position:absolute; bottom:100px; width:100%; text-align:center; color:#FFD700; font-weight:bold; text-shadow:0 0 5px #000;">
                æ ã«åˆã‚ã›ã¦ã­
            </div>
        </div>

        <img id="captured-image">
        
        <div class="shutter-btn" id="shutter-btn" onclick="takePhoto()"></div>
        <button class="retake-btn" id="retake-btn" onclick="resetCamera()">ğŸ”„ æ’®ã‚Šç›´ã™</button>
    </div>

    <div class="fallback-upload" onclick="document.getElementById('file-input').click()">
        â€»ã‚«ãƒ¡ãƒ©ãŒå‹•ã‹ãªã„å ´åˆã¯ã“ã¡ã‚‰ã‹ã‚‰ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    </div>
    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileUpload(this)">

    <button id="analyze-btn" class="btn-main" onclick="startAnalysis()" disabled>é‘‘å®šã™ã‚‹</button>

    <div id="result-wrapper">
        <div id="capture-target" style="background: #10002b; padding: 20px; border-radius: 15px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color:var(--primary); margin:0;">âœ¨ é‘‘å®šçµæœ âœ¨</h2>
                <div style="font-size:0.8rem; color:#aaa;" id="date-label"></div>
            </div>

            <div class="guide-container">
                <div class="guide-title">âœ‹ ã‚ãªãŸã®æ‰‹ç›¸ãƒãƒƒãƒ—</div>
                <svg viewBox="0 0 200 220" width="180" height="200" style="display:block; margin:0 auto;">
                    <path d="M40,200 Q10,150 10,100 Q10,50 30,30 L40,80 L50,10 L70,10 L80,80 L90,5 L110,5 L120,80 L130,10 L150,10 L160,90 L180,60 L190,80 Q190,150 160,200 Z" fill="none" stroke="#888" stroke-width="2"/>
                    
                    <path d="M190,90 Q140,110 60,70" fill="none" stroke="#FF4081" stroke-width="4" stroke-linecap="round" /> <path d="M180,110 Q100,120 40,90" fill="none" stroke="#448AFF" stroke-width="4" stroke-linecap="round" /> <path d="M170,120 Q100,150 80,200" fill="none" stroke="#69F0AE" stroke-width="4" stroke-linecap="round" /> <path d="M100,200 L100,90" fill="none" stroke="#E040FB" stroke-width="3" stroke-dasharray="4" /> <path d="M130,100 L130,80" fill="none" stroke="#FFAB40" stroke-width="3" /> <path d="M160,100 L160,90" fill="none" stroke="#FFFF00" stroke-width="3" /> <path d="M190,85 L180,85" fill="none" stroke="#FF5252" stroke-width="3" /> </svg>
                <div style="font-size:0.75rem; margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:10px; font-weight:bold;">
                    <span style="color:#FF4081">â—æ„Ÿæƒ…</span> <span style="color:#448AFF">â—é ­è„³</span> <span style="color:#69F0AE">â—ç”Ÿå‘½</span>
                    <span style="color:#E040FB">â—é‹å‘½</span> <span style="color:#FFAB40">â—å¤ªé™½</span> <span style="color:#FFFF00">â—è²¡é‹</span> <span style="color:#FF5252">â—çµå©š</span>
                </div>
            </div>

            <div id="result-content"></div>
        </div>

        <div class="action-btns" style="margin-top:20px;">
            <button class="btn-main" style="background:#636e72; font-size:1rem;" onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
        </div>
    </div>
</div>

<script>
    let API_KEY = "";
    const GEMINI_MODEL = "gemini-2.5-flash"; 
    let selectedHand = 'left';
    let videoStream = null;
    let finalImageBase64 = null;

    window.onload = function() {
        checkApiKey();
        document.getElementById('date-label').innerText = new Date().toLocaleDateString();
        startCamera(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚«ãƒ¡ãƒ©èµ·å‹•
    };

    function checkApiKey() {
        const stored = localStorage.getItem('gemini_api_key_palm');
        if (stored) { API_KEY = stored; document.getElementById('key-modal').classList.add('hidden'); }
    }
    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) { API_KEY = key; localStorage.setItem('gemini_api_key_palm', key); document.getElementById('key-modal').classList.add('hidden'); }
    }

    // ã‚«ãƒ¡ãƒ©èµ·å‹•
    async function startCamera() {
        try {
            const video = document.getElementById('video');
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }, // èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ
                audio: false
            });
            video.srcObject = videoStream;
        } catch (err) {
            console.warn("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
            // ã‚«ãƒ¡ãƒ©ãŒä½¿ãˆãªã„å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆç­‰ã¯å‡ºã•ãšã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’ä½¿ã£ã¦ã­ã¨ã„ã†UIã«ã™ã‚‹
        }
    }

    function selectHand(hand) {
        selectedHand = hand;
        document.querySelectorAll('.hand-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        
        // ã‚¬ã‚¤ãƒ‰ã®åè»¢
        const guide = document.getElementById('hand-guide');
        if (hand === 'right') {
            guide.classList.add('right-hand');
        } else {
            guide.classList.remove('right-hand');
        }
    }

    function takePhoto() {
        const video = document.getElementById('video');
        if (!video.srcObject) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // ç”»åƒã‚’ä¿æŒãƒ»è¡¨ç¤º
        // åœ§ç¸®å‡¦ç† (é•·è¾º800px)
        resizeAndSave(canvas.toDataURL('image/jpeg', 0.9));
    }

    function resizeAndSave(originalBase64) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const max = 800;
            if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            
            finalImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
            
            const captured = document.getElementById('captured-image');
            captured.src = finalImageBase64;
            captured.style.display = 'block';
            
            document.getElementById('shutter-btn').style.display = 'none';
            document.getElementById('retake-btn').style.display = 'block';
            document.getElementById('analyze-btn').disabled = false;
        };
        img.src = originalBase64;
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                resizeAndSave(e.target.result);
            };
            reader.readAsDataURL(file);
        }
    }

    function resetCamera() {
        document.getElementById('captured-image').style.display = 'none';
        document.getElementById('shutter-btn').style.display = 'block';
        document.getElementById('retake-btn').style.display = 'none';
        document.getElementById('analyze-btn').disabled = true;
        finalImageBase64 = null;
    }

    // çµæœè¡¨ç¤ºç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼
    function stars(n) {
        let s = ""; for(let i=0; i<5; i++) s += (i<n) ? "â˜…" : "â˜†"; return s;
    }
    function createCard(title, score, points, color) {
        return `
        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name" style="color:${color}">â— ${title}</span>
                ${score ? `<span class="stars">${stars(score)}</span>` : ''}
            </div>
            <ul>${points.map(p => `<li>${p}</li>`).join('')}</ul>
        </div>`;
    }

    async function startAnalysis() {
        const btn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        btn.disabled = true;
        loading.style.display = 'flex';

        const cleanBase64 = finalImageBase64.replace(/^data:image\/\w+;base64,/, "");

        const prompt = `
        æ‰‹ç›¸å ã„å¸«ã¨ã—ã¦ã€ç”»åƒã®æ‰‹ç›¸(${selectedHand === 'left' ? 'å·¦æ‰‹ï¼šå…ˆå¤©çš„' : 'å³æ‰‹ï¼šå¾Œå¤©çš„'})ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
        ä»¥ä¸‹ã®7é …ç›®ã«ã¤ã„ã¦ã€ç‚¹æ•°(1-5)ã¨çŸ­ã„ç®‡æ¡æ›¸ã(2-3ç‚¹)ã§JSONå‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
        
        Format:
        {
            "heart": {"score":4, "points":["..."]}, 
            "head": {"score":5, "points":["..."]},
            "life": {"score":3, "points":["..."]},
            "fate": {"score":4, "points":["..."]},
            "sun": {"score":3, "points":["..."]},
            "money": {"score":4, "points":["..."]},
            "marriage": {"score":3, "points":["..."]},
            "message": "ç·åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹"
        }
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }]
                    }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const jsonStr = text.match(/\{[\s\S]*\}/)?.[0];
            const res = JSON.parse(jsonStr || "{}");

            let html = "";
            html += createCard("æ„Ÿæƒ…ç·š (æ€§æ ¼)", res.heart?.score, res.heart?.points, "#ff4081");
            html += createCard("é ­è„³ç·š (æ‰èƒ½)", res.head?.score, res.head?.points, "#448AFF");
            html += createCard("ç”Ÿå‘½ç·š (å¥åº·)", res.life?.score, res.life?.points, "#69F0AE");
            html += createCard("é‹å‘½ç·š (ä»•äº‹)", res.fate?.score, res.fate?.points, "#E040FB");
            html += createCard("å¤ªé™½ç·š (äººæ°—)", res.sun?.score, res.sun?.points, "#FFAB40");
            html += createCard("è²¡é‹ç·š (é‡‘é‹)", res.money?.score, res.money?.points, "#FFFF00");
            html += createCard("çµå©šç·š (æ‹æ„›)", res.marriage?.score, res.marriage?.points, "#FF5252");
            html += `<div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin-top:10px;"><strong>ğŸ”® ç·åˆ:</strong> ${res.message}</div>`;

            document.getElementById('result-content').innerHTML = html;
            document.getElementById('result-wrapper').style.display = 'block';
            document.querySelector('.camera-container').style.display = 'none';
            document.querySelector('.hand-selector').style.display = 'none';
            btn.style.display = 'none';
            
            document.getElementById('result-wrapper').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    }
</script>
</body>
</html>