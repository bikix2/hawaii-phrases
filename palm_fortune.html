<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ‹ AIæ‰‹ç›¸å ã„ V26</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FFD700;
            --accent: #E0AAFF;
            --bg: #10002b;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
        }
        
        body {
            font-family: 'Shippori Mincho', serif;
            background: linear-gradient(135deg, #10002b 0%, #240046 100%);
            margin: 0; padding: 20px;
            color: var(--text); min-height: 100vh;
        }

        .container { max-width: 600px; margin: 0 auto; text-align: center; padding-bottom: 80px; }

        h1 {
            color: var(--primary); font-size: 1.8rem; margin: 10px 0 15px 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* å·¦å³é¸æŠ */
        .hand-selector { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; transition: opacity 0.3s; }
        .hand-btn {
            background: rgba(255,255,255,0.1); border: 1px solid #666;
            color: #ccc; padding: 10px 5px; border-radius: 10px;
            cursor: pointer; transition: all 0.3s; flex: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .hand-btn.active {
            border-color: var(--primary); background: rgba(255, 215, 0, 0.2); color: #fff;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.2);
        }
        .hand-main { font-size: 1.1rem; font-weight: bold; }
        .hand-sub { font-size: 0.75rem; margin-top: 3px; color: var(--primary); }

        /* ã‚¿ãƒ– */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; transition: opacity 0.3s; }
        .tab-btn {
            flex: 1; padding: 10px; border: 1px solid var(--primary);
            background: transparent; color: var(--primary);
            border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: #10002b; }

        /* ç”»åƒæ  */
        .upload-wrapper { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .upload-box {
            position: relative; width: 48%; aspect-ratio: 3/4;
            border: 2px dashed var(--accent); border-radius: 15px;
            background: rgba(0,0,0,0.3); display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer; overflow: hidden;
        }
        .upload-box.full-width { width: 80%; max-width: 300px; } 
        .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; }
        .upload-icon { font-size: 2rem; margin-bottom: 5px; opacity: 0.8; }
        .upload-label { font-size: 0.9rem; }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-main {
            background: linear-gradient(45deg, #FFD700, #FDB931); color: #1a0b2e; border: none; padding: 15px 50px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); width: 100%; margin-top: 10px;
        }
        .btn-main:disabled { background: #555; color: #aaa; box-shadow: none; }

        /* æ’®å½±å¾Œã®æ“ä½œãƒœã‚¿ãƒ³ */
        .control-btns { display: none; gap: 10px; margin-top: 20px; justify-content: center; }
        .btn-control {
            background: rgba(255,255,255,0.1); border: 1px solid #999; color: #fff;
            padding: 12px 20px; border-radius: 30px; cursor: pointer; font-size: 0.95rem; flex: 1; max-width: 140px;
            font-weight: bold;
        }

        #result-wrapper { display: none; animation: fadeIn 0.5s ease; text-align: left; }
        
        /* ã‚¬ã‚¤ãƒ‰å›³ */
        .guide-container {
            background: #1a0b2e; border: 1px solid var(--primary);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            text-align: center; color: #fff;
        }
        .guide-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); font-size: 1.1rem;}

        .guide-legend {
            font-size: 0.75rem; margin-top: 12px; display: flex; flex-wrap: wrap; 
            justify-content: center; gap: 8px; font-weight: bold; line-height: 1.5;
        }
        .legend-item { display: inline-flex; align-items: center; gap: 4px; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; }

        .fortune-card {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .line-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .line-name { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .stars { color: #FFD700; letter-spacing: 2px; }
        ul { margin: 0; padding-left: 20px; color: #eee; font-size: 0.95rem; }
        li { margin-bottom: 5px; }

        .compatibility-score {
            font-size: 3rem; font-weight: bold; color: #FF4081; text-align: center;
            text-shadow: 0 0 10px rgba(255, 64, 129, 0.5); margin: 10px 0;
        }

        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-sub { flex: 1; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: #00b894; color: white; }
        .btn-retry { background: #636e72; color: white; }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(16,0,43,0.95); z-index:100; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .crystal-ball { font-size: 4rem; animation: glow 1.5s infinite alternate; margin-bottom: 20px; }
        .loading-msg { color: var(--primary); }
        @keyframes glow { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: #240046; padding: 30px; border-radius: 20px; width: 85%; border: 1px solid var(--primary); text-align: center; }
        .input-key { width: 90%; padding: 12px; margin: 20px 0; background: #10002b; color: white; border: 1px solid var(--primary); border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="key-modal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”‘ APIè¨­å®š</h2>
        <p>Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="API Key">
        <button class="btn-main" onclick="saveApiKey()">OK</button>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="crystal-ball">ğŸ”®</div>
    <div class="loading-msg" id="loading-msg">é‹å‘½ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...</div>
</div>

<div class="container">
    <h1>âœ‹ AIæ‰‹ç›¸å ã„ V26</h1>
    
    <div id="settings-area">
        <div class="hand-selector">
            <div class="hand-btn active" id="sel-left" onclick="selectHand('left')">
                <div class="hand-main">ğŸ‘ˆ å·¦æ‰‹</div>
                <div class="hand-sub">ç”Ÿã¾ã‚Œã¤ãã®é‹å‹¢</div>
            </div>
            <div class="hand-btn" id="sel-right" onclick="selectHand('right')">
                <div class="hand-main">å³æ‰‹ ğŸ‘‰</div>
                <div class="hand-sub">ç¾åœ¨ã®é‹å‹¢</div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="setMode('single')">ã²ã¨ã‚Šã§é‘‘å®š</button>
            <button class="tab-btn" onclick="setMode('pair')">ãµãŸã‚Šã§ç›¸æ€§</button>
        </div>
    </div>

    <div class="upload-wrapper" id="upload-wrapper">
        <div class="upload-box full-width" id="box1" onclick="triggerFile(1)">
            <div id="ph1">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-label" id="label1">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±</div>
            </div>
            <img id="preview1" class="preview-img">
        </div>
        <div class="upload-box" id="box2" onclick="triggerFile(2)" style="display:none;">
            <div id="ph2">
                <div class="upload-icon">ğŸ¤</div>
                <div class="upload-label">ç›¸æ‰‹ã®æ‰‹ç›¸</div>
            </div>
            <img id="preview2" class="preview-img">
        </div>
    </div>

    <input type="file" id="file-input-1" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(this, 1)">
    <input type="file" id="file-input-2" accept="image/*" capture="environment" style="display:none" onchange="handleFileSelect(this, 2)">
    
    <button id="analyze-btn" class="btn-main" onclick="startAnalysis()" disabled>é‘‘å®šã™ã‚‹</button>

    <div class="control-btns" id="post-capture-btns">
        <button class="btn-control" onclick="resetAll()">ğŸ  æœ€åˆã«æˆ»ã‚‹</button>
        <button class="btn-control" onclick="retakeCurrent()">ğŸ”„ æ’®ã‚Šç›´ã™</button>
    </div>

    <div id="result-wrapper">
        <div id="capture-target" style="background: #10002b; padding: 20px; border-radius: 15px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color:var(--primary); margin:0;">âœ¨ é‘‘å®šçµæœ âœ¨</h2>
                <div style="color:#aaa; font-size:0.9rem; margin-top:5px; font-weight:bold;" id="result-hand-label"></div>
                <div style="font-size:0.8rem; color:#666;" id="date-label"></div>
            </div>

            <div class="guide-container">
                <div class="guide-title">âœ‹ æ‰‹ç›¸ãƒãƒƒãƒ— (<span id="hand-side-text">å·¦æ‰‹</span>)</div>
                
                <svg id="svg-left" viewBox="0 0 200 220" width="180" height="200" style="display:none; margin:0 auto;">
                    <path d="M40,200 Q10,150 10,100 Q10,50 30,30 L40,80 L50,10 L70,10 L80,80 L90,5 L110,5 L120,80 L130,10 L150,10 L160,90 L180,60 L190,80 Q190,150 160,200 Z" fill="none" stroke="#888" stroke-width="2"/>
                    
                    <path d="M140,90 Q80,150 80,210" fill="none" stroke="#69F0AE" stroke-width="4" stroke-linecap="round" /> <path d="M140,90 Q80,120 20,120" fill="none" stroke="#448AFF" stroke-width="4" stroke-linecap="round" /> <path d="M20,90 Q80,110 160,70" fill="none" stroke="#FF4081" stroke-width="4" stroke-linecap="round" /> <path d="M10,85 L25,85" fill="none" stroke="#FF5252" stroke-width="3" /> <path d="M90,200 L90,90" fill="none" stroke="#E040FB" stroke-width="3" stroke-dasharray="4" /> <path d="M45,100 L45,80" fill="none" stroke="#FFAB40" stroke-width="3" /> <path d="M25,100 L25,90" fill="none" stroke="#FFFF00" stroke-width="3" /> <text x="20" y="55" fill="#fff" font-size="12">å°æŒ‡</text>
                    <text x="160" y="55" fill="#fff" font-size="12">è¦ªæŒ‡</text>
                </svg>

                <svg id="svg-right" viewBox="0 0 200 220" width="180" height="200" style="display:none; margin:0 auto;">
                    <path d="M160,200 Q190,150 190,100 Q190,50 170,30 L160,80 L150,10 L130,10 L120,80 L110,5 L90,5 L80,80 L70,10 L50,10 L40,90 L20,60 L10,80 Q10,150 40,200 Z" fill="none" stroke="#888" stroke-width="2"/>
                    
                    <path d="M60,90 Q120,150 120,210" fill="none" stroke="#69F0AE" stroke-width="4" stroke-linecap="round" /> <path d="M60,90 Q120,120 180,120" fill="none" stroke="#448AFF" stroke-width="4" stroke-linecap="round" /> <path d="M180,90 Q120,110 40,70" fill="none" stroke="#FF4081" stroke-width="4" stroke-linecap="round" /> <path d="M190,85 L175,85" fill="none" stroke="#FF5252" stroke-width="3" /> <path d="M110,200 L110,90" fill="none" stroke="#E040FB" stroke-width="3" stroke-dasharray="4" /> <path d="M155,100 L155,80" fill="none" stroke="#FFAB40" stroke-width="3" /> <path d="M175,100 L175,90" fill="none" stroke="#FFFF00" stroke-width="3" /> <text x="20" y="55" fill="#fff" font-size="12">è¦ªæŒ‡</text>
                    <text x="170" y="55" fill="#fff" font-size="12">å°æŒ‡</text>
                </svg>

                <div class="guide-legend">
                    <div class="legend-item"><span style="color:#FF4081">â—</span>æ„Ÿæƒ…</div>
                    <div class="legend-item"><span style="color:#448AFF">â—</span>é ­è„³</div>
                    <div class="legend-item"><span style="color:#69F0AE">â—</span>ç”Ÿå‘½</div>
                    <div class="legend-item"><span style="color:#E040FB">â—</span>é‹å‘½</div>
                    <div class="legend-item"><span style="color:#FFAB40">â—</span>å¤ªé™½</div>
                    <div class="legend-item"><span style="color:#FFFF00">â—</span>è²¡é‹</div>
                    <div class="legend-item"><span style="color:#FF5252">â—</span>çµå©š</div>
                </div>
            </div>

            <div id="result-content"></div>
        </div>

        <div class="action-btns">
            <button class="btn-sub btn-retry" onclick="location.reload()">æœ€åˆã«æˆ»ã‚‹</button>
            <button class="btn-sub btn-save" onclick="saveResultImage()">ç”»åƒã‚’ä¿å­˜ ğŸ“¸</button>
        </div>
    </div>
</div>

<script>
    let API_KEY = "";
    const GEMINI_MODEL = "gemini-2.5-flash"; 
    let mode = 'single';
    let selectedHand = 'left';
    let activeTarget = 1; 
    let img1Base64 = null;
    let img2Base64 = null;

    window.onload = function() {
        checkApiKey();
        document.getElementById('date-label').innerText = new Date().toLocaleDateString();
    };

    function checkApiKey() {
        const stored = localStorage.getItem('gemini_api_key_palm');
        if (stored) { API_KEY = stored; document.getElementById('key-modal').classList.add('hidden'); }
    }
    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) { API_KEY = key; localStorage.setItem('gemini_api_key_palm', key); document.getElementById('key-modal').classList.add('hidden'); }
    }

    function selectHand(hand) {
        selectedHand = hand;
        document.getElementById('sel-left').classList.toggle('active', hand==='left');
        document.getElementById('sel-right').classList.toggle('active', hand==='right');
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        const box1 = document.getElementById('box1');
        const box2 = document.getElementById('box2');
        const label1 = document.getElementById('label1');

        if (mode === 'single') {
            box1.classList.add('full-width');
            box2.style.display = 'none';
            label1.innerText = 'ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±';
        } else {
            box1.classList.remove('full-width');
            box2.style.display = 'flex';
            label1.innerText = 'ã‚ãªãŸ';
        }
        checkReady();
    }

    function triggerFile(num) {
        activeTarget = num;
        document.getElementById(`file-input-${num}`).click();
    }

    function handleFileSelect(input, targetNum) {
        if (input.files && input.files[0]) {
            activeTarget = targetNum;
            const reader = new FileReader();
            reader.onload = function(e) { processImage(e.target.result); };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function processImage(originalBase64) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const max = 1200;
            if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const b64 = canvas.toDataURL('image/jpeg', 0.9); 

            const previewId = (activeTarget === 1) ? 'preview1' : 'preview2';
            const placeholderId = (activeTarget === 1) ? 'ph1' : 'ph2';
            
            document.getElementById(previewId).src = b64;
            document.getElementById(previewId).style.display = 'block';
            document.getElementById(placeholderId).style.display = 'none';

            if (activeTarget === 1) img1Base64 = b64;
            else img2Base64 = b64;

            checkReady();
        };
        img.src = originalBase64;
    }

    function checkReady() {
        const btn = document.getElementById('analyze-btn');
        const postBtns = document.getElementById('post-capture-btns');
        const settings = document.getElementById('settings-area');
        let isReady = (mode === 'single') ? !!img1Base64 : (!!img1Base64 && !!img2Base64);
        btn.disabled = !isReady;
        
        if (isReady) {
            settings.style.display = 'none';
            postBtns.style.display = 'flex';
        } else {
            settings.style.display = 'block';
            postBtns.style.display = 'none';
        }
    }

    function resetAll() { location.reload(); }
    function retakeCurrent() { triggerFile(activeTarget); }

    function stars(n) {
        let s = ""; for(let i=0; i<5; i++) s += (i<n) ? "â˜…" : "â˜†"; return s;
    }
    
    function createCard(title, score, points, color) {
        const safePoints = Array.isArray(points) ? points : ["æ½œåœ¨çš„ãªå¯èƒ½æ€§ãŒç§˜ã‚ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚"];
        return `
        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name"><span class="color-dot" style="background:${color}; width:12px; height:12px; border-radius:50%; display:inline-block;"></span> ${title}</span>
                ${score ? `<span class="stars">${stars(score)}</span>` : ''}
            </div>
            <ul>${safePoints.map(p => `<li>${p}</li>`).join('')}</ul>
        </div>`;
    }

    async function startAnalysis() {
        const btn = document.getElementById('analyze-btn');
        const postBtns = document.getElementById('post-capture-btns');
        const loading = document.getElementById('loading');
        btn.disabled = true;
        postBtns.style.display = 'none';
        loading.style.display = 'flex';

        const b64_1 = img1Base64.replace(/^data:image\/\w+;base64,/, "");
        const b64_2 = img2Base64 ? img2Base64.replace(/^data:image\/\w+;base64,/, "") : null;

        let prompt = "";
        const handLabel = (selectedHand === 'left') ? "å·¦æ‰‹ï¼ˆç”Ÿã¾ã‚Œã¤ãã®é‹å‹¢ï¼‰" : "å³æ‰‹ï¼ˆç¾åœ¨ã®é‹å‹¢ï¼‰";

        if (mode === 'single') {
            // â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆï¼šå·¦å³èªè­˜ã‚’ä¿®æ­£ï¼†ã‚¨ãƒ³ã‚¿ãƒ¡è¦ç´ å¾©æ´»
            prompt = `
            ã‚ãªãŸã¯ä¸­é«˜ç”Ÿã«äººæ°—ã®ã€å°‘ã—ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã§ã‚µãƒ¼ãƒ“ã‚¹ç²¾ç¥æ—ºç››ãªæ‰‹ç›¸å ã„å¸«ã§ã™ã€‚
            ç”»åƒã®æ‰‹ç›¸ï¼ˆ${handLabel}ï¼‰ã‚’åˆ†æã—ã€ã€Œã§ã™ãƒ»ã¾ã™èª¿ã€ã§é‘‘å®šã—ã¦ãã ã•ã„ã€‚
            
            ã€é‡è¦ã€‘å·¦å³ã®èªè­˜:
            - å·¦æ‰‹å†™çœŸ: ç”»åƒã®ã€Œå³å´ã€ãŒè¦ªæŒ‡ã€ã€Œå·¦å´ã€ãŒå°æŒ‡ã€‚
            - å³æ‰‹å†™çœŸ: ç”»åƒã®ã€Œå·¦å´ã€ãŒè¦ªæŒ‡ã€ã€Œå³å´ã€ãŒå°æŒ‡ã€‚
            
            ã€æ•‘æ¸ˆãƒ«ãƒ¼ãƒ« & ã‚¨ãƒ³ã‚¿ãƒ¡ã€‘
            - ç·šãŒè¦‹ãˆã«ãã„å ´åˆã‚‚ã€ã€Œè§£æä¸å¯ã€ã¨ã¯è¿”ã•ãšã€æ‰‹ã®å½¢ã‚„ä»–ã®ç·šã‹ã‚‰æ¨æ¸¬ã—ã¦ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ã«è§£é‡ˆã—ã¦ãã ã•ã„ï¼ˆã‚³ãƒ¼ãƒ«ãƒ‰ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰ã€‚
            - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æ¥½ã—ã¾ã›ã‚‹ãŸã‚ã«ã€æ›–æ˜§ãªç·šã§ã‚‚ã€Œãƒã‚¸ãƒ†ã‚£ãƒ–ãªæ„å‘³ã€ã‚’è¦‹å‡ºã—ã¦ã€å°‘ã—å¤§ã’ã•ãªè¡¨ç¾ï¼ˆãƒãƒ«ã‚·ãƒãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ã‚’äº¤ãˆã¦ç››ã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚
            
            7é …ç›®(æ„Ÿæƒ…,é ­è„³,ç”Ÿå‘½,é‹å‘½,å¤ªé™½,è²¡é‹,çµå©š)ã«ã¤ã„ã¦ã€ç‚¹æ•°(1-5)ã¨å…·ä½“çš„ã‹ã¤æ¥½ã—ã„ç®‡æ¡æ›¸ãã§JSONå‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            Format: {"heart": {"score":4, "points":["..."]}, ... "message":"..."}
            `;
        } else {
            prompt = `
            2ã¤ã®æ‰‹ç›¸ï¼ˆ1æšç›®, 2æšç›®ï¼‰ã‚’æ¯”è¼ƒã—ã€ã‚«ãƒƒãƒ—ãƒ«ã®ç›¸æ€§è¨ºæ–­ã‚’ã—ã¦ãã ã•ã„ã€‚
            ã‚‚ã—ç·šãŒè¦‹ãˆã«ããã¦ã‚‚ã€ã€Œé‹å‘½çš„ãªç›¸æ€§ã€ã‚’è¦‹å‡ºã—ã¦ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ç››ã‚Šä¸Šã’ã¦ãã ã•ã„ã€‚
            Format: {"score": 85, "compatibility_desc": "...", "points": ["..."], "advice": "..."}
            `;
        }

        try {
            const contents = [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: b64_1 } }] }];
            if (mode === 'pair') contents[0].parts.push({ inline_data: { mime_type: "image/jpeg", data: b64_2 } });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            
            let res = {};
            try {
                const jsonStr = text.match(/\{[\s\S]*\}/)?.[0];
                res = JSON.parse(jsonStr);
            } catch (e) {
                res = { message: "ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€‚æ˜Ÿã®å·¡ã‚ŠãŒæ‚ªãã€ã†ã¾ãèª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ã¿ã¦ãã ã•ã„ã€‚" };
            }

            let html = "";
            const svgLeft = document.getElementById('svg-left');
            const svgRight = document.getElementById('svg-right');
            const handText = document.getElementById('hand-side-text');
            const resultLabel = document.getElementById('result-hand-label');

            if (mode === 'single') {
                document.querySelector('.guide-container').style.display = 'block';
                resultLabel.innerText = "é‘‘å®šéƒ¨ä½ï¼š" + handLabel;
                
                // SVGåˆ‡ã‚Šæ›¿ãˆ
                if (selectedHand === 'left') {
                    svgLeft.style.display = 'block'; svgRight.style.display = 'none'; handText.innerText = "å·¦æ‰‹";
                } else {
                    svgLeft.style.display = 'none'; svgRight.style.display = 'block'; handText.innerText = "å³æ‰‹";
                }

                html += createCard("æ„Ÿæƒ…ç·š", res.heart?.score, res.heart?.points, "#ff4081");
                html += createCard("é ­è„³ç·š", res.head?.score, res.head?.points, "#448AFF");
                html += createCard("ç”Ÿå‘½ç·š", res.life?.score, res.life?.points, "#69F0AE");
                html += createCard("é‹å‘½ç·š", res.fate?.score, res.fate?.points, "#E040FB");
                html += createCard("å¤ªé™½ç·š", res.sun?.score, res.sun?.points, "#FFAB40");
                html += createCard("è²¡é‹ç·š", res.money?.score, res.money?.points, "#FFFF00");
                html += createCard("çµå©šç·š", res.marriage?.score, res.marriage?.points, "#FF5252");
                html += `<div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px;"><strong>ğŸ”® ç·åˆ:</strong> ${res.message || "èª­ã¿å–ã‚Šå¤±æ•—"}</div>`;
            } else {
                document.querySelector('.guide-container').style.display = 'none';
                resultLabel.innerText = "é‘‘å®šãƒ¢ãƒ¼ãƒ‰ï¼šãµãŸã‚Šã§ç›¸æ€§è¨ºæ–­";
                html += `<div class="compatibility-score">ç›¸æ€§ ${res.score || "?"}%</div>`;
                html += `<div style="margin-bottom:20px;">${res.compatibility_desc || "è¨ºæ–­ã§ãã¾ã›ã‚“ã§ã—ãŸ"}</div>`;
                html += createCard("è¨ºæ–­è©³ç´°", null, res.points, "#FFD700");
                html += `<div style="background:rgba(255,64,129,0.2); padding:15px; border-radius:10px;"><strong>ğŸ’˜ ã‚¢ãƒ‰ãƒã‚¤ã‚¹:</strong> ${res.advice || ""}</div>`;
            }

            document.getElementById('result-content').innerHTML = html;
            
            document.getElementById('settings-area').style.display = 'none';
            document.getElementById('upload-wrapper').style.display = 'none';
            document.getElementById('post-capture-btns').style.display = 'none';
            btn.style.display = 'none';
            
            document.getElementById('result-wrapper').style.display = 'block';
            document.getElementById('result-wrapper').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            postBtns.style.display = 'flex';
            btn.disabled = false;
        } finally {
            loading.style.display = 'none';
        }
    }

    function saveResultImage() {
        const target = document.getElementById("capture-target");
        const name = prompt("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›", "æ‰‹ç›¸å ã„çµæœ");
        if (!name) return;
        html2canvas(target, { backgroundColor: "#10002b", scale: 2 }).then(canvas => {
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = `${name}.png`;
            link.click();
        });
    }
</script>
</body>
</html>