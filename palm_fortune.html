<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ‹ AIæ‰‹ç›¸å ã„ V6</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FFD700;
            --accent: #E0AAFF;
            --bg: #10002b;
            --card-bg: rgba(255, 255, 255, 0.08);
            --text: #ffffff;
        }
        
        body {
            font-family: 'Shippori Mincho', serif;
            background: linear-gradient(135deg, #10002b 0%, #240046 100%);
            margin: 0; padding: 20px;
            color: var(--text); min-height: 100vh;
        }

        .container { max-width: 600px; margin: 0 auto; text-align: center; padding-bottom: 80px; }

        h1 {
            color: var(--primary); font-size: 1.8rem; margin: 10px 0 5px 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        /* ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ã‚¿ãƒ– */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .tab-btn {
            flex: 1; padding: 12px; border: 1px solid var(--primary);
            background: transparent; color: var(--primary);
            border-radius: 25px; cursor: pointer; font-weight: bold;
            transition: all 0.3s;
        }
        .tab-btn.active { background: var(--primary); color: #10002b; }

        /* å·¦å³é¸æŠï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³é¢¨ï¼‰ */
        .hand-selector {
            background: rgba(255,255,255,0.1); border-radius: 30px;
            display: inline-flex; margin-bottom: 20px; padding: 5px;
        }
        .hand-opt {
            padding: 8px 20px; border-radius: 25px; cursor: pointer; font-size: 0.9rem;
            transition: 0.3s; color: #aaa;
        }
        .hand-opt.active { background: var(--primary); color: #10002b; font-weight: bold; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ä¸€è¦§ */
        .upload-wrapper { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        
        .upload-box {
            position: relative; width: 48%; aspect-ratio: 3/4;
            border: 2px dashed var(--accent); border-radius: 15px;
            background: rgba(0,0,0,0.3); display: flex; flex-direction: column;
            justify-content: center; align-items: center; cursor: pointer; overflow: hidden;
        }
        .upload-box.full-width { width: 80%; max-width: 300px; } 

        .preview-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; display: none; }
        .upload-icon { font-size: 2rem; margin-bottom: 5px; opacity: 0.8; }
        .upload-label { font-size: 0.9rem; }

        /* === ã‚«ãƒ¡ãƒ©ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ === */
        #camera-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 2000; display: none;
        }
        #video { width: 100%; height: 100%; object-fit: cover; }
        
        /* ã‚¬ã‚¤ãƒ‰ï¼ˆæ”¹è‰¯ç‰ˆï¼šæŒ‡ã®è‚¡ã¾ã§ï¼‰ */
        .guide-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; height: 60%; /* é«˜ã•ã‚’æŠ‘ãˆã¦æ‰‹ã®ã²ã‚‰ä¸­å¿ƒã« */
            border: 4px dashed rgba(255, 215, 0, 0.6);
            border-radius: 30px 30px 100px 100px; /* ä¸‹ã‚’ä¸¸ã */
            pointer-events: none;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); /* å‘¨ã‚Šã‚’æš—ã */
        }
        /* æŒ‡ã®è‚¡ã®ãƒ©ã‚¤ãƒ³ */
        .guide-top-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.8);
        }
        .guide-text {
            position: absolute; top: -40px; width: 100%; text-align: center;
            color: #FFD700; font-weight: bold; text-shadow: 0 2px 4px #000;
        }

        .shutter-btn {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 70px; background: #fff; border-radius: 50%;
            border: 5px solid rgba(255,255,255,0.3); cursor: pointer;
        }
        .close-camera {
            position: absolute; top: 20px; right: 20px; color: white;
            font-size: 2rem; cursor: pointer; z-index: 2001;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn-main {
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #1a0b2e; border: none; padding: 15px 50px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            width: 100%; margin-top: 10px;
        }
        .btn-main:disabled { background: #555; color: #aaa; box-shadow: none; }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-wrapper { display: none; animation: fadeIn 0.5s ease; text-align: left; }
        
        .guide-container {
            background: #1a0b2e; border: 1px solid var(--primary);
            border-radius: 15px; padding: 20px; margin-bottom: 20px;
            text-align: center; color: #fff;
        }
        /* SVGåè»¢ç”¨ã‚¯ãƒ©ã‚¹ */
        .flip-svg { transform: scaleX(-1); }

        .fortune-card {
            background: var(--card-bg); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px; padding: 15px; margin-bottom: 15px;
        }
        .line-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px; }
        .line-name { font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .stars { color: #FFD700; letter-spacing: 2px; }
        ul { margin: 0; padding-left: 20px; color: #eee; font-size: 0.95rem; }
        li { margin-bottom: 5px; }

        .compatibility-score {
            font-size: 3rem; font-weight: bold; color: #FF4081; text-align: center;
            text-shadow: 0 0 10px rgba(255, 64, 129, 0.5); margin: 10px 0;
        }

        .action-btns { display: flex; gap: 10px; margin-top: 20px; }
        .btn-sub { flex: 1; padding: 12px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; }
        .btn-save { background: #00b894; color: white; }
        .btn-retry { background: #636e72; color: white; }

        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(16,0,43,0.95); z-index:100; display:none; justify-content:center; align-items:center; flex-direction:column; }
        .crystal-ball { font-size: 4rem; animation: glow 1.5s infinite alternate; margin-bottom: 20px; }
        .loading-msg { color: var(--primary); }
        @keyframes glow { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: #240046; padding: 30px; border-radius: 20px; width: 85%; border: 1px solid var(--primary); text-align: center; }
        .input-key { width: 90%; padding: 12px; margin: 20px 0; background: #10002b; color: white; border: 1px solid var(--primary); border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="key-modal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”‘ APIè¨­å®š</h2>
        <p>Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="API Key">
        <button class="btn-main" onclick="saveApiKey()">OK</button>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="crystal-ball">ğŸ”®</div>
    <div class="loading-msg" id="loading-msg">é‹å‘½ã‚’èª­ã¿è§£ã„ã¦ã„ã¾ã™...</div>
</div>

<div id="camera-modal">
    <video id="video" autoplay playsinline></video>
    <div class="close-camera" onclick="closeCamera()">Ã—</div>
    
    <div class="guide-overlay">
        <div class="guide-top-line"></div>
        <div class="guide-text">ä¸Šã®ç·šã«ã€ŒæŒ‡ã®ä»˜ã‘æ ¹ã€ã‚’åˆã‚ã›ã¦ã­</div>
    </div>
    
    <div class="shutter-btn" onclick="takePhoto()"></div>
</div>

<div class="container">
    <h1>âœ‹ AIæ‰‹ç›¸å ã„ V6</h1>
    
    <div class="hand-selector">
        <div class="hand-opt active" id="sel-left" onclick="selectHand('left')">ğŸ‘ˆ å·¦æ‰‹(å…ˆå¤©)</div>
        <div class="hand-opt" id="sel-right" onclick="selectHand('right')">å³æ‰‹(ç¾åœ¨) ğŸ‘‰</div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="setMode('single')">ã²ã¨ã‚Šã§é‘‘å®š</button>
        <button class="tab-btn" onclick="setMode('pair')">ãµãŸã‚Šã§ç›¸æ€§</button>
    </div>

    <div class="upload-wrapper" id="upload-wrapper">
        <div class="upload-box full-width" id="box1" onclick="openCamera(1)">
            <div id="ph1">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-label" id="label1">ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±</div>
            </div>
            <img id="preview1" class="preview-img">
        </div>
        <div class="upload-box" id="box2" onclick="openCamera(2)" style="display:none;">
            <div id="ph2">
                <div class="upload-icon">ğŸ¤</div>
                <div class="upload-label">ç›¸æ‰‹ã®æ‰‹ç›¸</div>
            </div>
            <img id="preview2" class="preview-img">
        </div>
    </div>

    <input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileSelect(this)">
    <div style="font-size:0.8rem; color:#aaa; text-decoration:underline; cursor:pointer; margin-bottom:10px;" onclick="document.getElementById('file-input').click()">
        (ã‚«ãƒ¡ãƒ©ãŒå‹•ã‹ãªã„å ´åˆã¯ã“ã¡ã‚‰)
    </div>

    <button id="analyze-btn" class="btn-main" onclick="startAnalysis()" disabled>é‘‘å®šã™ã‚‹</button>

    <div id="result-wrapper">
        <div id="capture-target" style="background: #10002b; padding: 20px; border-radius: 15px;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color:var(--primary); margin:0;">âœ¨ é‘‘å®šçµæœ âœ¨</h2>
                <div style="font-size:0.8rem; color:#aaa;" id="date-label"></div>
            </div>

            <div class="guide-container">
                <div class="guide-title">âœ‹ ã‚ãªãŸã®æ‰‹ç›¸ãƒãƒƒãƒ— (<span id="hand-side-text">å·¦æ‰‹</span>)</div>
                <svg id="guide-svg" viewBox="0 0 200 220" width="180" height="200" style="display:block; margin:0 auto; transition: transform 0.3s;">
                    <path d="M40,200 Q10,150 10,100 Q10,50 30,30 L40,80 L50,10 L70,10 L80,80 L90,5 L110,5 L120,80 L130,10 L150,10 L160,90 L180,60 L190,80 Q190,150 160,200 Z" fill="none" stroke="#888" stroke-width="2"/>
                    <path d="M190,90 Q140,110 60,70" fill="none" stroke="#FF4081" stroke-width="4" stroke-linecap="round" />
                    <path d="M180,110 Q100,120 40,90" fill="none" stroke="#448AFF" stroke-width="4" stroke-linecap="round" />
                    <path d="M170,120 Q100,150 80,200" fill="none" stroke="#69F0AE" stroke-width="4" stroke-linecap="round" />
                    <path d="M100,200 L100,90" fill="none" stroke="#E040FB" stroke-width="3" stroke-dasharray="4" />
                    <path d="M130,100 L130,80" fill="none" stroke="#FFAB40" stroke-width="3" />
                    <path d="M160,100 L160,90" fill="none" stroke="#FFFF00" stroke-width="3" />
                    <path d="M190,85 L180,85" fill="none" stroke="#FF5252" stroke-width="3" />
                </svg>
                <div style="font-size:0.75rem; margin-top:10px; display:flex; flex-wrap:wrap; justify-content:center; gap:10px; font-weight:bold;">
                    <span style="color:#FF4081">â—æ„Ÿæƒ…</span> <span style="color:#448AFF">â—é ­è„³</span> <span style="color:#69F0AE">â—ç”Ÿå‘½</span>
                    <span style="color:#E040FB">â—é‹å‘½</span> <span style="color:#FFAB40">â—å¤ªé™½</span> <span style="color:#FFFF00">â—è²¡é‹</span>
                </div>
            </div>

            <div id="result-content"></div>
        </div>

        <div class="action-btns">
            <button class="btn-sub btn-retry" onclick="location.reload()">ã‚‚ã†ä¸€åº¦</button>
            <button class="btn-sub btn-save" onclick="saveResultImage()">ç”»åƒã‚’ä¿å­˜ ğŸ“¸</button>
        </div>
    </div>
</div>

<script>
    let API_KEY = "";
    const GEMINI_MODEL = "gemini-2.5-flash"; 
    let mode = 'single'; // single or pair
    let selectedHand = 'left'; // left or right
    let activeTarget = 1; // ä»Šã©ã¡ã‚‰ã®ç”»åƒã‚’æ’®ã‚ã†ã¨ã—ã¦ã„ã‚‹ã‹(1 or 2)
    let img1Base64 = null;
    let img2Base64 = null;
    let videoStream = null;

    window.onload = function() {
        checkApiKey();
        document.getElementById('date-label').innerText = new Date().toLocaleDateString();
    };

    function checkApiKey() {
        const stored = localStorage.getItem('gemini_api_key_palm');
        if (stored) { API_KEY = stored; document.getElementById('key-modal').classList.add('hidden'); }
    }
    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) { API_KEY = key; localStorage.setItem('gemini_api_key_palm', key); document.getElementById('key-modal').classList.add('hidden'); }
    }

    function selectHand(hand) {
        selectedHand = hand;
        document.getElementById('sel-left').classList.toggle('active', hand==='left');
        document.getElementById('sel-right').classList.toggle('active', hand==='right');
    }

    function setMode(m) {
        mode = m;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        
        const box1 = document.getElementById('box1');
        const box2 = document.getElementById('box2');
        const label1 = document.getElementById('label1');

        if (mode === 'single') {
            box1.classList.add('full-width');
            box2.style.display = 'none';
            label1.innerText = 'ã“ã“ã‚’ã‚¿ãƒƒãƒ—ã—ã¦æ’®å½±';
        } else {
            box1.classList.remove('full-width');
            box2.style.display = 'flex';
            label1.innerText = 'ã‚ãªãŸ';
        }
        checkReady();
    }

    // ã‚«ãƒ¡ãƒ©é–¢é€£
    async function openCamera(targetNum) {
        activeTarget = targetNum;
        const modal = document.getElementById('camera-modal');
        const video = document.getElementById('video');
        
        try {
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" },
                audio: false
            });
            video.srcObject = videoStream;
            modal.style.display = 'block';
        } catch (err) {
            console.warn("ã‚«ãƒ¡ãƒ©èµ·å‹•å¤±æ•—:", err);
            document.getElementById('file-input').click(); // å¤±æ•—ã—ãŸã‚‰ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã¸
        }
    }

    function closeCamera() {
        const modal = document.getElementById('camera-modal');
        const video = document.getElementById('video');
        modal.style.display = 'none';
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            video.srcObject = null;
        }
    }

    function takePhoto() {
        const video = document.getElementById('video');
        if (!video.srcObject) return;

        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // åœ§ç¸®ã—ã¦ä¿å­˜
        processImage(canvas.toDataURL('image/jpeg', 0.8));
        closeCamera();
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    function handleFileSelect(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                // ã“ã“ã§ã‚‚activeTargetã‚’ä½¿ã†ï¼ˆæœ€å¾Œã«ã‚¿ãƒƒãƒ—ã—ãŸãƒœãƒƒã‚¯ã‚¹ï¼‰
                processImage(e.target.result);
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function processImage(originalBase64) {
        const img = new Image();
        img.onload = function() {
            const canvas = document.createElement('canvas');
            let w = img.width, h = img.height;
            const max = 800;
            if (w > h) { if (w > max) { h *= max/w; w = max; } } else { if (h > max) { w *= max/h; h = max; } }
            canvas.width = w; canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            const b64 = canvas.toDataURL('image/jpeg', 0.8);

            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã«ã‚»ãƒƒãƒˆ
            const previewId = (activeTarget === 1) ? 'preview1' : 'preview2';
            const placeholderId = (activeTarget === 1) ? 'ph1' : 'ph2';
            
            document.getElementById(previewId).src = b64;
            document.getElementById(previewId).style.display = 'block';
            document.getElementById(placeholderId).style.display = 'none';

            if (activeTarget === 1) img1Base64 = b64;
            else img2Base64 = b64;

            checkReady();
        };
        img.src = originalBase64;
    }

    function checkReady() {
        const btn = document.getElementById('analyze-btn');
        if (mode === 'single') btn.disabled = !img1Base64;
        else btn.disabled = (!img1Base64 || !img2Base64);
    }

    // çµæœè¡¨ç¤ºç”¨
    function stars(n) {
        let s = ""; for(let i=0; i<5; i++) s += (i<n) ? "â˜…" : "â˜†"; return s;
    }
    function createCard(title, score, points, color) {
        return `
        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name"><span class="color-dot" style="background:${color}; width:12px; height:12px; border-radius:50%; display:inline-block;"></span> ${title}</span>
                ${score ? `<span class="stars">${stars(score)}</span>` : ''}
            </div>
            <ul>${points.map(p => `<li>${p}</li>`).join('')}</ul>
        </div>`;
    }

    async function startAnalysis() {
        const btn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        btn.disabled = true;
        loading.style.display = 'flex';

        const b64_1 = img1Base64.replace(/^data:image\/\w+;base64,/, "");
        const b64_2 = img2Base64 ? img2Base64.replace(/^data:image\/\w+;base64,/, "") : null;

        let prompt = "";
        if (mode === 'single') {
            prompt = `
            æ‰‹ç›¸å ã„å¸«ã¨ã—ã¦ã€ç”»åƒã®æ‰‹ç›¸(${selectedHand === 'left' ? 'å·¦æ‰‹' : 'å³æ‰‹'})ã‚’åˆ†æã€‚
            7é …ç›®(æ„Ÿæƒ…,é ­è„³,ç”Ÿå‘½,é‹å‘½,å¤ªé™½,è²¡é‹,çµå©š)ã«ã¤ã„ã¦ã€ç‚¹æ•°(1-5)ã¨çŸ­ã„ç®‡æ¡æ›¸ãã§JSONå‡ºåŠ›ã€‚
            å£èª¿ã¯ãƒã‚¸ãƒ†ã‚£ãƒ–ã«ã€‚Format: {"heart": {"score":4, "points":["..."]}, ... "message":"..."}
            `;
        } else {
            prompt = `
            2ã¤ã®æ‰‹ç›¸ã‚’æ¯”è¼ƒã—ã€ã‚«ãƒƒãƒ—ãƒ«ã®ç›¸æ€§è¨ºæ–­ã‚’ã—ã¦ã€‚
            Format: {"score": 85, "compatibility_desc": "...", "points": ["..."], "advice": "..."}
            `;
        }

        try {
            const contents = [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: b64_1 } }] }];
            if (mode === 'pair') contents[0].parts.push({ inline_data: { mime_type: "image/jpeg", data: b64_2 } });

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: contents,
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            const res = JSON.parse(text.match(/\{[\s\S]*\}/)?.[0] || "{}");

            let html = "";
            const svg = document.getElementById('guide-svg');
            const handText = document.getElementById('hand-side-text');

            if (mode === 'single') {
                document.querySelector('.guide-container').style.display = 'block';
                // â˜… ã‚¬ã‚¤ãƒ‰å›³ã®åè»¢å‡¦ç† â˜…
                if (selectedHand === 'left') {
                    svg.classList.add('flip-svg');
                    handText.innerText = "å·¦æ‰‹";
                } else {
                    svg.classList.remove('flip-svg');
                    handText.innerText = "å³æ‰‹";
                }

                html += createCard("æ„Ÿæƒ…ç·š", res.heart?.score, res.heart?.points, "#ff4081");
                html += createCard("é ­è„³ç·š", res.head?.score, res.head?.points, "#448AFF");
                html += createCard("ç”Ÿå‘½ç·š", res.life?.score, res.life?.points, "#69F0AE");
                html += createCard("é‹å‘½ç·š", res.fate?.score, res.fate?.points, "#E040FB");
                html += createCard("å¤ªé™½ç·š", res.sun?.score, res.sun?.points, "#FFAB40");
                html += createCard("è²¡é‹ç·š", res.money?.score, res.money?.points, "#FFFF00");
                html += createCard("çµå©šç·š", res.marriage?.score, res.marriage?.points, "#FF5252");
                html += `<div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px;"><strong>ğŸ”® ç·åˆ:</strong> ${res.message}</div>`;
            } else {
                document.querySelector('.guide-container').style.display = 'none';
                html += `<div class="compatibility-score">ç›¸æ€§ ${res.score}%</div>`;
                html += `<div style="margin-bottom:20px;">${res.compatibility_desc}</div>`;
                html += createCard("è¨ºæ–­è©³ç´°", null, res.points, "#FFD700");
                html += `<div style="background:rgba(255,64,129,0.2); padding:15px; border-radius:10px;"><strong>ğŸ’˜ ã‚¢ãƒ‰ãƒã‚¤ã‚¹:</strong> ${res.advice}</div>`;
            }

            document.getElementById('result-content').innerHTML = html;
            document.getElementById('result-wrapper').style.display = 'block';
            document.querySelector('.upload-wrapper').style.display = 'none';
            btn.style.display = 'none';
            
            document.getElementById('result-wrapper').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    }

    function saveResultImage() {
        const target = document.getElementById("capture-target");
        const name = prompt("ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›", "æ‰‹ç›¸å ã„çµæœ");
        if (!name) return;
        html2canvas(target, { backgroundColor: "#10002b", scale: 2 }).then(canvas => {
            const link = document.createElement("a");
            link.href = canvas.toDataURL("image/png");
            link.download = `${name}.png`;
            link.click();
        });
    }
</script>
</body>
</html>