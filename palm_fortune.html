<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>âœ‹ AIæ‰‹ç›¸å ã„ V2</title>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #FFD700; /* ã‚´ãƒ¼ãƒ«ãƒ‰ */
            --bg: #1a0b2e; /* æ·±ã„ç´« */
            --card-bg: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
        }
        
        body {
            font-family: 'Shippori Mincho', serif;
            background: var(--bg);
            margin: 0; padding: 20px;
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 600px; margin: 0 auto;
            text-align: center; padding-bottom: 50px;
        }

        h1 {
            color: var(--primary); font-size: 2rem; margin-bottom: 10px;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .subtitle { font-size: 0.9rem; color: #b39ddb; margin-bottom: 30px; }

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ */
        .upload-area {
            position: relative; width: 100%; max-width: 300px; aspect-ratio: 3/4;
            margin: 0 auto 30px auto;
            border: 2px dashed var(--primary);
            border-radius: 20px;
            background: rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            overflow: hidden; cursor: pointer;
        }

        .upload-text { margin-top: 10px; color: var(--primary); font-weight: bold; }
        .upload-icon { font-size: 3rem; opacity: 0.8; }

        #preview-img {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover; display: none;
        }

        .btn-main {
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #1a0b2e; border: none; padding: 15px 50px;
            font-size: 1.2rem; font-weight: bold; border-radius: 50px;
            cursor: pointer; box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
            font-family: 'Shippori Mincho', serif;
            transition: transform 0.1s;
        }
        .btn-main:disabled { background: #555; color: #aaa; box-shadow: none; }
        .btn-main:active { transform: scale(0.95); }

        /* çµæœã‚¨ãƒªã‚¢ */
        #result-area { display: none; animation: fadeIn 1s ease; text-align: left; }

        /* æ’®å½±ã—ãŸå†™çœŸã®å†è¡¨ç¤º */
        .palm-display {
            width: 150px; height: 150px; margin: 0 auto 20px auto;
            border-radius: 50%; border: 3px solid var(--primary);
            overflow: hidden; box-shadow: 0 0 20px rgba(255,215,0,0.3);
        }
        .palm-display img { width: 100%; height: 100%; object-fit: cover; }

        .fortune-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 15px; padding: 20px;
            margin-bottom: 20px;
        }

        .line-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding-bottom: 10px; margin-bottom: 10px;
        }

        .line-name { font-size: 1.2rem; font-weight: bold; color: var(--primary); }
        
        .stars { color: #FFD700; letter-spacing: 2px; font-size: 1.2rem; }

        ul { margin: 0; padding-left: 20px; color: #e0e0e0; }
        li { margin-bottom: 8px; line-height: 1.6; }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(26, 11, 46, 0.95); z-index: 100;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
        .crystal-ball { font-size: 4rem; animation: glow 1.5s infinite alternate; margin-bottom: 20px; }
        .loading-msg { color: var(--primary); font-size: 1.2rem; }

        @keyframes glow { from { opacity: 0.5; transform: scale(0.9); } to { opacity: 1; transform: scale(1.1); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .modal { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: #1a0b2e; padding: 30px; border-radius: 20px; width: 85%; max-width: 400px; text-align: center; border: 1px solid var(--primary); }
        .input-key { width: 90%; padding: 12px; margin: 20px 0; border: 1px solid var(--primary); background: #0f0518; color: white; border-radius: 5px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="key-modal" class="modal">
    <div class="modal-content">
        <h2>ğŸ”‘ é‹å‘½ã®éµ</h2>
        <p>API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
        <input type="password" id="api-key-input" class="input-key" placeholder="Paste API Key here">
        <button class="btn-main" onclick="saveApiKey()">é‘‘å®šã¸é€²ã‚€</button>
    </div>
</div>

<div id="loading" class="loading-overlay">
    <div class="crystal-ball">ğŸ”®</div>
    <div class="loading-msg">æ‰‹ç›¸ã‚’è§£æä¸­...</div>
</div>

<div class="container">
    <h1>âœ‹ AIæ‰‹ç›¸å ã„ V2</h1>
    <div class="subtitle">å†™çœŸã‹ã‚‰é‹å‘½ã‚’ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°</div>

    <div class="upload-area" onclick="document.getElementById('camera-input').click()">
        <div id="placeholder">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">æ‰‹ç›¸ã‚’æ’®å½±ã™ã‚‹</div>
        </div>
        <img id="preview-img">
        <input type="file" id="camera-input" accept="image/*" style="display: none" onchange="handleFile(this)">
    </div>

    <button id="analyze-btn" class="btn-main" onclick="analyzePalm()" disabled>é‘‘å®šã™ã‚‹</button>

    <div id="result-area">
        <div style="text-align: center; margin: 30px 0;">
            <div class="palm-display"><img id="result-palm-img"></div>
            <div style="font-size: 1.5rem; color: var(--primary);">âœ¨ é‘‘å®šæ›¸ âœ¨</div>
        </div>

        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name">â¤ï¸ æ„Ÿæƒ…ç·š</span>
                <span class="stars" id="star-heart">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <ul id="list-heart">
                <li>åˆ†æä¸­...</li>
            </ul>
        </div>

        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name">ğŸ§  é ­è„³ç·š</span>
                <span class="stars" id="star-head">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <ul id="list-head">
                <li>åˆ†æä¸­...</li>
            </ul>
        </div>

        <div class="fortune-card">
            <div class="line-header">
                <span class="line-name">ğŸŒ± ç”Ÿå‘½ç·š</span>
                <span class="stars" id="star-life">â˜…â˜…â˜…â˜…â˜…</span>
            </div>
            <ul id="list-life">
                <li>åˆ†æä¸­...</li>
            </ul>
        </div>

        <div class="fortune-card" style="border-color: #ff4081;">
            <div class="line-header">
                <span class="line-name">ğŸ”® ç·åˆé‹ & ã‚¢ãƒ‰ãƒã‚¤ã‚¹</span>
            </div>
            <div style="line-height: 1.8;" id="text-overall">
                åˆ†æä¸­...
            </div>
        </div>

        <button class="btn-main" style="background:#555; color:white; margin-top:20px;" onclick="location.reload()">ã‚‚ã†ä¸€åº¦å ã†</button>
    </div>
</div>

<script>
    let API_KEY = "";
    const GEMINI_MODEL = "gemini-2.5-flash"; // ãƒ¢ãƒ‡ãƒ«æŒ‡å®š
    let currentImageBase64 = null;

    window.onload = function() { checkApiKey(); };

    function checkApiKey() {
        const stored = localStorage.getItem('gemini_api_key_palm');
        if (stored) {
            API_KEY = stored;
            document.getElementById('key-modal').classList.add('hidden');
        }
    }
    function saveApiKey() {
        const key = document.getElementById('api-key-input').value.trim();
        if (key) {
            API_KEY = key;
            localStorage.setItem('gemini_api_key_palm', key);
            document.getElementById('key-modal').classList.add('hidden');
        }
    }

    function handleFile(input) {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 800; // åœ§ç¸®
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
                    else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    currentImageBase64 = canvas.toDataURL('image/jpeg', 0.8);
                    
                    const preview = document.getElementById('preview-img');
                    preview.src = currentImageBase64;
                    preview.style.display = 'block';
                    document.getElementById('result-palm-img').src = currentImageBase64; // çµæœç”»é¢ç”¨ã«ã‚‚ã‚»ãƒƒãƒˆ
                    document.getElementById('placeholder').style.display = 'none';
                    document.getElementById('analyze-btn').disabled = false;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
    }

    // æ˜Ÿã®ç”Ÿæˆé–¢æ•°
    function renderStars(score) {
        // scoreã¯1ã€œ5
        let stars = "";
        for(let i=0; i<5; i++) {
            stars += (i < score) ? "â˜…" : "â˜†";
        }
        return stars;
    }

    // ãƒªã‚¹ãƒˆã®ç”Ÿæˆé–¢æ•°
    function renderList(items) {
        return items.map(item => `<li>${item}</li>`).join('');
    }

    async function analyzePalm() {
        if (!currentImageBase64) return;

        const btn = document.getElementById('analyze-btn');
        const loading = document.getElementById('loading');
        
        btn.disabled = true;
        loading.style.display = 'flex';

        const cleanBase64 = currentImageBase64.replace(/^data:image\/\w+;base64,/, "");

        // â˜… ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå¤‰æ›´ï¼šJSONã§ç‚¹æ•°ã¨ç®‡æ¡æ›¸ãã‚’è¦æ±‚
        const prompt = `
        ã‚ãªãŸã¯ãƒ—ãƒ­ã®æ‰‹ç›¸å ã„å¸«ã§ã™ã€‚æä¾›ã•ã‚ŒãŸæ‰‹ã®ã²ã‚‰ã®å†™çœŸã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚
        ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã€å„ç·šã®è©•ä¾¡ï¼ˆ1ã€œ5ç‚¹ï¼‰ã¨ã€ãã®ç‰¹å¾´ã‚’çŸ­ã„ç®‡æ¡æ›¸ãï¼ˆ3ã¤ç¨‹åº¦ï¼‰ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
        
        ã€æ¡ä»¶ã€‘
        - ç®‡æ¡æ›¸ãã¯ã€Œã€œãªå‚¾å‘ãŒã‚ã‚‹ã€ã€Œã€œã®ç›¸ãŒå‡ºã¦ã„ã‚‹ã€ãªã©çŸ­ãã€‚
        - ç·åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¯ã€å°‘ã—ãƒŸã‚¹ãƒ†ãƒªã‚¢ã‚¹ã‹ã¤å‰å‘ãã«ã€‚

        Format (JSON):
        {
            "heart_line": {
                "score": 4,
                "points": ["ç·šãŒé•·ãã€æ„›æƒ…æ·±ã„ã‚¿ã‚¤ãƒ—", "å…ˆç«¯ãŒåˆ†ã‹ã‚Œã¦ãŠã‚Šæ°—é…ã‚Šä¸Šæ‰‹", "å°‘ã—æ„Ÿæƒ…ã®èµ·ä¼ãŒæ¿€ã—ã„ã‹ã‚‚"]
            },
            "head_line": {
                "score": 5,
                "points": ["ç†çŸ¥çš„ã§åˆ¤æ–­ãŒé€Ÿã„", "ç†ç³»çš„ãªæ‰èƒ½ã®ç›¸ã‚ã‚Š", "ç¾å®Ÿä¸»ç¾©ãªä¸€é¢ã‚‚"]
            },
            "life_line": {
                "score": 3,
                "points": ["ä½“åŠ›ã¯ã‚ã‚‹ãŒç–²ã‚Œã‚„ã™ã„", "ä¸è¦å‰‡ãªç”Ÿæ´»ã«æ³¨æ„", "ç”Ÿå‘½åŠ›ã¯æ—ºç››"]
            },
            "overall_advice": "ã“ã“æœ€è¿‘é‹æ°—ãŒä¸Šæ˜‡ã—ã¦ã„ã¾ã™ã€‚ç‰¹ã«..."
        }
        `;

        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inline_data: { mime_type: "image/jpeg", data: cleanBase64 } }
                        ]
                    }],
                    safetySettings: [
                        { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                        { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
                    ]
                })
            });

            const data = await response.json();
            
            if (data.error) throw new Error(data.error.message);
            
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) throw new Error("è§£æã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");

            // JSONãƒ‘ãƒ¼ã‚¹
            const jsonStr = text.match(/\{[\s\S]*\}/)?.[0];
            const result = JSON.parse(jsonStr || "{}");

            // UIåæ˜ 
            if(result.heart_line) {
                document.getElementById('star-heart').innerText = renderStars(result.heart_line.score);
                document.getElementById('list-heart').innerHTML = renderList(result.heart_line.points);
            }
            if(result.head_line) {
                document.getElementById('star-head').innerText = renderStars(result.head_line.score);
                document.getElementById('list-head').innerHTML = renderList(result.head_line.points);
            }
            if(result.life_line) {
                document.getElementById('star-life').innerText = renderStars(result.life_line.score);
                document.getElementById('list-life').innerHTML = renderList(result.life_line.points);
            }
            if(result.overall_advice) {
                document.getElementById('text-overall').innerText = result.overall_advice;
            }

            document.getElementById('result-area').style.display = 'block';
            document.querySelector('.upload-area').style.display = 'none';
            btn.style.display = 'none';
            
            document.getElementById('result-area').scrollIntoView({behavior: 'smooth'});

        } catch (e) {
            alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
        } finally {
            loading.style.display = 'none';
            btn.disabled = false;
        }
    }
</script>
</body>
</html>