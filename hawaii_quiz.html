<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸï¸ ãƒãƒ¯ã‚¤è‹±ä¼šè©±ã‚¯ã‚¤ã‚º - Enhanced Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .score {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ */
        .menu-screen {
            padding: 30px;
        }
        
        .menu-title {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .mode-card {
            padding: 25px 15px;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-card:hover {
            border-color: #11998e;
            box-shadow: 0 4px 12px rgba(17,153,142,0.3);
            transform: translateY(-2px);
        }
        
        .mode-card.active {
            border-color: #11998e;
            background: linear-gradient(135deg, #e8f5f3 0%, #d4f1e8 100%);
        }
        
        .mode-icon {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .mode-title {
            font-size: 16px;
            font-weight: bold;
            color: #212529;
        }
        
        .menu-grid {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .menu-grid.scene-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .menu-grid.level-grid {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .menu-btn {
            padding: 15px 10px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .menu-btn:hover {
            border-color: #11998e;
            box-shadow: 0 4px 12px rgba(17,153,142,0.2);
        }
        
        .menu-btn-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 3px;
            color: #212529;
        }
        
        .menu-btn-desc {
            font-size: 12px;
            color: #6c757d;
        }
        
        .menu-btn.active {
            border-color: #11998e;
            background: linear-gradient(135deg, #e8f5f3 0%, #d4f1e8 100%);
        }
        
        .start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }
        
        .start-btn:active {
            transform: scale(0.98);
        }
        
        .stats-btn {
            width: 100%;
            padding: 15px;
            background: #f8f9fa;
            color: #212529;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.3s;
        }
        
        .stats-btn:hover {
            background: #e9ecef;
        }
        
        /* ã‚¯ã‚¤ã‚ºç”»é¢ */
        .content {
            padding: 30px;
        }
        
        .scene-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .level-badge {
            display: inline-block;
            background: #ffc107;
            color: #000;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .question-box {
            background: #f8f9fa;
            border-left: 5px solid #11998e;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .japanese-text {
            font-size: 22px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 10px;
        }
        
        .context-box {
            background: #e7f6fd;
            border-left: 4px solid #0dcaf0;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 15px;
            color: #0a5568;
            display: none;
        }
        
        .context-box.show {
            display: block;
        }
        
        .context-box::before {
            content: 'ğŸ’¡ ';
            font-size: 16px;
        }
        
        .hint-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        
        .hint-btn {
            background: #ffc107;
            color: #000;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .hint-btn:active {
            transform: scale(0.95);
        }
        
        .hint {
            font-size: 14px;
            color: #6c757d;
            font-style: italic;
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 8px;
            animation: slideIn 0.3s;
        }
        
        .speak-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
            flex: 1;
            min-width: 120px;
        }
        
        .speak-btn:active {
            transform: scale(0.95);
        }
        
        .show-answer-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        
        .show-answer-btn:active {
            transform: scale(0.95);
        }
        
        .answer-display {
            font-size: 18px;
            color: #f5576c;
            font-weight: bold;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #fff0f3 0%, #ffe8ec 100%);
            border-radius: 10px;
            border-left: 5px solid #f5576c;
            animation: slideIn 0.3s;
            text-align: center;
        }
        
        .speak-btn.speaking {
            animation: pulse 1s infinite;
        }
        
        .input-wrapper {
            position: relative;
            margin-bottom: 15px;
        }
        
        .answer-input {
            width: 100%;
            padding: 15px 45px 15px 15px;
            font-size: 18px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            transition: all 0.3s;
            min-height: 85px;
            line-height: 1.5;
            resize: vertical;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 0 3px rgba(17,153,142,0.1);
        }
        
        .clear-btn {
            position: absolute;
            right: 10px;
            top: 15px;
            background: #dc3545;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .clear-btn.show {
            display: flex;
        }
        
        .clear-btn:active {
            transform: scale(0.9);
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn {
            padding: 18px 10px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-direction: column;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .check-answer-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .btn-check {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-size: 18px;
            flex-direction: row;
            padding: 22px;
            box-shadow: 0 4px 12px rgba(17,153,142,0.3);
        }
        
        .btn-check:hover {
            box-shadow: 0 6px 16px rgba(17,153,142,0.4);
            transform: translateY(-2px);
        }
        
        .btn-show-answer {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 16px;
            flex-direction: row;
            padding: 22px 10px;
            box-shadow: 0 4px 12px rgba(245,87,108,0.3);
        }
        
        .btn-show-answer:hover {
            box-shadow: 0 6px 16px rgba(245,87,108,0.4);
            transform: translateY(-2px);
        }
        
        .btn-voice {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
        }
        
        .btn-next {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
            color: white;
        }
        
        .btn-prev {
            background: linear-gradient(135deg, #fc4a1a 0%, #f7b733 100%);
            color: white;
        }
        
        .btn-menu {
            background: #6c757d;
            color: white;
            grid-column: 1 / -1;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .recording {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        .result {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .result.correct {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .result.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }
        
        .correct-answer {
            margin-top: 10px;
            font-size: 18px;
            color: #28a745;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #11998e;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ç”»é¢ */
        .speaking-screen {
            padding: 30px;
        }
        
        .speaking-title {
            font-size: 22px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .speaking-phrase {
            background: linear-gradient(135deg, #e8f5f3 0%, #d4f1e8 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #11998e;
        }
        
        .speaking-japanese {
            font-size: 20px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 15px;
        }
        
        .speaking-english {
            font-size: 18px;
            color: #11998e;
            font-weight: bold;
        }
        
        .recognition-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            min-height: 80px;
            border: 2px dashed #dee2e6;
            text-align: center;
        }
        
        .recognition-text {
            font-size: 18px;
            color: #212529;
            font-weight: bold;
        }
        
        .recognition-placeholder {
            font-size: 16px;
            color: #6c757d;
            font-style: italic;
        }
        
        .score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .score-value {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .score-label {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .practice-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .practice-btn {
            padding: 18px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        
        .practice-btn-record {
            background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);
            color: white;
            grid-column: 1 / -1;
        }
        
        .practice-btn-listen {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .practice-btn-next {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* AIãƒãƒ£ãƒƒãƒˆç”»é¢ */
        .aichat-screen {
            padding: 30px;
        }
        
        .aichat-title {
            font-size: 22px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .aichat-setup {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .aichat-setup h3 {
            font-size: 16px;
            color: #495057;
            margin-bottom: 10px;
        }
        
        .aichat-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .aichat-option {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-size: 14px;
        }
        
        .aichat-option:hover {
            border-color: #11998e;
            box-shadow: 0 2px 8px rgba(17,153,142,0.2);
        }
        
        .aichat-option.active {
            border-color: #11998e;
            background: linear-gradient(135deg, #e8f5f3 0%, #d4f1e8 100%);
            font-weight: bold;
        }
        
        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 12px;
            animation: slideIn 0.3s;
        }
        
        .chat-message.ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-right: 40px;
        }
        
        .chat-message.user {
            background: #e9ecef;
            color: #212529;
            margin-left: 40px;
            text-align: right;
        }
        
        .chat-input-wrapper {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .chat-input {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .chat-send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* çµæœç”»é¢ */
        .result-screen {
            padding: 30px;
            text-align: center;
        }
        
        .result-title {
            font-size: 28px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 20px;
        }
        
        .result-emoji {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .result-stats {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .result-stat-item {
            margin: 15px 0;
            font-size: 18px;
        }
        
        .result-stat-label {
            color: #6c757d;
        }
        
        .result-stat-value {
            font-weight: bold;
            color: #11998e;
            font-size: 24px;
        }
        
        /* çµ±è¨ˆç”»é¢ */
        .stats-screen {
            padding: 30px;
        }
        
        .stats-title {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .stats-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }
        
        .stats-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .stats-card-value {
            font-size: 32px;
            font-weight: bold;
            color: #11998e;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .reset-btn {
            width: 100%;
            padding: 15px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 600px) {
            .header h1 {
                font-size: 20px;
            }
            
            .japanese-text {
                font-size: 18px;
            }
            
            .answer-input {
                font-size: 16px;
            }
            
            .btn {
                font-size: 13px;
                padding: 15px 8px;
            }
            
            .btn-check {
                font-size: 16px;
                padding: 20px;
            }
            
            .btn-show-answer {
                font-size: 14px;
                padding: 20px 8px;
            }
            
            .check-answer-row {
                grid-template-columns: 1.5fr 1fr;
            }
            
            .result-emoji {
                font-size: 60px;
            }
            
            .menu-btn-title {
                font-size: 14px;
            }
            
            .menu-btn-desc {
                font-size: 11px;
            }
            
            .mode-icon {
                font-size: 32px;
            }
            
            .mode-title {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸï¸ ãƒãƒ¯ã‚¤è‹±ä¼šè©±ãƒ¬ãƒƒã‚¹ãƒ³</h1>
            <div class="score" id="scoreDisplay">
                ã‚¹ã‚³ã‚¢: <span id="score">0</span> / <span id="total">0</span>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å•é¡Œ 0 / 10</div>
        </div>
        
        <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div class="menu-screen" id="mainMenu">
            <div class="menu-title">ğŸ“š ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ</div>
            
            <div class="mode-selection">
                <div class="mode-card active" data-mainmode="quiz" onclick="selectMainMode('quiz')">
                    <div class="mode-icon">ğŸ“</div>
                    <div class="mode-title">ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰</div>
                </div>
                <div class="mode-card" data-mainmode="speaking" onclick="selectMainMode('speaking')">
                    <div class="mode-icon">ğŸ¤</div>
                    <div class="mode-title">ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’</div>
                </div>
                <div class="mode-card" data-mainmode="aichat" onclick="selectMainMode('aichat')">
                    <div class="mode-icon">ğŸ¤–</div>
                    <div class="mode-title">AIãƒãƒ£ãƒƒãƒˆ</div>
                </div>
            </div>
            
            <div id="quizSettings">
                <div class="menu-title">ğŸ¯ ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ</div>
                
                <div class="menu-grid scene-grid">
                    <div class="menu-btn active" data-mode="random" onclick="selectScene('random')">
                        <div class="menu-btn-title">ğŸ”€ ãƒ©ãƒ³ãƒ€ãƒ </div>
                        <div class="menu-btn-desc">å…¨ã‚·ãƒ¼ãƒ³ã‹ã‚‰å‡ºé¡Œ</div>
                    </div>
                    <div class="menu-btn" data-mode="frequent" onclick="selectScene('frequent')">
                        <div class="menu-btn-title">ğŸ’¡ é »å‡º</div>
                        <div class="menu-btn-desc">ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚º</div>
                    </div>
                    <div class="menu-btn" data-mode="airport" onclick="selectScene('airport')">
                        <div class="menu-btn-title">âœˆï¸ ç©ºæ¸¯</div>
                        <div class="menu-btn-desc">å…¥å›½å¯©æŸ»ã€è·ç‰©å—å–</div>
                    </div>
                    <div class="menu-btn" data-mode="hotel" onclick="selectScene('hotel')">
                        <div class="menu-btn-title">ğŸ¨ ãƒ›ãƒ†ãƒ«</div>
                        <div class="menu-btn-desc">ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã€ã‚µãƒ¼ãƒ“ã‚¹</div>
                    </div>
                    <div class="menu-btn" data-mode="dining" onclick="selectScene('dining')">
                        <div class="menu-btn-title">ğŸ½ï¸ é£Ÿäº‹</div>
                        <div class="menu-btn-desc">æ³¨æ–‡ã€ä¼šè¨ˆ</div>
                    </div>
                    <div class="menu-btn" data-mode="shopping" onclick="selectScene('shopping')">
                        <div class="menu-btn-title">ğŸ›ï¸ è²·ã„ç‰©</div>
                        <div class="menu-btn-desc">è©¦ç€ã€æ”¯æ‰•ã„</div>
                    </div>
                    <div class="menu-btn" data-mode="transport" onclick="selectScene('transport')">
                        <div class="menu-btn-title">ğŸš— äº¤é€š</div>
                        <div class="menu-btn-desc">ãƒã‚¹ã€ã‚¿ã‚¯ã‚·ãƒ¼</div>
                    </div>
                    <div class="menu-btn" data-mode="emergency" onclick="selectScene('emergency')">
                        <div class="menu-btn-title">ğŸ†˜ ç·Šæ€¥</div>
                        <div class="menu-btn-desc">ç—…æ°—ã€ãƒˆãƒ©ãƒ–ãƒ«</div>
                    </div>
                    <div class="menu-btn" data-mode="smalltalk" onclick="selectScene('smalltalk')">
                        <div class="menu-btn-title">ğŸ’¬ ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯</div>
                        <div class="menu-btn-desc">æ—¥å¸¸ä¼šè©±</div>
                    </div>
                </div>
                
                <div class="menu-title" style="margin-top: 20px;">ğŸ“Š ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</div>
                <div class="menu-grid level-grid">
                    <div class="menu-btn active" data-level="all" onclick="selectLevel('all')">
                        <div class="menu-btn-title">ğŸŒŸ å…¨ã¦</div>
                    </div>
                    <div class="menu-btn" data-level="beginner" onclick="selectLevel('beginner')">
                        <div class="menu-btn-title">ğŸŸ¢ åˆç´š</div>
                    </div>
                    <div class="menu-btn" data-level="advanced" onclick="selectLevel('advanced')">
                        <div class="menu-btn-title">ğŸ”´ ä¸Šç´š</div>
                    </div>
                </div>
            </div>
            
            <button class="start-btn" onclick="startMode()">é–‹å§‹ ğŸš€</button>
            <button class="stats-btn" onclick="showStats()">ğŸ“Š å­¦ç¿’çµ±è¨ˆã‚’è¦‹ã‚‹</button>
        </div>
        
        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div class="content hidden" id="quizScreen">
            <div class="scene-badge" id="scene">ç©ºæ¸¯ âœˆï¸</div>
            <span class="level-badge" id="levelBadge">åˆç´š</span>
            
            <div class="question-box">
                <div class="japanese-text" id="japanese">ãƒã‚±ãƒƒãƒˆ2æšãŠé¡˜ã„ã—ã¾ã™</div>
                <div class="context-box" id="contextBox"></div>
                <div class="hint-container">
                    <button class="hint-btn" id="hintBtn" onclick="toggleHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</button>
                    <button class="speak-btn" id="speakBtn" onclick="speakAnswer()">ğŸ”Š æ­£è§£ã‚’èã</button>
                    <button class="speak-btn" id="speakSlowBtn" onclick="speakAnswerSlow()" style="background: #17a2b8;">ğŸ¢ ã‚†ã£ãã‚Šèã</button>
                    <div id="hintBox" class="hidden"></div>
                </div>
            </div>
            
            <div id="resultBox" class="hidden"></div>
            
            <div class="input-wrapper">
                <textarea 
                    id="answerInput" 
                    class="answer-input" 
                    placeholder="è‹±èªã§ç­”ãˆã¦ãã ã•ã„..."
                    autocomplete="off"
                    rows="2"
                ></textarea>
                <button class="clear-btn" id="clearBtn" onclick="clearInput()">Ã—</button>
            </div>
            
            <div class="check-answer-row">
                <button class="btn btn-check" id="checkBtn" onclick="checkAnswer()">
                    âœ“ å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯
                </button>
                <button class="btn btn-show-answer" id="showAnswerBtn" onclick="toggleAnswer()">
                    ğŸ‘ï¸ æ­£è§£ã‚’è¦‹ã‚‹
                </button>
            </div>
            
            <div id="answerBox" class="answer-display hidden"></div>
            
            <div class="button-group">
                <button class="btn btn-prev" id="prevBtn" onclick="previousQuestion()">
                    <span>â¬…ï¸</span>
                    <span>å‰ã®å•é¡Œ</span>
                </button>
                <button class="btn btn-voice" id="voiceBtn" onclick="toggleVoiceInput()">
                    <span id="voiceIcon">ğŸ¤</span>
                    <span id="voiceText">éŸ³å£°å…¥åŠ›</span>
                </button>
                <button class="btn btn-next" id="nextBtn" onclick="nextQuestion()">
                    <span>â¡ï¸</span>
                    <span>æ¬¡ã®å•é¡Œ</span>
                </button>
            </div>
            
            <button class="btn btn-menu" onclick="returnToMenu()">
                ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
            </button>
            
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="correct">0</div>
                    <div class="stat-label">æ­£è§£</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="incorrect">0</div>
                    <div class="stat-label">ä¸æ­£è§£</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="accuracy">0%</div>
                    <div class="stat-label">æ­£è§£ç‡</div>
                </div>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ç”»é¢ -->
        <div class="speaking-screen hidden" id="speakingScreen">
            <div class="speaking-title">ğŸ¤ ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’</div>
            
            <div class="speaking-phrase">
                <div class="speaking-japanese" id="speakingJapanese">ä¼‘æš‡ã§ã™</div>
                <div class="speaking-english" id="speakingEnglish">Vacation.</div>
            </div>
            
            <div class="recognition-box">
                <div class="recognition-placeholder" id="recognitionPlaceholder">ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦è©±ã—ã¦ãã ã•ã„</div>
                <div class="recognition-text hidden" id="recognitionText"></div>
            </div>
            
            <div class="score-display hidden" id="scoreDisplay2">
                <div class="score-label">ç™ºéŸ³ã‚¹ã‚³ã‚¢</div>
                <div class="score-value" id="scoreValue">0</div>
                <div class="score-label" id="scoreMessage">éŒ²éŸ³ã—ã¦ãã ã•ã„</div>
            </div>
            
            <div class="practice-buttons">
                <button class="practice-btn practice-btn-record" id="recordBtn" onclick="togglePracticeRecording()">
                    <span id="recordIcon">ğŸ¤</span>
                    <span id="recordText">éŒ²éŸ³é–‹å§‹</span>
                </button>
                <button class="practice-btn practice-btn-listen" onclick="speakPracticeAnswer()">
                    ğŸ”Š ãŠæ‰‹æœ¬ã‚’èã
                </button>
                <button class="practice-btn practice-btn-next" onclick="nextPracticePhrase()">
                    â¡ï¸ æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ã‚º
                </button>
            </div>
            
            <button class="btn btn-menu" onclick="returnToMenu()">
                ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
            </button>
        </div>
        
        <!-- AIãƒãƒ£ãƒƒãƒˆç”»é¢ -->
        <div class="aichat-screen hidden" id="aichatScreen">
            <div class="aichat-title">ğŸ¤– AIãƒãƒ£ãƒƒãƒˆç·´ç¿’</div>
            
            <div class="aichat-setup" id="aichatSetup">
                <h3>ğŸ¬ ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ</h3>
                <div class="aichat-options">
                    <div class="aichat-option active" data-aiscene="freetalk" onclick="selectAIScene('freetalk')">ğŸŒŸ ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯</div>
                    <div class="aichat-option" data-aiscene="airport" onclick="selectAIScene('airport')">âœˆï¸ ç©ºæ¸¯</div>
                    <div class="aichat-option" data-aiscene="hotel" onclick="selectAIScene('hotel')">ğŸ¨ ãƒ›ãƒ†ãƒ«</div>
                    <div class="aichat-option" data-aiscene="restaurant" onclick="selectAIScene('restaurant')">ğŸ½ï¸ ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</div>
                    <div class="aichat-option" data-aiscene="shopping" onclick="selectAIScene('shopping')">ğŸ›ï¸ ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</div>
                    <div class="aichat-option" data-aiscene="sightseeing" onclick="selectAIScene('sightseeing')">ğŸŒº è¦³å…‰</div>
                </div>
                
                <h3 style="margin-top: 15px;">ğŸ“Š ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</h3>
                <div class="aichat-options">
                    <div class="aichat-option" data-ailevel="beginner" onclick="selectAILevel('beginner')">ğŸŸ¢ åˆå¿ƒè€…</div>
                    <div class="aichat-option active" data-ailevel="intermediate" onclick="selectAILevel('intermediate')">ğŸŸ¡ ä¸­ç´šè€…</div>
                    <div class="aichat-option" data-ailevel="advanced" onclick="selectAILevel('advanced')">ğŸ”´ ä¸Šç´šè€…</div>
                </div>
                
                <button class="start-btn" style="margin-top: 15px;" onclick="startAIChat()">ä¼šè©±ã‚’é–‹å§‹ ğŸš€</button>
            </div>
            
            <div id="aichatActive" class="hidden">
                <div class="chat-container" id="chatContainer">
                    <div class="chat-message ai">
                        ã“ã‚“ã«ã¡ã¯!ä¼šè©±ã‚’å§‹ã‚ã¾ã—ã‚‡ã† ğŸ˜Š
                    </div>
                </div>
                
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                    <button class="chat-send-btn" onclick="sendChatMessage()">é€ä¿¡</button>
                </div>
                
                <button class="btn btn-menu" onclick="returnToMenu()">
                    ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
                </button>
            </div>
        </div>
        
        <!-- çµæœç”»é¢ -->
        <div class="result-screen hidden" id="resultScreen">
            <div class="result-emoji" id="resultEmoji">ğŸ‰</div>
            <div class="result-title" id="resultTitle">ã‚¯ã‚¤ã‚ºå®Œäº†!</div>
            
            <div class="result-stats">
                <div class="result-stat-item">
                    <div class="result-stat-label">æ­£è§£æ•°</div>
                    <div class="result-stat-value" id="finalCorrect">0</div>
                </div>
                <div class="result-stat-item">
                    <div class="result-stat-label">ä¸æ­£è§£æ•°</div>
                    <div class="result-stat-value" id="finalIncorrect">0</div>
                </div>
                <div class="result-stat-item">
                    <div class="result-stat-label">æ­£è§£ç‡</div>
                    <div class="result-stat-value" id="finalAccuracy">0%</div>
                </div>
            </div>
            
            <button class="start-btn" onclick="startMode()">ã‚‚ã†ä¸€åº¦ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ğŸ”„</button>
            <button class="stats-btn" onclick="returnToMenu()">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
        </div>
        
        <!-- çµ±è¨ˆç”»é¢ -->
        <div class="stats-screen hidden" id="statsScreen">
            <div class="stats-title">ğŸ“Š å­¦ç¿’çµ±è¨ˆ</div>
            
            <div class="stats-card">
                <div class="stats-card-title">ç·å­¦ç¿’å›æ•°</div>
                <div class="stats-card-value" id="totalSessions">0</div>
            </div>
            
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-card-title">ç·æ­£è§£æ•°</div>
                    <div class="stats-card-value" id="totalCorrectStats">0</div>
                </div>
                <div class="stats-card">
                    <div class="stats-card-title">ç·å•é¡Œæ•°</div>
                    <div class="stats-card-value" id="totalQuestionsStats">0</div>
                </div>
            </div>
            
            <div class="stats-card">
                <div class="stats-card-title">å¹³å‡æ­£è§£ç‡</div>
                <div class="stats-card-value" id="averageAccuracy">0%</div>
            </div>
            
            <button class="start-btn" onclick="returnToMenu()">ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            <button class="reset-btn" onclick="resetStats()">çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
    </div>

    <script>
        // ============================================
        // ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆhawaii-phrases-å…¨ã¾ã¨ã‚æ›´æ–°å®Œäº†ç‰ˆ.htmlã‹ã‚‰æŠ½å‡ºï¼‰
        // ============================================
const phrasesDatabase = {
    frequent: [
        // Can I ãƒ‘ã‚¿ãƒ¼ãƒ³
        { japanese: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„', english: 'Can I have a menu?', hint: 'Can I have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§' },
        { japanese: 'è©¦ç€ã—ã¦ã‚‚ã„ã„ã§ã™ã‹?', english: 'Can I try it on?', hint: 'Can I try ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ãŠåº—ã§æ´‹æœã‚’è¦‹ã¦ã„ã‚‹ã¨ã' },
        { japanese: 'ã‚«ãƒ¼ãƒ‰ã§æ‰•ãˆã¾ã™ã‹?', english: 'Can I pay by card?', hint: 'Can I pay ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ãŠä¼šè¨ˆã®ã¨ã' },
        { japanese: 'å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã„ã„ã§ã™ã‹?', english: 'Can I take a photo?', hint: 'Can I take ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒŠãƒ—ã‚­ãƒ³ã‚’è¿½åŠ ã§ã‚‚ã‚‰ãˆã¾ã™ã‹?', english: 'Can I get extra napkins?', hint: 'Can I get ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã“ã®ã‚¯ãƒ¼ãƒãƒ³ã¯ä½¿ãˆã¾ã™ã‹?', english: 'Can I use this coupon?', hint: 'Can I use ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        // Please ãƒ‘ã‚¿ãƒ¼ãƒ³
        { japanese: 'ã“ã‚Œã‚’ãŠé¡˜ã„ã—ã¾ã™', english: 'This one, please.', hint: '3èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'æŒ‡å·®ã—ãªãŒã‚‰' },
        { japanese: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', english: 'Check, please.', hint: '2èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§' },
        { japanese: 'ãƒã‚±ãƒƒãƒˆ2æšãŠé¡˜ã„ã—ã¾ã™', english: 'Two tickets, please.', hint: 'Two tickets ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'æ°·æŠœãã§ãŠé¡˜ã„ã—ã¾ã™', english: 'No ice, please.', hint: 'No ice ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ãƒ‰ãƒªãƒ³ã‚¯ã‚’æ³¨æ–‡ã™ã‚‹ã¨ã' },
        { japanese: 'æŒã¡å¸°ã‚Šã§ãŠé¡˜ã„ã—ã¾ã™', english: 'To go, please.', hint: 'To go ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰åº—ã§' },
        { japanese: 'èµ¤ã„ã®ã‚’ãŠé¡˜ã„ã—ã¾ã™', english: 'Red one, please.', hint: 'Red one ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        // I'm ãƒ‘ã‚¿ãƒ¼ãƒ³
        { japanese: 'ãŠè…¹ãŒã™ã„ã¦ã„ã¾ã™', english: "I'm hungry.", hint: "I'm hungry ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'å–‰ãŒæ¸‡ã„ã¦ã„ã¾ã™', english: "I'm thirsty.", hint: "I'm thirsty ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'ãŠè…¹ã„ã£ã±ã„ã§ã™', english: "I'm full.", hint: "I'm full ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'ä½“èª¿ãŒæ‚ªã„ã§ã™', english: "I'm not feeling well.", hint: "I'm not ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'é“ã«è¿·ã„ã¾ã—ãŸ', english: "I'm lost.", hint: "I'm lost ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'â—‹â—‹ã‚’æ¢ã—ã¦ã„ã¾ã™', english: "I'm looking for â—‹â—‹.", hint: "I'm looking ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner', context: 'ä½•ã‹ã‚’æ¢ã—ã¦ã„ã‚‹ã¨ã' },
        // It's ãƒ‘ã‚¿ãƒ¼ãƒ³
        { japanese: 'æš‘ã„ã§ã™', english: "It's hot.", hint: "It's hot ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'å¯’ã„ã§ã™', english: "It's cold.", hint: "It's cold ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'ç¾å‘³ã—ã„ã§ã™', english: "It's delicious.", hint: "It's delicious ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        // ãã®ä»–ã®é »å‡º
        { japanese: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹?', english: 'Where is the bathroom?', hint: 'Where is ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã“ã‚Œã¯ã„ãã‚‰ã§ã™ã‹?', english: 'How much is this?', hint: 'How much ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'WiFiã¯ã‚ã‚Šã¾ã™ã‹?', english: 'Do you have WiFi?', hint: 'Do you have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã¯ã„ã€ã©ã†ã', english: 'Here you go.', hint: '3èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'ä½•ã‹ã‚’æ¸¡ã™ã¨ã' },
    ],
    airport: [
        // å…¥å›½å¯©æŸ»
        { japanese: 'è¦³å…‰ã§ã™', english: 'Sightseeing.', hint: '1èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'è¨ªå•ã®ç›®çš„ã¯ä½•ã§ã™ã‹?' },
        { japanese: '8æ—¥é–“ã§ã™', english: 'Eight days.', hint: 'Eight days ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ã©ã®ãã‚‰ã„æ»åœ¨ã—ã¾ã™ã‹?' },
        { japanese: 'ã‚¶ ã‚¤ãƒ³ãƒšãƒªã‚¢ãƒ« ãƒãƒ¯ã‚¤ ãƒªã‚¾ãƒ¼ãƒˆã§ã™', english: 'At The Imperial Hawaii Resort.', hint: 'At The ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ã©ã“ã«æ»åœ¨ã—ã¾ã™ã‹?' },
        { japanese: 'ã¯ã„ã€å®¶æ—5äººã§ã™', english: "Yes, we're a family of five.", hint: "Yes, we're ã§å§‹ã¾ã‚Šã¾ã™", level: 'advanced', context: 'ä¸€ç·’ã«æ—…è¡Œã—ã¦ã„ã¾ã™ã‹?' },
        { japanese: 'ã¯ã„ã€5å›ç›®ã§ã™', english: 'Yes, this is our fifth time.', hint: 'Yes, this is ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced', context: 'ãƒãƒ¯ã‚¤ã«æ¥ãŸã“ã¨ã¯ã‚ã‚Šã¾ã™ã‹?' },
        // è·ç‰©å—å–
        { japanese: 'ã™ã¿ã¾ã›ã‚“ã€æ‰‹è·ç‰©å—å–æ‰€ã¯ã©ã“ã§ã™ã‹?', english: "Excuse me, where's the baggage claim?", hint: "Excuse me, where's ã§å§‹ã¾ã‚Šã¾ã™", level: 'advanced' },
        { japanese: 'æ±äº¬ã‹ã‚‰ã®ä¾¿ã¯ã©ã®ã‚¿ãƒ¼ãƒ³ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã™ã‹?', english: 'Which carousel is for the flight from Tokyo?', hint: 'Which carousel ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã™ã¿ã¾ã›ã‚“ã€è·ç‰©ãŒ1ã¤è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', english: 'Excuse me, our bag is missing.', hint: 'Excuse me, our ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: '4å€‹é ã‘ã¾ã—ãŸ', english: 'We checked four bags.', hint: 'We checked ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'é ã‘ãŸè·ç‰©ã®æ•°ã‚’ä¼ãˆã‚‹' },
        { japanese: 'ç´›å¤±è·ç‰©ã®å ±å‘Šã¯ã©ã“ã§ã—ã¾ã™ã‹?', english: 'Where do we report lost luggage?', hint: 'Where do we ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        // ç¨é–¢
        { japanese: 'ã„ã„ãˆã€ã‚ã‚Šã¾ã›ã‚“', english: 'No, nothing to declare.', hint: 'No, nothing ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ç”³å‘Šã™ã‚‹ã‚‚ã®ã¯ã‚ã‚Šã¾ã™ã‹?' },
        // ã‚¿ã‚¯ã‚·ãƒ¼ãƒ»ã‚·ãƒ£ãƒˆãƒ«
        { japanese: 'ã™ã¿ã¾ã›ã‚“ã€ã‚¿ã‚¯ã‚·ãƒ¼ä¹—ã‚Šå ´ã¯ã©ã“ã§ã™ã‹?', english: "Excuse me, where's the taxi stand?", hint: "Excuse me, where's ã§å§‹ã¾ã‚Šã¾ã™", level: 'advanced' },
        { japanese: 'ã‚¶ ã‚¤ãƒ³ãƒšãƒªã‚¢ãƒ« ãƒãƒ¯ã‚¤ ãƒªã‚¾ãƒ¼ãƒˆã¾ã§ãŠé¡˜ã„ã—ã¾ã™', english: 'The Imperial Hawaii Resort, please.', hint: 'The Imperial ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã©ã‚Œãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã‹?', english: 'How long does it take?', hint: 'How long ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã„ãã‚‰ãã‚‰ã„ã§ã™ã‹?', english: 'How much is it?', hint: 'How much ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã“ã“ã§ãŠé¡˜ã„ã—ã¾ã™', english: 'Here, please.', hint: '2èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'ãƒ›ãƒ†ãƒ«å‰ã§é™ã‚Šã‚‹ã¨ã' },
        { japanese: 'ãŠã¤ã‚Šã¯å–ã£ã¦ãŠã„ã¦ãã ã•ã„', english: 'Keep the change.', hint: '3èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner' },
        // ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
        { japanese: 'æ±äº¬ã§ã™', english: 'Tokyo.', hint: '1èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'ã©ã¡ã‚‰ã¸é£›ã³ã¾ã™ã‹?' },
        { japanese: '4å€‹ã§ã™', english: 'Four bags.', hint: 'Four bags ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'é ã‘ã‚‹è·ç‰©ã¯ã„ãã¤ã§ã™ã‹?' },
        { japanese: 'ä¸€ç·’ã«åº§ã‚Œã¾ã™ã‹?å®¶æ—5äººã§ã™', english: "Can we sit together? We're a family of five.", hint: 'Can we sit ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ã¯ã„ã€ã©ã†ã', english: 'Here you go.', hint: '3èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’æ¸¡ã™ã¨ã' },
    ],
    hotel: [
        { japanese: 'ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³å‰ã«è·ç‰©ã‚’é ã‘ãŸã„ã§ã™', english: "We'd like to leave our luggage before check-in.", hint: "We'd like to ã§å§‹ã¾ã‚Šã¾ã™", level: 'advanced' },
        { japanese: 'ä½è—¤ã®åå‰ã§äºˆç´„ã—ã¦ã„ã¾ã™', english: 'We have a reservation under Sato.', hint: 'We have a ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ã‚¹ãƒ¼ãƒ„ã‚±ãƒ¼ã‚¹ãŒ7å€‹ã‚ã‚Šã¾ã™', english: 'We have seven suitcases.', hint: 'We have seven ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'æœé£Ÿã¯ä½•æ™‚ã‹ã‚‰æä¾›ã•ã‚Œã¾ã™ã‹?', english: 'What time is breakfast served?', hint: 'What time ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'éƒ¨å±‹ã§WiFiã¯ä½¿ãˆã¾ã™ã‹?', english: 'Is WiFi available in the rooms?', hint: 'Is WiFi ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: '1205å·å®¤ã®ã‚¨ã‚¢ã‚³ãƒ³ãŒæ­£å¸¸ã«å‹•ãã¾ã›ã‚“', english: "The AC in room 1205 isn't working properly.", hint: 'The AC ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: '1205å·å®¤ã«ã‚¿ã‚ªãƒ«ãŒã‚‚ã£ã¨å¿…è¦ã§ã™', english: 'We need more towels in room 1205, please.', hint: 'We need more ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã‚·ãƒ£ãƒ³ãƒ—ãƒ¼ã¨çŸ³é¹¸ã‚’ã‚‚ã£ã¨ã‚‚ã‚‰ãˆã¾ã™ã‹?', english: 'Could we get some more shampoo and soap?', hint: 'Could we get ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ãƒ“ãƒ¼ãƒã‚¿ã‚ªãƒ«ã‚’å€Ÿã‚Šã‚‰ã‚Œã¾ã™ã‹?', english: 'Could we get some beach towels, please?', hint: 'Could we get ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'å€Ÿã‚Šã‚‰ã‚Œã‚‹ç‚Šé£¯å™¨ã¯ã‚ã‚Šã¾ã™ã‹?', english: 'Do you have a rice cooker we could borrow?', hint: 'Do you have ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ä»Šæ—¥ã¯æ¸…æƒä¸è¦ã§ã™', english: 'No cleaning needed today, please.', hint: 'No cleaning ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã—ãŸã„ã§ã™ã€‚1205å·å®¤ã¨1207å·å®¤ã§ã™', english: "We'd like to check out. Rooms 1205 and 1207.", hint: "We'd like to ã§å§‹ã¾ã‚Šã¾ã™", level: 'advanced' },
        { japanese: 'ãƒ‡ãƒã‚¸ãƒƒãƒˆã¯ã„ã¤ã‚«ãƒ¼ãƒ‰ã«è¿”é‡‘ã•ã‚Œã¾ã™ã‹?', english: 'When will the deposit be refunded to my card?', hint: 'When will ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ã‚¿ã‚¯ã‚·ãƒ¼ã‚’å‘¼ã‚“ã§ã„ãŸã ã‘ã¾ã™ã‹?', english: 'Could you call a taxi for us?', hint: 'Could you call ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
    ],
    transport: [
        { japanese: 'ã“ã®ãƒã‚¹ã¯ãƒ¯ã‚¤ã‚­ã‚­ã¸è¡Œãã¾ã™ã‹?', english: 'Does this bus go to Waikiki?', hint: 'Does this bus ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã‚¢ãƒ©ãƒ¢ã‚¢ãƒŠã‚»ãƒ³ã‚¿ãƒ¼ã«ç€ã„ãŸã‚‰æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹?', english: 'Could you tell me when we get to Ala Moana Center?', hint: 'Could you tell ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ã“ã‚Œã¯â—‹â—‹ã®Uberã§ã™ã‹?', english: 'Is this Uber for â—‹â—‹?', hint: 'Is this Uber ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã‚¨ã‚¢ã‚³ãƒ³ã‚’å¼·ãã—ã¦ã„ãŸã ã‘ã¾ã™ã‹?', english: 'Can you turn up the AC, please?', hint: 'Can you turn ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ãƒ¯ã‚¤ã‚­ã‚­ãƒ“ãƒ¼ãƒã¾ã§é€£ã‚Œã¦è¡Œã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹?', english: 'Can you take me to Waikiki Beach?', hint: 'Can you take ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ã„ãã‚‰ãã‚‰ã„ã‹ã‹ã‚Šã¾ã™ã‹?', english: 'How much will it cost?', hint: 'How much ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã¯ã„ã€ã©ã†ãã€‚ãŠã¤ã‚Šã¯å–ã£ã¦ãŠã„ã¦ãã ã•ã„', english: 'Here you go. Keep the change.', hint: 'Here you go ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã‚«ãƒ¼ãƒ‰ã§æ‰•ãˆã¾ã™ã‹?', english: 'Can I pay by card?', hint: 'Can I pay ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã„ãŸã ã‘ã¾ã™ã‹?', english: 'Can I have a receipt, please?', hint: 'Can I have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
    ],
    dining: [
        { japanese: 'ä½è—¤ã§10äººã®äºˆç´„ã‚’ã—ã¦ã„ã¾ã™', english: 'We have a reservation for ten under Sato.', hint: 'We have a ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: '10äººã§ã™ã€‚äºˆç´„ã¯ã—ã¦ã„ã¾ã›ã‚“', english: 'Ten people, please. No reservation.', hint: 'Ten people ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'å¾…ã¡æ™‚é–“ã¯ã©ã‚Œãã‚‰ã„ã§ã™ã‹?', english: 'How long is the wait?', hint: 'How long ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'å¤–ã®å¸­ã‚’ãŠé¡˜ã„ã§ãã¾ã™ã‹?', english: 'Could we have a table outside, please?', hint: 'Could we have ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¦‹ã›ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹?', english: 'Can I see the menu, please?', hint: 'Can I see ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'æ—¥æœ¬èªã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹?', english: 'Do you have a Japanese menu?', hint: 'Do you have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ä½•ãŒãŠã™ã™ã‚ã§ã™ã‹?', english: 'What do you recommend?', hint: 'What do you ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒŸãƒ‡ã‚£ã‚¢ãƒ ã§ãŠé¡˜ã„ã—ã¾ã™', english: 'Medium, please.', hint: '2èªã§ç­”ãˆã‚‰ã‚Œã¾ã™', level: 'beginner', context: 'ç„¼ãåŠ æ¸›ã‚’èã‹ã‚ŒãŸã¨ã' },
        { japanese: 'ã‚½ãƒ¼ã‚¹ãªã—ã§ãŠé¡˜ã„ã§ãã¾ã™ã‹?', english: 'Can I get that with no sauce?', hint: 'Can I get ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ã‚·ã‚§ã‚¢ç”¨ã®è¿½åŠ ã®çš¿ã‚’ã„ãŸã ã‘ã¾ã™ã‹?', english: 'Can we get extra plates for sharing?', hint: 'Can we get ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'ä»Šã®ã¨ã“ã‚ä»¥ä¸Šã§ã™', english: "No, that's all for now.", hint: "No, that's ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner', context: 'ä»–ã«ä½•ã‹ã”æ³¨æ–‡ã¯?' },
        { japanese: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã§ãã¾ã™ã‹?', english: 'Could we get the check, please?', hint: 'Could we get ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
        { japanese: 'åˆ¥ã€…ã®ä¼šè¨ˆã§ãŠé¡˜ã„ã—ã¾ã™', english: "We'd like separate checks, please.", hint: "We'd like ã§å§‹ã¾ã‚Šã¾ã™", level: 'advanced' },
        { japanese: 'ãƒ“ãƒƒã‚°ãƒãƒƒã‚¯ã®ã‚»ãƒƒãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™', english: "I'll have a Big Mac meal, please.", hint: "I'll have ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner', context: 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰ã§' },
        { japanese: '3ç•ªã®ã‚³ãƒ³ãƒœã‚’ãŠé¡˜ã„ã§ãã¾ã™ã‹?', english: 'Can I get a number 3 combo?', hint: 'Can I get ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰ã§' },
        { japanese: 'ãƒãƒ¼ã‚¬ãƒ¼ã ã‘ã§ãŠé¡˜ã„ã—ã¾ã™', english: 'Just the burger, please.', hint: 'Just the ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner', context: 'ã‚»ãƒƒãƒˆã§ã¯ãªãå˜å“' },
        { japanese: 'ãŠæ°´ã®ãŠã‹ã‚ã‚Šã‚’ã„ãŸã ã‘ã¾ã™ã‹?', english: 'Could we get some more water, please?', hint: 'Could we get ã§å§‹ã¾ã‚Šã¾ã™', level: 'advanced' },
    ],
    shopping: [
        { japanese: 'ã“ã‚Œã¯ã„ãã‚‰ã§ã™ã‹?', english: 'How much is this?', hint: 'How much ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã“ã‚Œã®Lã‚µã‚¤ã‚ºã¯ã‚ã‚Šã¾ã™ã‹?', english: 'Do you have this in large?', hint: 'Do you have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãŠã™ã™ã‚ã¯ã‚ã‚Šã¾ã™ã‹?', english: 'Do you have any recommendations?', hint: 'Do you have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹?', english: 'Do you take credit cards?', hint: 'Do you take ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'è–¬ã‚’è²·ã†å¿…è¦ãŒã‚ã‚Šã¾ã™', english: 'I need to buy medicine.', hint: 'I need to ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'è¿‘ãã«ãƒ‰ãƒ©ãƒƒã‚°ã‚¹ãƒˆã‚¢ã¯ã‚ã‚Šã¾ã™ã‹?', english: 'Do you have a drugstore nearby?', hint: 'Do you have ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'é¢¨é‚ªã®è–¬ãŒå¿…è¦ã§ã™', english: 'I need something for a cold.', hint: 'I need ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
    ],
    emergency: [
        { japanese: '911ã«é›»è©±ã—ã¦ãã ã•ã„!', english: 'Call 911, please!', hint: 'Call 911 ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'åŠ©ã‘ãŒå¿…è¦ã§ã™ã€ãŠé¡˜ã„ã—ã¾ã™', english: 'I need help, please.', hint: 'I need help ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„', english: 'Please call the police.', hint: 'Please call ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§ãã ã•ã„!', english: 'Call an ambulance, please!', hint: 'Call an ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'è²¡å¸ƒã‚’ãªãã—ã¾ã—ãŸ', english: 'I lost my wallet.', hint: 'I lost ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒãƒƒã‚°ãŒç›—ã¾ã‚Œã¾ã—ãŸ', english: 'My bag was stolen.', hint: 'My bag ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ä½“èª¿ãŒæ‚ªã„ã§ã™', english: "I don't feel well.", hint: "I don't feel ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'åŒ»è€…ã«è¨ºã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚Šã¾ã™', english: 'I need to see a doctor.', hint: 'I need to ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ç†±ãŒã‚ã‚Šã¾ã™', english: 'I have a fever.', hint: 'I have a ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'é ­ãŒç—›ã„ã§ã™', english: 'I have a headache.', hint: 'I have a ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãŠè…¹ãŒç—›ã„ã§ã™', english: 'I have a stomachache.', hint: 'I have a ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'æœ€å¯„ã‚Šã®ç—…é™¢ã¯ã©ã“ã§ã™ã‹?', english: "Where's the nearest hospital?", hint: "Where's the ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
        { japanese: 'è–¬å±€ã¯ã©ã“ã§ã™ã‹?', english: "Where's the pharmacy?", hint: "Where's the ã§å§‹ã¾ã‚Šã¾ã™", level: 'beginner' },
    ],
    smalltalk: [
        { japanese: 'ã“ã‚“ã«ã¡ã¯!ã„ã„å¤©æ°—ã§ã™ã­!', english: 'Hi! Nice day!', hint: 'Hi! Nice ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ä¼‘æš‡ã§ã™ã‹?', english: 'Are you on vacation?', hint: 'Are you ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã©ã“ã‹ã‚‰æ¥ãŸã‚“ã§ã™ã‹?', english: 'Where are you from?', hint: 'Where are you ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒãƒ¯ã‚¤ã¯åˆã‚ã¦ã§ã™ã‹?', english: 'First time in Hawaii?', hint: 'First time ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã©ã®ãã‚‰ã„æ»åœ¨ã§ã™ã‹?', english: 'How long are you here?', hint: 'How long ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: '10æ—¥é–“ã€‚åˆã‚ã¦ã§ã™!', english: 'Ten days. First time!', hint: 'Ten days ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'å­ä¾›ã¨æ—…è¡Œä¸­ã§ã™ã‹?', english: 'Traveling with kids?', hint: 'Traveling with ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'æ˜æ—¥ã¯ä½•ã‚’ã—ã¾ã™ã‹?', english: 'What are you doing tomorrow?', hint: 'What are you ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãƒãƒ¯ã‚¤ã§ä½•ã‚’ã™ã¹ãã§ã™ã‹?', english: 'What should we do in Hawaii?', hint: 'What should ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ã™ã¿ã¾ã›ã‚“ã€‚å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹?', english: 'Excuse me, can you take our photo?', hint: 'Excuse me ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
        { japanese: 'ãŠä¼šã„ã§ãã¦è‰¯ã‹ã£ãŸ!', english: 'It was nice meeting you!', hint: 'It was nice ã§å§‹ã¾ã‚Šã¾ã™', level: 'beginner' },
    ]};

// ============================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// ============================================
let currentMode = 'quiz';
let selectedScene = 'random';
let selectedLevel = 'all';
let currentQuestions = [];
let currentQuestionIndex = 0;
let correctCount = 0;
let incorrectCount = 0;
let isRecording = false;
let recognition = null;
let currentAnswer = '';
let isAnswerShown = false;
let isPracticeRecording = false;
let practiceRecognition = null;
let currentPracticeIndex = 0;
let practiceQuestions = [];

// AIãƒãƒ£ãƒƒãƒˆç”¨å¤‰æ•°
let aiChatScene = 'freetalk';
let aiChatLevel = 'intermediate';
let chatHistory = [];

// ============================================
// éŸ³å£°èªè­˜ã®åˆæœŸåŒ–
// ============================================
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('answerInput').value = transcript;
        document.getElementById('clearBtn').classList.add('show');
        stopVoiceInput();
    };
    
    recognition.onerror = function(event) {
        console.error('Speech recognition error:', event.error);
        stopVoiceInput();
    };
    
    recognition.onend = function() {
        stopVoiceInput();
    };
    
    // ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ç”¨
    practiceRecognition = new SpeechRecognition();
    practiceRecognition.lang = 'en-US';
    practiceRecognition.continuous = false;
    practiceRecognition.interimResults = false;
    
    practiceRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('recognitionText').textContent = transcript;
        document.getElementById('recognitionPlaceholder').classList.add('hidden');
        document.getElementById('recognitionText').classList.remove('hidden');
        
        // ç°¡å˜ãªã‚¹ã‚³ã‚¢è¨ˆç®—
        const currentPhrase = practiceQuestions[currentPracticeIndex];
        const similarity = calculateSimilarity(transcript.toLowerCase(), currentPhrase.english.toLowerCase());
        const score = Math.round(similarity * 100);
        
        document.getElementById('scoreDisplay2').classList.remove('hidden');
        document.getElementById('scoreValue').textContent = score;
        
        if (score >= 90) {
            document.getElementById('scoreMessage').textContent = 'ç´ æ™´ã‚‰ã—ã„ç™ºéŸ³ã§ã™! ğŸ‰';
        } else if (score >= 70) {
            document.getElementById('scoreMessage').textContent = 'è‰¯ã„ç™ºéŸ³ã§ã™! ğŸ‘';
        } else if (score >= 50) {
            document.getElementById('scoreMessage').textContent = 'ã‚‚ã†å°‘ã—ç·´ç¿’ã—ã¾ã—ã‚‡ã† ğŸ’ª';
        } else {
            document.getElementById('scoreMessage').textContent = 'ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦! âœ¨';
        }
        
        stopPracticeRecording();
    };
    
    practiceRecognition.onerror = function(event) {
        console.error('Practice speech recognition error:', event.error);
        stopPracticeRecording();
    };
    
    practiceRecognition.onend = function() {
        stopPracticeRecording();
    };
}

// ============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
// ============================================

// æ–‡å­—åˆ—ã®é¡ä¼¼åº¦ã‚’è¨ˆç®— (Levenshtein distance)
function calculateSimilarity(s1, s2) {
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    const longerLength = longer.length;
    if (longerLength === 0) {
        return 1.0;
    }
    return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
}

function editDistance(s1, s2) {
    s1 = s1.toLowerCase();
    s2 = s2.toLowerCase();
    const costs = [];
    for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
            if (i === 0) {
                costs[j] = j;
            } else if (j > 0) {
                let newValue = costs[j - 1];
                if (s1.charAt(i - 1) !== s2.charAt(j - 1)) {
                    newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
                }
                costs[j - 1] = lastValue;
                lastValue = newValue;
            }
        }
        if (i > 0) {
            costs[s2.length] = lastValue;
        }
    }
    return costs[s2.length];
}

// æ­£è¦åŒ–é–¢æ•°
function normalizeText(text) {
    return text
        .toLowerCase()
        .replace(/[.,!?;:'"`]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
}

// æŸ”è»Ÿãªæ­£è§£åˆ¤å®š
function isAnswerCorrect(userAnswer, correctAnswer) {
    const normalizedUser = normalizeText(userAnswer);
    const normalizedCorrect = normalizeText(correctAnswer);
    
    // å®Œå…¨ä¸€è‡´
    if (normalizedUser === normalizedCorrect) {
        return true;
    }
    
    // åŒç¾©èªãƒ»çŸ­ç¸®å½¢ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const equivalents = [
        ['cant', 'cannot', 'can not'],
        ['dont', 'do not'],
        ['wont', 'will not'],
        ['im', 'i am'],
        ['youre', 'you are'],
        ['were', 'we are'],
        ['theyre', 'they are'],
        ['isnt', 'is not'],
        ['arent', 'are not'],
        ['wasnt', 'was not'],
        ['werent', 'were not'],
        ['hasnt', 'has not'],
        ['havent', 'have not'],
        ['hadnt', 'had not'],
        ['wouldnt', 'would not'],
        ['shouldnt', 'should not'],
        ['couldnt', 'could not'],
        ['mightnt', 'might not'],
        ['mustnt', 'must not'],
        ['shant', 'shall not'],
        ['whats', 'what is'],
        ['wheres', 'where is'],
        ['whos', 'who is'],
        ['hows', 'how is'],
        ['thats', 'that is'],
        ['theres', 'there is'],
        ['heres', 'here is'],
        ['id', 'i would', 'i had'],
        ['youd', 'you would', 'you had'],
        ['hed', 'he would', 'he had'],
        ['shed', 'she would', 'she had'],
        ['wed', 'we would', 'we had'],
        ['theyd', 'they would', 'they had'],
        ['ill', 'i will'],
        ['youll', 'you will'],
        ['hell', 'he will'],
        ['shell', 'she will'],
        ['well', 'we will'],
        ['theyll', 'they will'],
        ['ive', 'i have'],
        ['youve', 'you have'],
        ['weve', 'we have'],
        ['theyve', 'they have'],
        ['meal', 'combo'],
        ['thats all', 'thats it'],
        ['thanks', 'thank you'],
        ['do you accept', 'can i use'],
        ['ill have that one', 'that one please'],
    ];
    
    // åŒç¾©èªã‚’ãƒã‚§ãƒƒã‚¯
    for (const group of equivalents) {
        let userHasVariant = false;
        let correctHasVariant = false;
        
        for (const variant of group) {
            if (normalizedUser.includes(variant)) {
                userHasVariant = true;
            }
            if (normalizedCorrect.includes(variant)) {
                correctHasVariant = true;
            }
        }
        
        if (userHasVariant && correctHasVariant) {
            // åŒç¾©èªã‚’ç½®æ›ã—ã¦å†åº¦æ¯”è¼ƒ
            let tempUser = normalizedUser;
            let tempCorrect = normalizedCorrect;
            
            for (const variant of group) {
                tempUser = tempUser.replace(variant, group[0]);
                tempCorrect = tempCorrect.replace(variant, group[0]);
            }
            
            if (tempUser === tempCorrect) {
                return true;
            }
        }
    }
    
    // ä¸»èªã®é•ã„ã‚’å¸å
    const subjects = ['i', 'you', 'he', 'she', 'we', 'they'];
    for (const subj1 of subjects) {
        for (const subj2 of subjects) {
            if (normalizedUser.replace(subj1, '___') === normalizedCorrect.replace(subj2, '___')) {
                return true;
            }
        }
    }
    
    // é¡ä¼¼åº¦ãƒã‚§ãƒƒã‚¯ (90%ä»¥ä¸Šã§æ­£è§£ã¨ã™ã‚‹)
    const similarity = calculateSimilarity(normalizedUser, normalizedCorrect);
    if (similarity >= 0.9) {
        return true;
    }
    
    return false;
}

// ============================================
// ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–¢æ•°
// ============================================

function selectMainMode(mode) {
    currentMode = mode;
    
    // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('.mode-card').forEach(card => {
        card.classList.remove('active');
    });
    document.querySelector(`[data-mainmode="${mode}"]`).classList.add('active');
    
    // AIãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯è¨­å®šã‚’éè¡¨ç¤º
    if (mode === 'aichat') {
        document.getElementById('quizSettings').style.display = 'none';
    } else {
        document.getElementById('quizSettings').style.display = 'block';
    }
}

function selectScene(scene) {
    selectedScene = scene;
    
    // ã‚·ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-mode]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-mode="${scene}"]`).classList.add('active');
}

function selectLevel(level) {
    selectedLevel = level;
    
    // ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-level]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-level="${level}"]`).classList.add('active');
}

function startMode() {
    if (currentMode === 'quiz') {
        startQuiz();
    } else if (currentMode === 'speaking') {
        startSpeaking();
    } else if (currentMode === 'aichat') {
        // AIãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯è¨­å®šç”»é¢ã‚’è¡¨ç¤º
        showScreen('aichatScreen');
        document.getElementById('aichatSetup').classList.remove('hidden');
        document.getElementById('aichatActive').classList.add('hidden');
    }
}

function showScreen(screenId) {
    // å…¨ã¦ã®ç”»é¢ã‚’éè¡¨ç¤º
    document.querySelectorAll('.menu-screen, .content, .speaking-screen, .result-screen, .stats-screen, .aichat-screen').forEach(screen => {
        screen.classList.add('hidden');
    });
    
    // æŒ‡å®šã•ã‚ŒãŸç”»é¢ã‚’è¡¨ç¤º
    document.getElementById(screenId).classList.remove('hidden');
}

function returnToMenu() {
    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    currentQuestionIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    currentPracticeIndex = 0;
    chatHistory = [];
    
    showScreen('mainMenu');
}

// ============================================
// ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰é–¢æ•°
// ============================================

function startQuiz() {
    // å•é¡Œã‚’ç”Ÿæˆ
    currentQuestions = generateQuestions();
    
    if (currentQuestions.length === 0) {
        alert('é¸æŠã—ãŸæ¡ä»¶ã«åˆã†å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    currentQuestions = shuffleArray(currentQuestions);
    
    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    currentQuestionIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    
    // ç”»é¢ã‚’è¡¨ç¤º
    showScreen('quizScreen');
    displayQuestion();
    updateProgress();
}

function generateQuestions() {
    let questions = [];
    
    if (selectedScene === 'random') {
        // å…¨ã‚·ãƒ¼ãƒ³ã‹ã‚‰é¸æŠ
        for (const scene in phrasesDatabase) {
            questions = questions.concat(phrasesDatabase[scene]);
        }
    } else {
        // ç‰¹å®šã®ã‚·ãƒ¼ãƒ³ã‹ã‚‰é¸æŠ
        questions = phrasesDatabase[selectedScene] || [];
    }
    
    // ãƒ¬ãƒ™ãƒ«ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if (selectedLevel !== 'all') {
        questions = questions.filter(q => q.level === selectedLevel);
    }
    
    return questions;
}

function shuffleArray(array) {
    const newArray = [...array];
    for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
    }
    return newArray;
}

function displayQuestion() {
    const question = currentQuestions[currentQuestionIndex];
    
    // ã‚·ãƒ¼ãƒ³ãƒãƒƒã‚¸ã‚’æ›´æ–°
    const sceneNames = {
        frequent: 'ğŸ’¡ é »å‡º',
        airport: 'âœˆï¸ ç©ºæ¸¯',
        hotel: 'ğŸ¨ ãƒ›ãƒ†ãƒ«',
        dining: 'ğŸ½ï¸ é£Ÿäº‹',
        shopping: 'ğŸ›ï¸ è²·ã„ç‰©',
        transport: 'ğŸš— äº¤é€š',
        emergency: 'ğŸ†˜ ç·Šæ€¥',
        smalltalk: 'ğŸ’¬ ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯'
    };
    
    // ã‚·ãƒ¼ãƒ³ã‚’ç‰¹å®š
    let sceneName = 'ğŸŒ´ ãƒ©ãƒ³ãƒ€ãƒ ';
    for (const scene in phrasesDatabase) {
        if (phrasesDatabase[scene].includes(question)) {
            sceneName = sceneNames[scene] || scene;
            break;
        }
    }
    
    document.getElementById('scene').textContent = sceneName;
    document.getElementById('levelBadge').textContent = question.level === 'beginner' ? 'åˆç´š' : 'ä¸Šç´š';
    
    // è³ªå•ã‚’è¡¨ç¤º
    document.getElementById('japanese').textContent = question.japanese;
    
    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
    const contextBox = document.getElementById('contextBox');
    if (question.context) {
        contextBox.textContent = question.context;
        contextBox.classList.add('show');
    } else {
        contextBox.classList.remove('show');
    }
    
    // ãƒ’ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('hintBox').classList.add('hidden');
    document.getElementById('hintBox').textContent = '';
    
    // å›ç­”æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('answerInput').value = '';
    document.getElementById('clearBtn').classList.remove('show');
    
    // çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('resultBox').classList.add('hidden');
    document.getElementById('resultBox').innerHTML = '';
    
    // æ­£è§£è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('answerBox').classList.add('hidden');
    isAnswerShown = false;
    
    // çµ±è¨ˆã‚’æ›´æ–°
    updateStats();
}

function updateProgress() {
    const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressText').textContent = `å•é¡Œ ${currentQuestionIndex + 1} / ${currentQuestions.length}`;
    
    document.getElementById('score').textContent = correctCount;
    document.getElementById('total').textContent = correctCount + incorrectCount;
}

function updateStats() {
    document.getElementById('correct').textContent = correctCount;
    document.getElementById('incorrect').textContent = incorrectCount;
    
    const total = correctCount + incorrectCount;
    const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    document.getElementById('accuracy').textContent = `${accuracy}%`;
}

function toggleHint() {
    const hintBox = document.getElementById('hintBox');
    const question = currentQuestions[currentQuestionIndex];
    
    if (hintBox.classList.contains('hidden')) {
        hintBox.textContent = question.hint;
        hintBox.classList.remove('hidden');
        document.getElementById('hintBtn').textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’éš ã™';
    } else {
        hintBox.classList.add('hidden');
        document.getElementById('hintBtn').textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹';
    }
}

function speakAnswer() {
    const question = currentQuestions[currentQuestionIndex];
    const utterance = new SpeechSynthesisUtterance(question.english);
    utterance.lang = 'en-US';
    utterance.rate = 1.0;
    speechSynthesis.speak(utterance);
}

function speakAnswerSlow() {
    const question = currentQuestions[currentQuestionIndex];
    const utterance = new SpeechSynthesisUtterance(question.english);
    utterance.lang = 'en-US';
    utterance.rate = 0.7;
    speechSynthesis.speak(utterance);
}

function toggleAnswer() {
    const answerBox = document.getElementById('answerBox');
    const question = currentQuestions[currentQuestionIndex];
    
    if (isAnswerShown) {
        answerBox.classList.add('hidden');
        isAnswerShown = false;
        document.getElementById('showAnswerBtn').innerHTML = 'ğŸ‘ï¸ æ­£è§£ã‚’è¦‹ã‚‹';
    } else {
        answerBox.textContent = question.english;
        answerBox.classList.remove('hidden');
        isAnswerShown = true;
        document.getElementById('showAnswerBtn').innerHTML = 'âŒ æ­£è§£ã‚’éš ã™';
    }
}

function checkAnswer() {
    const userAnswer = document.getElementById('answerInput').value.trim();
    const question = currentQuestions[currentQuestionIndex];
    const resultBox = document.getElementById('resultBox');
    
    if (!userAnswer) {
        resultBox.innerHTML = '<div class="result warning">âš ï¸ å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
        resultBox.classList.remove('hidden');
        return;
    }
    
    if (isAnswerCorrect(userAnswer, question.english)) {
        correctCount++;
        resultBox.innerHTML = `
            <div class="result correct">
                âœ… æ­£è§£ã§ã™!ç´ æ™´ã‚‰ã—ã„!
            </div>
        `;
    } else {
        incorrectCount++;
        resultBox.innerHTML = `
            <div class="result incorrect">
                âŒ ä¸æ­£è§£ã§ã™
                <div class="correct-answer">æ­£è§£: ${question.english}</div>
            </div>
        `;
    }
    
    resultBox.classList.remove('hidden');
    updateStats();
    updateProgress();
    
    // çµ±è¨ˆã‚’ä¿å­˜
    saveStats();
}

function nextQuestion() {
    if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
        updateProgress();
    } else {
        showResults();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
        updateProgress();
    }
}

function clearInput() {
    document.getElementById('answerInput').value = '';
    document.getElementById('clearBtn').classList.remove('show');
}

// å…¥åŠ›æ¬„ã®ç›£è¦–
document.addEventListener('DOMContentLoaded', function() {
    const answerInput = document.getElementById('answerInput');
    if (answerInput) {
        answerInput.addEventListener('input', function() {
            if (this.value.length > 0) {
                document.getElementById('clearBtn').classList.add('show');
            } else {
                document.getElementById('clearBtn').classList.remove('show');
            }
        });
        
        // Enterã‚­ãƒ¼ã§å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯
        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                checkAnswer();
            }
        });
    }
});

// ============================================
// éŸ³å£°å…¥åŠ›é–¢æ•°
// ============================================

function toggleVoiceInput() {
    if (!recognition) {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }
    
    if (isRecording) {
        stopVoiceInput();
    } else {
        startVoiceInput();
    }
}

function startVoiceInput() {
    try {
        recognition.start();
        isRecording = true;
        document.getElementById('voiceBtn').classList.add('recording');
        document.getElementById('voiceIcon').textContent = 'ğŸ”´';
        document.getElementById('voiceText').textContent = 'éŒ²éŸ³ä¸­...';
    } catch (error) {
        console.error('Voice input start error:', error);
    }
}

function stopVoiceInput() {
    if (isRecording) {
        try {
            recognition.stop();
        } catch (error) {
            console.error('Voice input stop error:', error);
        }
        isRecording = false;
        document.getElementById('voiceBtn').classList.remove('recording');
        document.getElementById('voiceIcon').textContent = 'ğŸ¤';
        document.getElementById('voiceText').textContent = 'éŸ³å£°å…¥åŠ›';
    }
}

// ============================================
// çµæœè¡¨ç¤ºé–¢æ•°
// ============================================

function showResults() {
    const total = correctCount + incorrectCount;
    const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    
    document.getElementById('finalCorrect').textContent = correctCount;
    document.getElementById('finalIncorrect').textContent = incorrectCount;
    document.getElementById('finalAccuracy').textContent = `${accuracy}%`;
    
    // çµµæ–‡å­—ã‚’é¸æŠ
    let emoji = 'ğŸ‰';
    let title = 'ã‚¯ã‚¤ã‚ºå®Œäº†!';
    
    if (accuracy >= 90) {
        emoji = 'ğŸ†';
        title = 'ç´ æ™´ã‚‰ã—ã„!';
    } else if (accuracy >= 70) {
        emoji = 'ğŸ‰';
        title = 'è‰¯ãã§ãã¾ã—ãŸ!';
    } else if (accuracy >= 50) {
        emoji = 'ğŸ‘';
        title = 'ã‚‚ã†å°‘ã—é ‘å¼µã‚Šã¾ã—ã‚‡ã†!';
    } else {
        emoji = 'ğŸ’ª';
        title = 'ç·´ç¿’ã‚ã‚‹ã®ã¿!';
    }
    
    document.getElementById('resultEmoji').textContent = emoji;
    document.getElementById('resultTitle').textContent = title;
    
    showScreen('resultScreen');
}

// ============================================
// ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’é–¢æ•°
// ============================================

function startSpeaking() {
    // å•é¡Œã‚’ç”Ÿæˆ
    practiceQuestions = generateQuestions();
    
    if (practiceQuestions.length === 0) {
        alert('é¸æŠã—ãŸæ¡ä»¶ã«åˆã†å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    practiceQuestions = shuffleArray(practiceQuestions);
    
    // çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    currentPracticeIndex = 0;
    
    // ç”»é¢ã‚’è¡¨ç¤º
    showScreen('speakingScreen');
    displayPracticePhrase();
}

function displayPracticePhrase() {
    const phrase = practiceQuestions[currentPracticeIndex];
    
    document.getElementById('speakingJapanese').textContent = phrase.japanese;
    document.getElementById('speakingEnglish').textContent = phrase.english;
    
    // èªè­˜çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('recognitionPlaceholder').classList.remove('hidden');
    document.getElementById('recognitionText').classList.add('hidden');
    document.getElementById('recognitionText').textContent = '';
    
    // ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('scoreDisplay2').classList.add('hidden');
}

function togglePracticeRecording() {
    if (!practiceRecognition) {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }
    
    if (isPracticeRecording) {
        stopPracticeRecording();
    } else {
        startPracticeRecording();
    }
}

function startPracticeRecording() {
    try {
        practiceRecognition.start();
        isPracticeRecording = true;
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordIcon').textContent = 'ğŸ”´';
        document.getElementById('recordText').textContent = 'éŒ²éŸ³ä¸­...';
    } catch (error) {
        console.error('Practice recording start error:', error);
    }
}

function stopPracticeRecording() {
    if (isPracticeRecording) {
        try {
            practiceRecognition.stop();
        } catch (error) {
            console.error('Practice recording stop error:', error);
        }
        isPracticeRecording = false;
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordIcon').textContent = 'ğŸ¤';
        document.getElementById('recordText').textContent = 'éŒ²éŸ³é–‹å§‹';
    }
}

function speakPracticeAnswer() {
    const phrase = practiceQuestions[currentPracticeIndex];
    const utterance = new SpeechSynthesisUtterance(phrase.english);
    utterance.lang = 'en-US';
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
}

function nextPracticePhrase() {
    if (currentPracticeIndex < practiceQuestions.length - 1) {
        currentPracticeIndex++;
        displayPracticePhrase();
    } else {
        currentPracticeIndex = 0;
        displayPracticePhrase();
    }
}

// ============================================
// AIãƒãƒ£ãƒƒãƒˆé–¢æ•°
// ============================================

function selectAIScene(scene) {
    aiChatScene = scene;
    
    // AIã‚·ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-aiscene]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-aiscene="${scene}"]`).classList.add('active');
}

function selectAILevel(level) {
    aiChatLevel = level;
    
    // AIãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-ailevel]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-ailevel="${level}"]`).classList.add('active');
}

function startAIChat() {
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
    chatHistory = [];
    
    // è¨­å®šç”»é¢ã‚’éè¡¨ç¤ºã€ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
    document.getElementById('aichatSetup').classList.add('hidden');
    document.getElementById('aichatActive').classList.remove('hidden');
    
    // ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '';
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆ
    const initialMessage = generateAIInitialMessage();
    addAIChatMessage(initialMessage, 'ai');
}

function generateAIInitialMessage() {
    const sceneMessages = {
        freetalk: `ã“ã‚“ã«ã¡ã¯! ğŸ˜Š ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯ã¸ã‚ˆã†ã“ã!
        
ä»Šæ—¥ã¯ã©ã‚“ãªè©±ã‚’ã—ã¾ã—ã‚‡ã†ã‹? æ—…è¡Œã€è¶£å‘³ã€æ—¥å¸¸ç”Ÿæ´»ãªã©ã€ä½•ã§ã‚‚è‹±èªã§è©±ã—ã¦ã¿ã¾ã—ã‚‡ã†!
        
ã¾ãšã¯ç°¡å˜ãªè‡ªå·±ç´¹ä»‹ã‹ã‚‰å§‹ã‚ã¾ã›ã‚“ã‹?`,
        airport: `Welcome to the airport! âœˆï¸
        
I'm a check-in staff member. How can I help you today?
        
(ç©ºæ¸¯ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒƒãƒ•ã§ã™ã€‚ã©ã®ã‚ˆã†ã«ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹?)`,
        hotel: `Welcome to our hotel! ğŸ¨
        
I'm at the front desk. Are you checking in today?
        
(ãƒ•ãƒ­ãƒ³ãƒˆãƒ‡ã‚¹ã‚¯ã§ã™ã€‚æœ¬æ—¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã•ã‚Œã¾ã™ã‹?)`,
        restaurant: `Welcome to our restaurant! ğŸ½ï¸
        
Hi! I'll be your server today. Can I get you started with some drinks?
        
(ã“ã‚“ã«ã¡ã¯!ä»Šæ—¥ã®ã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚ã¾ãšãŠé£²ã¿ç‰©ã¯ã„ã‹ãŒã§ã™ã‹?)`,
        shopping: `Welcome! ğŸ›ï¸
        
Hi there! Looking for anything in particular today?
        
(ã“ã‚“ã«ã¡ã¯!ä½•ã‹ãŠæ¢ã—ã§ã™ã‹?)`,
        sightseeing: `Aloha! ğŸŒº
        
Welcome to Hawaii! I'm a tour guide. Where would you like to visit today?
        
(ãƒãƒ¯ã‚¤ã¸ã‚ˆã†ã“ã!ãƒ„ã‚¢ãƒ¼ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ä»Šæ—¥ã¯ã©ã¡ã‚‰ã¸è¡ŒããŸã„ã§ã™ã‹?)`
    };
    
    return sceneMessages[aiChatScene] || sceneMessages.freetalk;
}

function addAIChatMessage(message, sender) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // å±¥æ­´ã«è¿½åŠ 
    chatHistory.push({ sender, message });
}

function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) {
        return;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    addAIChatMessage(message, 'user');
    input.value = '';
    
    // AIã®å¿œç­”ã‚’ç”Ÿæˆ
    setTimeout(() => {
        const aiResponse = generateAIResponse(message);
        addAIChatMessage(aiResponse, 'ai');
    }, 500);
}

function generateAIResponse(userMessage) {
    const normalizedMessage = userMessage.toLowerCase().trim();
    
    // ã‚·ãƒ¼ãƒ³åˆ¥ã®å¿œç­”
    const sceneResponses = {
        freetalk: [
            "That's interesting! Tell me more about it. ğŸ˜Š",
            "I see! How do you feel about that?",
            "Great! What else would you like to talk about?",
            "Nice! Can you explain that a bit more?",
            "Wonderful! What do you think about that?"
        ],
        airport: [
            "Sure! Can I see your passport and ticket, please?",
            "How many bags are you checking today?",
            "Would you like a window or aisle seat?",
            "Here's your boarding pass. Gate 25, boarding starts at 10:30.",
            "Your flight is on time. Have a great trip!"
        ],
        hotel: [
            "Perfect! Can I have your name and reservation number?",
            "We have you in a deluxe room for 3 nights. Is that correct?",
            "Here are your room keys. You're in room 305 on the third floor.",
            "Breakfast is served from 7 to 10 AM in the dining room.",
            "Is there anything else I can help you with?"
        ],
        restaurant: [
            "Great choice! Would you like that medium or well done?",
            "Perfect! And what would you like to drink with that?",
            "I'll get that order in for you right away!",
            "Are you ready for dessert?",
            "Can I get you anything else?"
        ],
        shopping: [
            "Sure! What size are you looking for?",
            "That's a great item! Would you like to try it on?",
            "We have that in blue, red, and black. Which color do you prefer?",
            "Great! I'll ring that up for you. Cash or card?",
            "Thank you for shopping with us!"
        ],
        sightseeing: [
            "Wonderful choice! Diamond Head is beautiful this time of year.",
            "I recommend visiting Waikiki Beach in the morning when it's less crowded.",
            "The best time to see the sunset is around 6 PM at Ala Moana Beach.",
            "Would you like to book a tour? We have several options available.",
            "Don't forget to bring sunscreen and water!"
        ]
    };
    
    // æŒ¨æ‹¶ã¸ã®å¿œç­”
    if (normalizedMessage.match(/\b(hi|hello|hey|good morning|good afternoon|good evening)\b/)) {
        return "Hello! How can I help you today? ğŸ˜Š";
    }
    
    // æ„Ÿè¬ã¸ã®å¿œç­”
    if (normalizedMessage.match(/\b(thank you|thanks|thx)\b/)) {
        return "You're welcome! Is there anything else I can help you with?";
    }
    
    // ã•ã‚ˆã†ãªã‚‰ã¸ã®å¿œç­”
    if (normalizedMessage.match(/\b(bye|goodbye|see you|farewell)\b/)) {
        return "Goodbye! Have a wonderful day! ğŸ‘‹";
    }
    
    // ã‚·ãƒ¼ãƒ³åˆ¥ã®å¿œç­”ã‚’é¸æŠ
    const responses = sceneResponses[aiChatScene] || sceneResponses.freetalk;
    const randomIndex = Math.floor(Math.random() * responses.length);
    let response = responses[randomIndex];
    
    // ãƒ¬ãƒ™ãƒ«åˆ¥ã®èª¿æ•´
    if (aiChatLevel === 'beginner') {
        // ç°¡å˜ãªè‹±èªã«èª¿æ•´
        response += "\n\n(Don't worry, take your time! ğŸ˜Š)";
    } else if (aiChatLevel === 'advanced') {
        // ã‚ˆã‚Šè©³ç´°ãªå¿œç­”
        response += "\n\nCould you elaborate on that a bit more?";
    }
    
    return response;
}

// Enterã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
    }
});

// ============================================
// çµ±è¨ˆæ©Ÿèƒ½
// ============================================

function saveStats() {
    // localStorage ã«çµ±è¨ˆã‚’ä¿å­˜
    let stats = JSON.parse(localStorage.getItem('quizStats') || '{}');
    
    if (!stats.totalSessions) {
        stats.totalSessions = 0;
        stats.totalCorrect = 0;
        stats.totalQuestions = 0;
    }
    
    stats.totalSessions++;
    stats.totalCorrect += correctCount;
    stats.totalQuestions += correctCount + incorrectCount;
    
    localStorage.setItem('quizStats', JSON.stringify(stats));
}

function showStats() {
    const stats = JSON.parse(localStorage.getItem('quizStats') || '{}');
    
    document.getElementById('totalSessions').textContent = stats.totalSessions || 0;
    document.getElementById('totalCorrectStats').textContent = stats.totalCorrect || 0;
    document.getElementById('totalQuestionsStats').textContent = stats.totalQuestions || 0;
    
    const averageAccuracy = stats.totalQuestions > 0 
        ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
        : 0;
    document.getElementById('averageAccuracy').textContent = `${averageAccuracy}%`;
    
    showScreen('statsScreen');
}

function resetStats() {
    if (confirm('æœ¬å½“ã«çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹? ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        localStorage.removeItem('quizStats');
        showStats();
        alert('çµ±è¨ˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚');
    }
}

    </script>
</body>
</html>
