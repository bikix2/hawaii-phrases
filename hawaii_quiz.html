<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸï¸ ãƒãƒ¯ã‚¤è‹±ä¼šè©±ã‚¯ã‚¤ã‚º - Gemini AI Edition</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .ai-badge {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 5px;
        }
        
        .progress-bar {
            background: rgba(255,255,255,0.3);
            height: 8px;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: white;
            height: 100%;
            transition: width 0.3s;
        }
        
        .progress-text {
            margin-top: 8px;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .score {
            background: rgba(255,255,255,0.2);
            padding: 10px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            margin-top: 10px;
        }
        
        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ */
        .menu-screen {
            padding: 30px;
        }
        
        .menu-title {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .mode-selection {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .mode-card {
            padding: 25px 15px;
            border: 3px solid #dee2e6;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .mode-card:hover {
            border-color: #11998e;
            background: #f0fdf9;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.2);
        }
        
        .mode-card.selected {
            border-color: #11998e;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.3);
        }
        
        .mode-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        .mode-name {
            font-weight: bold;
            font-size: 14px;
        }
        
        /* è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .config-section {
            margin-bottom: 25px;
        }
        
        .config-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            color: #212529;
        }
        
        .option-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .option-grid.three-col {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .option-grid.four-col {
            grid-template-columns: 1fr 1fr 1fr 1fr;
        }
        
        .option-btn {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
        }
        
        .option-btn:hover {
            border-color: #11998e;
            background: #f0fdf9;
        }
        
        .option-btn.active {
            border-color: #11998e;
            background: #11998e;
            color: white;
        }
        
        .start-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(17, 153, 142, 0.4);
        }
        
        .start-btn:active {
            transform: translateY(0);
        }
        
        /* ã‚¯ã‚¤ã‚ºç”»é¢ */
        .quiz-screen {
            padding: 30px;
            display: none;
        }
        
        .quiz-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .scene-badge {
            background: #11998e;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .level-badge {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .question-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .context-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #856404;
            display: none;
        }
        
        .context-box.show {
            display: block;
        }
        
        .japanese-text {
            font-size: 20px;
            font-weight: bold;
            color: #212529;
            line-height: 1.6;
        }
        
        .answer-section {
            margin-bottom: 20px;
        }
        
        .answer-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            resize: vertical;
            min-height: 80px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #11998e;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .clear-btn {
            position: absolute;
            right: 10px;
            top: 10px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            display: none;
            transition: all 0.2s;
        }
        
        .clear-btn.show {
            display: block;
        }
        
        .clear-btn:hover {
            background: #5a6268;
        }
        
        .hint-box {
            background: #e7f3ff;
            border-left: 4px solid #0d6efd;
            padding: 12px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 14px;
            color: #084298;
        }
        
        .hint-box.hidden {
            display: none;
        }
        
        .answer-box {
            background: #d1ecf1;
            border-left: 4px solid #0dcaf0;
            padding: 12px 15px;
            margin-top: 15px;
            border-radius: 5px;
            font-size: 16px;
            color: #055160;
            font-weight: bold;
        }
        
        .answer-box.hidden {
            display: none;
        }
        
        .result-box {
            margin-top: 15px;
        }
        
        .result-box.hidden {
            display: none;
        }
        
        .result {
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }
        
        .result.correct {
            background: #d1e7dd;
            color: #0f5132;
            border: 2px solid #badbcc;
        }
        
        .result.incorrect {
            background: #f8d7da;
            color: #842029;
            border: 2px solid #f5c2c7;
        }
        
        .result.warning {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffe69c;
        }
        
        .correct-answer {
            margin-top: 10px;
            font-size: 14px;
            font-weight: normal;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        
        .button-group.single {
            grid-template-columns: 1fr;
        }
        
        .button-group.triple {
            grid-template-columns: 1fr 1fr 1fr;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-outline {
            background: white;
            color: #11998e;
            border: 2px solid #11998e;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .nav-btn {
            padding: 12px 25px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .nav-btn:hover {
            background: #5a6268;
        }
        
        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stats-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            text-align: center;
        }
        
        .stat-item {
            padding: 10px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #11998e;
        }
        
        .stat-label {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* çµæœç”»é¢ */
        .results-screen {
            padding: 40px 30px;
            text-align: center;
            display: none;
        }
        
        .results-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }
        
        .results-title {
            font-size: 28px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 30px;
        }
        
        .results-stats {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-size: 16px;
            color: #6c757d;
        }
        
        .result-value {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
        }
        
        /* ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ç”»é¢ */
        .practice-screen {
            padding: 30px;
            display: none;
        }
        
        .practice-box {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .practice-japanese {
            font-size: 18px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 15px;
        }
        
        .practice-english {
            font-size: 20px;
            color: #11998e;
            font-weight: bold;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }
        
        .recording-box {
            background: white;
            border: 3px dashed #dee2e6;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            text-align: center;
        }
        
        .record-btn {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-size: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(17, 153, 142, 0.3);
            margin-bottom: 15px;
        }
        
        .record-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(17, 153, 142, 0.4);
        }
        
        .record-btn.recording {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .record-text {
            font-size: 16px;
            font-weight: bold;
            color: #212529;
        }
        
        .recognition-result {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            min-height: 60px;
            font-size: 16px;
            color: #084298;
        }
        
        .score-display {
            background: #d1e7dd;
            border: 2px solid #badbcc;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 18px;
            font-weight: bold;
            color: #0f5132;
            text-align: center;
        }
        
        .score-display.hidden {
            display: none;
        }
        
        /* AIãƒãƒ£ãƒƒãƒˆç”»é¢ */
        .aichat-screen {
            padding: 30px;
            display: none;
        }
        
        .aichat-setup {
            /* è¨­å®šç”»é¢ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã¯æ—¢å­˜ã® config-section ã‚’ä½¿ç”¨ */
        }
        
        .aichat-active {
            /* display: block; ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º */
        }
        
        .aichat-active.hidden {
            display: none;
        }
        
        .chat-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .chat-message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .chat-message.user {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.ai {
            background: white;
            color: #212529;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chat-message.loading {
            background: white;
            color: #6c757d;
            margin-right: auto;
            font-style: italic;
            animation: fadeInOut 1.5s infinite;
        }
        
        @keyframes fadeInOut {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
        
        .chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 25px;
            font-size: 15px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #11998e;
        }
        
        .chat-send-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .chat-send-btn:hover {
            transform: scale(1.05);
        }
        
        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* çµ±è¨ˆç”»é¢ */
        .stats-screen {
            padding: 30px;
            display: none;
        }
        
        .stats-title {
            font-size: 24px;
            font-weight: bold;
            color: #212529;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stats-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stats-card-value {
            font-size: 36px;
            font-weight: bold;
            color: #11998e;
            margin-bottom: 10px;
        }
        
        .stats-card-label {
            font-size: 14px;
            color: #6c757d;
        }
        
        /* ç”»é¢ã®è¡¨ç¤º/éè¡¨ç¤º */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
        @media (max-width: 600px) {
            .mode-selection {
                grid-template-columns: 1fr 1fr;
            }
            
            .option-grid.three-col,
            .option-grid.four-col {
                grid-template-columns: 1fr 1fr;
            }
            
            .stats-box {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* APIè¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .api-config {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .api-config-title {
            font-size: 16px;
            font-weight: bold;
            color: #856404;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .api-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffe69c;
            border-radius: 8px;
            font-size: 14px;
            font-family: monospace;
            margin-bottom: 10px;
        }
        
        .api-input:focus {
            outline: none;
            border-color: #ffc107;
        }
        
        .api-help-text {
            font-size: 13px;
            color: #856404;
            line-height: 1.5;
        }
        
        .api-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .api-status.connected {
            background: #d1e7dd;
            color: #0f5132;
        }
        
        .api-status.disconnected {
            background: #f8d7da;
            color: #842029;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="header">
            <h1>ğŸï¸ ãƒãƒ¯ã‚¤è‹±ä¼šè©±ã‚¯ã‚¤ã‚º</h1>
            <div class="ai-badge">ğŸ¤– Powered by Google Gemini AI</div>
            <div class="progress-bar" style="display: none;">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText" style="display: none;"></div>
            <div class="score" id="scoreDisplay" style="display: none;">
                æ­£è§£: <span id="score">0</span> / <span id="total">0</span>
            </div>
        </div>
        
        <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ -->
        <div class="menu-screen screen active" id="menuScreen">
            <div class="menu-title">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
            
            <div class="mode-selection">
                <div class="mode-card" onclick="selectMode('quiz')">
                    <div class="mode-icon">ğŸ“</div>
                    <div class="mode-name">ã‚¯ã‚¤ã‚º</div>
                </div>
                
                <div class="mode-card" onclick="selectMode('practice')">
                    <div class="mode-icon">ğŸ¤</div>
                    <div class="mode-name">ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°</div>
                </div>
                
                <div class="mode-card" onclick="selectMode('aichat')">
                    <div class="mode-icon">ğŸ¤–</div>
                    <div class="mode-name">AIãƒãƒ£ãƒƒãƒˆ</div>
                </div>
            </div>
            
            <!-- è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆã‚¯ã‚¤ã‚ºãƒ»ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°å…±é€šï¼‰ -->
            <div id="quizSettings" style="display: none;">
                <div class="config-section">
                    <div class="config-title">ğŸ“ ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ</div>
                    <div class="option-grid four-col">
                        <button class="option-btn active" data-scene="all" onclick="selectScene('all')">å…¨ã¦</button>
                        <button class="option-btn" data-scene="frequent" onclick="selectScene('frequent')">é »å‡º</button>
                        <button class="option-btn" data-scene="airport" onclick="selectScene('airport')">ç©ºæ¸¯</button>
                        <button class="option-btn" data-scene="hotel" onclick="selectScene('hotel')">ãƒ›ãƒ†ãƒ«</button>
                        <button class="option-btn" data-scene="transport" onclick="selectScene('transport')">äº¤é€š</button>
                        <button class="option-btn" data-scene="food" onclick="selectScene('food')">é£Ÿäº‹</button>
                        <button class="option-btn" data-scene="shopping" onclick="selectScene('shopping')">è²·ã„ç‰©</button>
                        <button class="option-btn" data-scene="emergency" onclick="selectScene('emergency')">ç·Šæ€¥</button>
                        <button class="option-btn" data-scene="smalltalk" onclick="selectScene('smalltalk')">ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯</button>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-title">ğŸ“Š ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</div>
                    <div class="option-grid">
                        <button class="option-btn active" data-level="all" onclick="selectLevel('all')">å…¨ã¦</button>
                        <button class="option-btn" data-level="beginner" onclick="selectLevel('beginner')">åˆç´š</button>
                        <button class="option-btn" data-level="advanced" onclick="selectLevel('advanced')">ä¸Šç´š</button>
                    </div>
                </div>
                
                <button class="start-btn" onclick="startSelectedMode()">ğŸš€ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
            
            <!-- çµ±è¨ˆãƒœã‚¿ãƒ³ -->
            <div class="button-group single" style="margin-top: 20px;">
                <button class="btn btn-outline" onclick="showStats()">ğŸ“Š çµ±è¨ˆã‚’è¦‹ã‚‹</button>
            </div>
        </div>
        
        <!-- ã‚¯ã‚¤ã‚ºç”»é¢ -->
        <div class="quiz-screen screen" id="quizScreen">
            <div class="quiz-header">
                <span class="scene-badge" id="scene">å…¨ã‚·ãƒ¼ãƒ³</span>
                <span class="level-badge" id="levelBadge">å…¨ãƒ¬ãƒ™ãƒ«</span>
            </div>
            
            <div class="question-box">
                <div class="context-box" id="contextBox"></div>
                <div class="japanese-text" id="japanese">æ—¥æœ¬èªã®è³ªå•ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
            </div>
            
            <div class="answer-section">
                <div class="input-wrapper">
                    <textarea 
                        class="answer-input" 
                        id="answerInput" 
                        placeholder="è‹±èªã§ç­”ãˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...&#10;(2è¡Œã¾ã§è¡¨ç¤ºã•ã‚Œã¾ã™)"
                        rows="2"
                    ></textarea>
                    <button class="clear-btn" id="clearBtn" onclick="clearInput()">âœ•</button>
                </div>
                <div class="hint-box hidden" id="hintBox"></div>
                <div class="answer-box hidden" id="answerBox"></div>
                <div class="result-box hidden" id="resultBox"></div>
            </div>
            
            <div class="button-group triple">
                <button class="btn btn-outline" id="hintBtn" onclick="toggleHint()">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
                <button class="btn btn-outline" onclick="speakAnswer()">ğŸ”Š èã</button>
                <button class="btn btn-outline" onclick="speakAnswerSlow()">ğŸ¢ ã‚†ã£ãã‚Š</button>
            </div>
            
            <div class="button-group">
                <button class="btn btn-secondary" id="showAnswerBtn" onclick="toggleAnswer()">ğŸ‘ï¸ æ­£è§£ã‚’è¦‹ã‚‹</button>
                <button class="btn btn-outline" onclick="toggleVoiceInput()" id="voiceBtn">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="checkAnswer()">âœ“ å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯</button>
            </div>
            
            <div class="navigation-buttons">
                <button class="nav-btn" onclick="previousQuestion()" id="prevBtn">â† å‰ã¸</button>
                <button class="nav-btn" onclick="nextQuestion()" id="nextBtn">æ¬¡ã¸ â†’</button>
            </div>
            
            <div class="stats-box">
                <div class="stat-item">
                    <div class="stat-value" id="correct">0</div>
                    <div class="stat-label">æ­£è§£</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="incorrect">0</div>
                    <div class="stat-label">ä¸æ­£è§£</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="accuracy">0%</div>
                    <div class="stat-label">æ­£è§£ç‡</div>
                </div>
            </div>
            
            <div class="button-group single" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="showMenu()">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
        
        <!-- çµæœç”»é¢ -->
        <div class="results-screen screen" id="resultsScreen">
            <div class="results-icon">ğŸ‰</div>
            <div class="results-title">ãŠç–²ã‚Œæ§˜ã§ã—ãŸ!</div>
            
            <div class="results-stats">
                <div class="result-item">
                    <span class="result-label">æ­£è§£æ•°</span>
                    <span class="result-value" id="finalCorrect">0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">ä¸æ­£è§£æ•°</span>
                    <span class="result-value" id="finalIncorrect">0</span>
                </div>
                <div class="result-item">
                    <span class="result-label">æ­£è§£ç‡</span>
                    <span class="result-value" id="finalAccuracy">0%</span>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-primary" onclick="retryQuiz()">ğŸ”„ ã‚‚ã†ä¸€åº¦</button>
                <button class="btn btn-secondary" onclick="showMenu()">ğŸ  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸</button>
            </div>
        </div>
        
        <!-- ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ç”»é¢ -->
        <div class="practice-screen screen" id="practiceScreen">
            <div class="practice-box">
                <div class="practice-japanese" id="practiceJapanese">æ—¥æœ¬èªãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
                <div class="practice-english" id="practiceEnglish">English answer will be shown here</div>
            </div>
            
            <div class="recording-box">
                <button class="record-btn" id="recordBtn" onclick="togglePracticeRecording()">
                    <span id="recordIcon">ğŸ¤</span>
                </button>
                <div class="record-text" id="recordText">éŒ²éŸ³é–‹å§‹</div>
                <div class="recognition-result" id="recognitionResult">
                    ã“ã“ã«éŸ³å£°èªè­˜çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                </div>
                <div class="score-display hidden" id="scoreDisplay2">
                    ã‚¹ã‚³ã‚¢: <span id="practiceScore">0</span>%
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn btn-outline" onclick="speakPracticeAnswer()">ğŸ”Š ãŠæ‰‹æœ¬ã‚’èã</button>
                <button class="btn btn-primary" onclick="nextPracticePhrase()">æ¬¡ã®ãƒ•ãƒ¬ãƒ¼ã‚º â†’</button>
            </div>
            
            <div class="stats-box">
                <div class="stat-item">
                    <div class="stat-value" id="practiceCorrect">0</div>
                    <div class="stat-label">æ­£è§£</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="practiceIncorrect">0</div>
                    <div class="stat-label">ä¸æ­£è§£</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="practiceAccuracy">0%</div>
                    <div class="stat-label">æ­£è§£ç‡</div>
                </div>
            </div>
            
            <div class="button-group single" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="showMenu()">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
        
        <!-- AIãƒãƒ£ãƒƒãƒˆç”»é¢ -->
        <div class="aichat-screen screen" id="aichatScreen">
            <!-- APIè¨­å®š -->
            <div class="api-config">
                <div class="api-config-title">
                    âš™ï¸ Cloudflare Worker URLè¨­å®š
                    <span class="api-status disconnected" id="apiStatus">æœªè¨­å®š</span>
                </div>
                <input 
                    type="text" 
                    class="api-input" 
                    id="workerUrl" 
                    placeholder="https://hawaii-quiz-ai.YOUR-SUBDOMAIN.workers.dev"
                    value=""
                />
                <div class="api-help-text">
                    ğŸ’¡ ã‚¹ãƒ†ãƒƒãƒ—2ã§ä½œæˆã—ãŸCloudflare Worker URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
                    å…¥åŠ›å¾Œã€è‡ªå‹•çš„ã«ä¿å­˜ã•ã‚Œã¾ã™
                </div>
            </div>
            
            <!-- è¨­å®šç”»é¢ -->
            <div class="aichat-setup" id="aichatSetup">
                <div class="config-section">
                    <div class="config-title">ğŸ¯ ä¼šè©±ã‚·ãƒ¼ãƒ³ã‚’é¸æŠ</div>
                    <div class="option-grid three-col">
                        <button class="option-btn active" data-aiscene="freetalk" onclick="selectAIScene('freetalk')">ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯</button>
                        <button class="option-btn" data-aiscene="airport" onclick="selectAIScene('airport')">ç©ºæ¸¯</button>
                        <button class="option-btn" data-aiscene="hotel" onclick="selectAIScene('hotel')">ãƒ›ãƒ†ãƒ«</button>
                        <button class="option-btn" data-aiscene="restaurant" onclick="selectAIScene('restaurant')">ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³</button>
                        <button class="option-btn" data-aiscene="shopping" onclick="selectAIScene('shopping')">ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°</button>
                        <button class="option-btn" data-aiscene="sightseeing" onclick="selectAIScene('sightseeing')">è¦³å…‰</button>
                    </div>
                </div>
                
                <div class="config-section">
                    <div class="config-title">ğŸ“Š é›£æ˜“åº¦ã‚’é¸æŠ</div>
                    <div class="option-grid">
                        <button class="option-btn active" data-ailevel="beginner" onclick="selectAILevel('beginner')">åˆç´š</button>
                        <button class="option-btn" data-ailevel="intermediate" onclick="selectAILevel('intermediate')">ä¸­ç´š</button>
                        <button class="option-btn" data-ailevel="advanced" onclick="selectAILevel('advanced')">ä¸Šç´š</button>
                    </div>
                </div>
                
                <button class="start-btn" onclick="startAIChat()">ğŸ’¬ ä¼šè©±ã‚’é–‹å§‹</button>
            </div>
            
            <!-- ãƒãƒ£ãƒƒãƒˆç”»é¢ -->
            <div class="aichat-active hidden" id="aichatActive">
                <div class="chat-container" id="chatContainer">
                    <!-- ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                
                <div class="chat-input-container">
                    <input 
                        type="text" 
                        class="chat-input" 
                        id="chatInput" 
                        placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..."
                    />
                    <button class="chat-send-btn" id="sendBtn" onclick="sendChatMessage()">ğŸ“¤</button>
                </div>
                
                <div class="button-group single" style="margin-top: 15px;">
                    <button class="btn btn-secondary" onclick="endAIChat()">â† è¨­å®šã«æˆ»ã‚‹</button>
                </div>
            </div>
            
            <div class="button-group single" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="showMenu()">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
        
        <!-- çµ±è¨ˆç”»é¢ -->
        <div class="stats-screen screen" id="statsScreen">
            <div class="stats-title">ğŸ“Š ã‚ãªãŸã®å­¦ç¿’çµ±è¨ˆ</div>
            
            <div class="stats-grid">
                <div class="stats-card">
                    <div class="stats-card-value" id="totalSessions">0</div>
                    <div class="stats-card-label">å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°</div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-value" id="totalCorrectStats">0</div>
                    <div class="stats-card-label">ç´¯è¨ˆæ­£è§£æ•°</div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-value" id="totalQuestionsStats">0</div>
                    <div class="stats-card-label">ç´¯è¨ˆå›ç­”æ•°</div>
                </div>
                
                <div class="stats-card">
                    <div class="stats-card-value" id="averageAccuracy">0%</div>
                    <div class="stats-card-label">å¹³å‡æ­£è§£ç‡</div>
                </div>
            </div>
            
            <div class="button-group single">
                <button class="btn btn-secondary" onclick="showMenu()">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
// ============================================
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
// ============================================

let currentMode = '';
let selectedScene = 'all';
let selectedLevel = 'all';
let currentQuestions = [];
let currentQuestionIndex = 0;
let correctCount = 0;
let incorrectCount = 0;
let isAnswerShown = false;

// éŸ³å£°èªè­˜
let recognition = null;
let isRecording = false;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;
    
    recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('answerInput').value = transcript;
        document.getElementById('clearBtn').classList.add('show');
    };
    
    recognition.onend = function() {
        isRecording = false;
        document.getElementById('voiceBtn').textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
    };
}

// ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’ç”¨
let practiceQuestions = [];
let currentPracticeIndex = 0;
let practiceCorrectCount = 0;
let practiceIncorrectCount = 0;

let practiceRecognition = null;
let isPracticeRecording = false;
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    practiceRecognition = new SpeechRecognition();
    practiceRecognition.lang = 'en-US';
    practiceRecognition.continuous = false;
    practiceRecognition.interimResults = false;
    
    practiceRecognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById('recognitionResult').textContent = `ã‚ãªãŸ: "${transcript}"`;
        
        const currentPhrase = practiceQuestions[currentPracticeIndex];
        if (isAnswerCorrect(transcript, currentPhrase.english)) {
            practiceCorrectCount++;
            document.getElementById('scoreDisplay2').innerHTML = 'âœ… æ­£è§£ã§ã™! ç´ æ™´ã‚‰ã—ã„!';
            document.getElementById('scoreDisplay2').style.background = '#d1e7dd';
            document.getElementById('scoreDisplay2').style.color = '#0f5132';
        } else {
            practiceIncorrectCount++;
            document.getElementById('scoreDisplay2').innerHTML = `âŒ ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦!<br>æ­£è§£: ${currentPhrase.english}`;
            document.getElementById('scoreDisplay2').style.background = '#f8d7da';
            document.getElementById('scoreDisplay2').style.color = '#842029';
        }
        document.getElementById('scoreDisplay2').classList.remove('hidden');
        
        updatePracticeStats();
    };
    
    practiceRecognition.onend = function() {
        isPracticeRecording = false;
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordIcon').textContent = 'ğŸ¤';
        document.getElementById('recordText').textContent = 'éŒ²éŸ³é–‹å§‹';
    };
}

// AIãƒãƒ£ãƒƒãƒˆç”¨
let aiChatScene = 'freetalk';
let aiChatLevel = 'beginner';
let chatHistory = [];
let workerApiUrl = '';

// ã‚·ãƒ¼ãƒ³åãƒãƒƒãƒ”ãƒ³ã‚°
const sceneNames = {
    frequent: 'é »å‡º',
    airport: 'ç©ºæ¸¯',
    hotel: 'ãƒ›ãƒ†ãƒ«',
    transport: 'äº¤é€š',
    food: 'é£Ÿäº‹',
    shopping: 'è²·ã„ç‰©',
    emergency: 'ç·Šæ€¥',
    smalltalk: 'ã‚¹ãƒ¢ãƒ¼ãƒ«ãƒˆãƒ¼ã‚¯'
};

// æ—¥æœ¬èªã‚·ãƒ¼ãƒ³åãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆAIãƒãƒ£ãƒƒãƒˆç”¨ï¼‰
const aiSceneNames = {
    freetalk: 'ãƒ•ãƒªãƒ¼ãƒˆãƒ¼ã‚¯',
    airport: 'ç©ºæ¸¯',
    hotel: 'ãƒ›ãƒ†ãƒ«',
    restaurant: 'ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³',
    shopping: 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°',
    sightseeing: 'è¦³å…‰'
};

// æ—¥æœ¬èªãƒ¬ãƒ™ãƒ«åãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆAIãƒãƒ£ãƒƒãƒˆç”¨ï¼‰
const aiLevelNames = {
    beginner: 'åˆç´š',
    intermediate: 'ä¸­ç´š',
    advanced: 'ä¸Šç´š'
};

// ============================================
// ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
// ============================================

const phrasesDatabase = {
    frequent: [
        { japanese: "ã™ã¿ã¾ã›ã‚“", english: "Excuse me", hint: "ä¸å¯§ã«è©±ã—ã‹ã‘ã‚‹æ™‚", level: "beginner" },
        { japanese: "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™", english: "Thank you", hint: "æ„Ÿè¬ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ãŠé¡˜ã„ã—ã¾ã™", english: "Please", hint: "ä¾é ¼ã™ã‚‹æ™‚", level: "beginner" },
        { japanese: "ã©ã†ã„ãŸã—ã¾ã—ã¦", english: "You're welcome", hint: "ãŠç¤¼ã¸ã®è¿”ç­”", level: "beginner" },
        { japanese: "ã¯ã„", english: "Yes", hint: "è‚¯å®šã®è¿”äº‹", level: "beginner" },
        { japanese: "ã„ã„ãˆ", english: "No", hint: "å¦å®šã®è¿”äº‹", level: "beginner" },
        { japanese: "å¤§ä¸ˆå¤«ã§ã™", english: "It's okay", hint: "å•é¡Œãªã„ã¨ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ã‚ã‹ã‚Šã¾ã—ãŸ", english: "I understand", hint: "ç†è§£ã—ãŸã¨ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ã”ã‚ã‚“ãªã•ã„", english: "I'm sorry", hint: "è¬ç½ªã™ã‚‹æ™‚", level: "beginner" },
        { japanese: "åŠ©ã‘ã¦ãã ã•ã„", english: "Help me, please", hint: "åŠ©ã‘ã‚’æ±‚ã‚ã‚‹", level: "beginner" },
        { japanese: "ã‚‚ã†ä¸€åº¦è¨€ã£ã¦ãã ã•ã„", english: "Could you say that again?", hint: "èãè¿”ã™æ™‚", level: "beginner" },
        { japanese: "ã‚†ã£ãã‚Šè©±ã—ã¦ãã ã•ã„", english: "Please speak slowly", hint: "ã‚†ã£ãã‚Šè©±ã—ã¦ã»ã—ã„æ™‚", level: "beginner" },
        { japanese: "è‹±èªãŒè©±ã›ã¾ã›ã‚“", english: "I don't speak English", hint: "è‹±èªãŒè‹¦æ‰‹ã¨ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "æ—¥æœ¬èªã‚’è©±ã›ã¾ã™ã‹?", english: "Do you speak Japanese?", hint: "æ—¥æœ¬èªå¯¾å¿œã‚’ç¢ºèª", level: "beginner" },
        { japanese: "ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹?", english: "Where is the restroom?", hint: "ãƒˆã‚¤ãƒ¬ã®å ´æ‰€ã‚’èã", level: "beginner" },
        { japanese: "ã„ãã‚‰ã§ã™ã‹?", english: "How much is it?", hint: "å€¤æ®µã‚’èã", level: "beginner" },
        { japanese: "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹?", english: "Do you accept credit cards?", hint: "æ”¯æ‰•ã„æ–¹æ³•ã‚’ç¢ºèª", level: "beginner" },
        { japanese: "ã“ã‚Œã‚’ãã ã•ã„", english: "I'll take this", hint: "å•†å“ã‚’é¸ã¶æ™‚", level: "beginner" },
        { japanese: "å†™çœŸã‚’æ’®ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹?", english: "Could you take a picture?", hint: "å†™çœŸæ’®å½±ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹?", english: "What do you recommend?", hint: "ãŠã™ã™ã‚ã‚’èã", level: "beginner" },
        { japanese: "ã“ã‚Œã¯ä½•ã§ã™ã‹?", english: "What is this?", hint: "ç‰©ã«ã¤ã„ã¦èã", level: "beginner" },
        { japanese: "Wi-Fiã¯ã‚ã‚Šã¾ã™ã‹?", english: "Do you have Wi-Fi?", hint: "Wi-Fiç’°å¢ƒã‚’ç¢ºèª", level: "beginner" },
        { japanese: "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½•ã§ã™ã‹?", english: "What's the password?", hint: "Wi-Fiãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’èã", level: "beginner" },
        { japanese: "ã“ã“ã«åº§ã£ã¦ã‚‚ã„ã„ã§ã™ã‹?", english: "Can I sit here?", hint: "åº§å¸­ã®ä½¿ç”¨è¨±å¯ã‚’å¾—ã‚‹", level: "beginner" },
        { japanese: "ã©ã®ãã‚‰ã„æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã‹?", english: "How long does it take?", hint: "æ‰€è¦æ™‚é–“ã‚’ç¢ºèª", level: "beginner" }
    ],
    airport: [
        { japanese: "æ­ä¹—åˆ¸ã¯ã“ã‚Œã§ã™", english: "Here's my boarding pass", hint: "æ­ä¹—åˆ¸ã‚’è¦‹ã›ã‚‹", level: "beginner" },
        { japanese: "é ã‘ã‚‹è·ç‰©ãŒ1ã¤ã‚ã‚Šã¾ã™", english: "I have one bag to check", hint: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§", level: "beginner" },
        { japanese: "çª“å´ã®å¸­ã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "I'd like a window seat, please", hint: "åº§å¸­ã®å¸Œæœ›ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "é€šè·¯å´ã®å¸­ã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "I'd like an aisle seat, please", hint: "åº§å¸­ã®å¸Œæœ›ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ã‚²ãƒ¼ãƒˆã¯ã©ã“ã§ã™ã‹?", english: "Where is the gate?", hint: "æ­ä¹—ã‚²ãƒ¼ãƒˆã‚’æ¢ã™", level: "beginner" },
        { japanese: "æ­ä¹—æ™‚é–“ã¯ä½•æ™‚ã§ã™ã‹?", english: "What time is boarding?", hint: "æ­ä¹—é–‹å§‹æ™‚åˆ»ã‚’ç¢ºèª", level: "beginner" },
        { japanese: "ä¹—ã‚Šç¶™ãã®æ¡ˆå†…ã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "I need help with my connection", hint: "ä¹—ã‚Šç¶™ãã‚µãƒãƒ¼ãƒˆã‚’ä¾é ¼", level: "beginner", context: "ä¹—ã‚Šç¶™ãä¾¿ãŒã‚ã‚‹å ´åˆ" },
        { japanese: "è·ç‰©ãŒå‡ºã¦ãã¾ã›ã‚“", english: "My luggage hasn't come out", hint: "è·ç‰©ã®ç´›å¤±ã‚’å ±å‘Š", level: "beginner" },
        { japanese: "ç¨é–¢ç”³å‘Šã™ã‚‹ã‚‚ã®ã¯ã‚ã‚Šã¾ã›ã‚“", english: "I have nothing to declare", hint: "ç¨é–¢ã§ç”³å‘Šãªã—ã¨ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "è¦³å…‰ç›®çš„ã§ã™", english: "I'm here for sightseeing", hint: "å…¥å›½å¯©æŸ»ã§ç›®çš„ã‚’ç­”ãˆã‚‹", level: "beginner" },
        { japanese: "5æ—¥é–“æ»åœ¨ã—ã¾ã™", english: "I'm staying for 5 days", hint: "æ»åœ¨æœŸé–“ã‚’ç­”ãˆã‚‹", level: "beginner" },
        { japanese: "ãƒ›ãƒ†ãƒ«ã«æ³Šã¾ã‚Šã¾ã™", english: "I'm staying at a hotel", hint: "å®¿æ³Šå…ˆã‚’ç­”ãˆã‚‹", level: "beginner" },
        { japanese: "æ©Ÿå†…æŒã¡è¾¼ã¿è·ç‰©ã ã‘ã§ã™", english: "I only have carry-on luggage", hint: "é ã‘è·ç‰©ãŒãªã„å ´åˆ", level: "beginner" },
        { japanese: "æ¶²ä½“ç‰©ã‚’æŒã£ã¦ã„ã¾ã™", english: "I have liquids", hint: "ä¿å®‰æ¤œæŸ»å ´ã§ç”³å‘Š", level: "beginner", context: "æ¶²ä½“ç‰©ã‚’æ©Ÿå†…æŒã¡è¾¼ã¿ã™ã‚‹å ´åˆ" },
        { japanese: "ãƒãƒ¼ãƒˆãƒ‘ã‚½ã‚³ãƒ³ã‚’æŒã£ã¦ã„ã¾ã™", english: "I have a laptop", hint: "ä¿å®‰æ¤œæŸ»å ´ã§ç”³å‘Š", level: "beginner" },
        { japanese: "é´ã‚’è„±ãã¾ã™ã‹?", english: "Do I need to take off my shoes?", hint: "ä¿å®‰æ¤œæŸ»ã§ã®ç¢ºèª", level: "beginner" },
        { japanese: "ãƒ™ãƒ«ãƒˆã‚’å¤–ã—ã¾ã™ã‹?", english: "Do I need to remove my belt?", hint: "ä¿å®‰æ¤œæŸ»ã§ã®ç¢ºèª", level: "beginner" },
        { japanese: "ã“ã®ä¾¿ã¯é…ã‚Œã¦ã„ã¾ã™ã‹?", english: "Is this flight delayed?", hint: "é…å»¶çŠ¶æ³ã‚’ç¢ºèª", level: "beginner" },
        { japanese: "åº§å¸­ã‚’å¤‰æ›´ã§ãã¾ã™ã‹?", english: "Can I change my seat?", hint: "åº§å¸­å¤‰æ›´ã‚’ä¾é ¼", level: "advanced" },
        { japanese: "è·ç‰©ã®é‡é‡åˆ¶é™ã¯ä½•ã‚­ãƒ­ã§ã™ã‹?", english: "What's the baggage weight limit?", hint: "é‡é‡åˆ¶é™ã‚’ç¢ºèª", level: "advanced" },
        { japanese: "è¶…éæ–™é‡‘ã¯ã„ãã‚‰ã§ã™ã‹?", english: "How much is the excess baggage fee?", hint: "è¶…éæ–™é‡‘ã‚’èã", level: "advanced", context: "è·ç‰©ãŒé‡é‡ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆ" }
    ],
    hotel: [
        { japanese: "ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "I'd like to check in", hint: "ãƒ•ãƒ­ãƒ³ãƒˆã§æœ€åˆã«è¨€ã†", level: "beginner" },
        { japanese: "äºˆç´„ã—ã¦ã„ã¾ã™", english: "I have a reservation", hint: "äºˆç´„ãŒã‚ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "åå‰ã¯ç”°ä¸­ã§ã™", english: "My name is Tanaka", hint: "åå‰ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "éƒ¨å±‹ã®éµã‚’ãã ã•ã„", english: "Can I have the room key?", hint: "éµã‚’å—ã‘å–ã‚‹", level: "beginner" },
        { japanese: "Wi-Fiã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ä½•ã§ã™ã‹?", english: "What's the Wi-Fi password?", hint: "Wi-Fiæ¥ç¶šæƒ…å ±ã‚’èã", level: "beginner" },
        { japanese: "æœé£Ÿã¯ä½•æ™‚ã‹ã‚‰ã§ã™ã‹?", english: "What time is breakfast?", hint: "æœé£Ÿæ™‚é–“ã‚’ç¢ºèª", level: "beginner" },
        { japanese: "ãƒ—ãƒ¼ãƒ«ã¯ã‚ã‚Šã¾ã™ã‹?", english: "Do you have a pool?", hint: "æ–½è¨­ã«ã¤ã„ã¦èã", level: "beginner" },
        { japanese: "ã‚¿ã‚ªãƒ«ã‚’ã‚‚ã‚‰ãˆã¾ã™ã‹?", english: "Can I get some towels?", hint: "è¿½åŠ ã®ã‚¿ã‚ªãƒ«ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "éƒ¨å±‹ã‚’æƒé™¤ã—ã¦ãã ã•ã„", english: "Please clean my room", hint: "ãƒã‚¦ã‚¹ã‚­ãƒ¼ãƒ”ãƒ³ã‚°ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "I'd like to check out", hint: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæ™‚", level: "beginner" },
        { japanese: "é ˜åæ›¸ã‚’ãã ã•ã„", english: "Can I have a receipt?", hint: "é ˜åæ›¸ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "è·ç‰©ã‚’é ã‹ã£ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹?", english: "Can you keep my luggage?", hint: "è·ç‰©é ã‹ã‚Šã‚’ä¾é ¼", level: "beginner", context: "ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå¾Œã‚‚è¦³å…‰ã™ã‚‹å ´åˆ" },
        { japanese: "ã‚¿ã‚¯ã‚·ãƒ¼ã‚’å‘¼ã‚“ã§ã‚‚ã‚‰ãˆã¾ã™ã‹?", english: "Can you call a taxi?", hint: "ã‚¿ã‚¯ã‚·ãƒ¼æ‰‹é…ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ãŠã™ã™ã‚ã®ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã¯ã‚ã‚Šã¾ã™ã‹?", english: "Can you recommend a restaurant?", hint: "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³æƒ…å ±ã‚’èã", level: "advanced" }
    ],
    transport: [
        { japanese: "ãƒ¯ã‚¤ã‚­ã‚­ã¾ã§ãŠé¡˜ã„ã—ã¾ã™", english: "To Waikiki, please", hint: "ã‚¿ã‚¯ã‚·ãƒ¼ã§è¡Œãå…ˆã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ã„ãã‚‰ã‹ã‹ã‚Šã¾ã™ã‹?", english: "How much will it cost?", hint: "æ–™é‡‘ã‚’äº‹å‰ã«ç¢ºèª", level: "beginner" },
        { japanese: "ã“ã“ã§é™ã‚Šã¾ã™", english: "I'll get off here", hint: "é™è»Šæ™‚ã«ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ãŠé‡£ã‚Šã‚’ãã ã•ã„", english: "Can I have change?", hint: "ãŠé‡£ã‚Šã‚’æ±‚ã‚ã‚‹", level: "beginner", context: "ç¾é‡‘æ‰•ã„ã§ãŠé‡£ã‚ŠãŒå¿…è¦ãªå ´åˆ" },
        { japanese: "ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ãã ã•ã„", english: "Can I have a receipt?", hint: "é ˜åæ›¸ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰ãƒ˜ãƒƒãƒ‰ã¸ã¯ã©ã†è¡Œãã¾ã™ã‹?", english: "How do I get to Diamond Head?", hint: "è¡Œãæ–¹ã‚’å°‹ã­ã‚‹", level: "beginner" },
        { japanese: "ãƒã‚¹åœã¯ã©ã“ã§ã™ã‹?", english: "Where's the bus stop?", hint: "ãƒã‚¹åœã®å ´æ‰€ã‚’èã", level: "beginner" },
        { japanese: "ã“ã®ãƒã‚¹ã¯ãƒ¯ã‚¤ã‚­ã‚­ã«è¡Œãã¾ã™ã‹?", english: "Does this bus go to Waikiki?", hint: "ãƒã‚¹ã®è¡Œãå…ˆã‚’ç¢ºèª", level: "beginner" },
        { japanese: "1æ—¥åˆ¸ã‚’ãã ã•ã„", english: "One day pass, please", hint: "ãƒã‚¹ã®1æ—¥åˆ¸ã‚’è³¼å…¥", level: "advanced", context: "ãƒã‚¹ã‚’ä½•åº¦ã‚‚åˆ©ç”¨ã™ã‚‹å ´åˆ" }
    ],
    food: [
        { japanese: "2åã§ãŠé¡˜ã„ã—ã¾ã™", english: "Table for two, please", hint: "äººæ•°ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãã ã•ã„", english: "Can I see the menu?", hint: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ã“ã‚Œã‚’ãã ã•ã„", english: "I'll have this", hint: "ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æŒ‡å·®ã—ã¦æ³¨æ–‡", level: "beginner" },
        { japanese: "æ°´ã‚’ãã ã•ã„", english: "Water, please", hint: "é£²ã¿ç‰©ã‚’æ³¨æ–‡", level: "beginner" },
        { japanese: "ãŠã™ã™ã‚ã¯ä½•ã§ã™ã‹?", english: "What do you recommend?", hint: "ãŠã™ã™ã‚ã‚’èã", level: "beginner" },
        { japanese: "ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™", english: "Check, please", hint: "ä¼šè¨ˆã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ã§æ‰•ã„ã¾ã™", english: "I'll pay by credit card", hint: "æ”¯æ‰•ã„æ–¹æ³•ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "åˆ¥ã€…ã«æ‰•ã„ã¾ã™", english: "We'll pay separately", hint: "å€‹åˆ¥ä¼šè¨ˆã‚’ä¾é ¼", level: "beginner", context: "å‹äººã¨åˆ¥ã€…ã«æ”¯æ‰•ã†å ´åˆ" },
        { japanese: "ã“ã‚Œã¯ä½•ã§ã™ã‹?", english: "What's this?", hint: "æ–™ç†ã«ã¤ã„ã¦èã", level: "beginner" },
        { japanese: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚Šã¾ã™", english: "I have allergies", hint: "ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ã‚’ä¼ãˆã‚‹", level: "beginner", context: "é£Ÿç‰©ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼ãŒã‚ã‚‹å ´åˆ" },
        { japanese: "è¾›ãã—ãªã„ã§ãã ã•ã„", english: "Not spicy, please", hint: "è¾›ã•ã‚’æ§ãˆã¦ã‚‚ã‚‰ã†", level: "beginner" },
        { japanese: "æŒã¡å¸°ã‚Šã§ãã¾ã™ã‹?", english: "Can I get this to go?", hint: "æŒã¡å¸°ã‚Šã‚’ä¾é ¼", level: "beginner", context: "é£Ÿã¹ãã‚Œãªã„æ–™ç†ãŒã‚ã‚‹å ´åˆ" },
        { japanese: "ã“ã‚Œã¨ã“ã‚Œã‚’ãã ã•ã„", english: "I'll have this and this", hint: "è¤‡æ•°ã®æ–™ç†ã‚’æ³¨æ–‡", level: "beginner" },
        { japanese: "ãƒŸãƒ‡ã‚£ã‚¢ãƒ ã§ãŠé¡˜ã„ã—ã¾ã™", english: "Medium, please", hint: "è‚‰ã®ç„¼ãåŠ æ¸›ã‚’æŒ‡å®š", level: "advanced", context: "ã‚¹ãƒ†ãƒ¼ã‚­ãªã©ã‚’æ³¨æ–‡ã™ã‚‹å ´åˆ" },
        { japanese: "ãƒ‡ã‚¶ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã™ã‹?", english: "Do you have a dessert menu?", hint: "ãƒ‡ã‚¶ãƒ¼ãƒˆã‚’æ³¨æ–‡", level: "advanced" },
        { japanese: "äºˆç´„ã—ã¦ã„ã¾ã™ã‹?", english: "Do you have a reservation?", hint: "äºˆç´„ã®æœ‰ç„¡ã‚’èã‹ã‚ŒãŸæ™‚ã®ç­”ãˆ", level: "advanced", context: "ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã§äºˆç´„ã®æœ‰ç„¡ã‚’èã‹ã‚ŒãŸå ´åˆ" },
        { japanese: "äºˆç´„ã¯ã—ã¦ã„ã¾ã›ã‚“", english: "I don't have a reservation", hint: "äºˆç´„ãªã—ã¨ä¼ãˆã‚‹", level: "advanced" }
    ],
    shopping: [
        { japanese: "è¦‹ã¦ã„ã‚‹ã ã‘ã§ã™", english: "I'm just looking", hint: "å£°ã‚’ã‹ã‘ã‚‰ã‚ŒãŸæ™‚", level: "beginner" },
        { japanese: "ã“ã‚Œã‚’è©¦ç€ã§ãã¾ã™ã‹?", english: "Can I try this on?", hint: "è©¦ç€ã‚’ä¾é ¼", level: "beginner" },
        { japanese: "ä»–ã®è‰²ã¯ã‚ã‚Šã¾ã™ã‹?", english: "Do you have other colors?", hint: "è‰²é•ã„ã‚’èã", level: "beginner" },
        { japanese: "ã‚‚ã£ã¨å®‰ã„ã®ã¯ã‚ã‚Šã¾ã™ã‹?", english: "Do you have something cheaper?", hint: "å®‰ã„å•†å“ã‚’æ¢ã™", level: "beginner" },
        { japanese: "ã“ã‚Œã‚’ãã ã•ã„", english: "I'll take this", hint: "è³¼å…¥ã‚’æ±ºå®š", level: "beginner" },
        { japanese: "è¢‹ã‚’ãã ã•ã„", english: "Can I have a bag?", hint: "è¢‹ã‚’ä¾é ¼", level: "beginner", context: "è²·ã„ç‰©è¢‹ãŒå¿…è¦ãªå ´åˆ" },
        { japanese: "è¿”å“ã§ãã¾ã™ã‹?", english: "Can I return this?", hint: "è¿”å“å¯å¦ã‚’ç¢ºèª", level: "advanced", context: "å•†å“ã«å•é¡ŒãŒã‚ã£ãŸå ´åˆ" }
    ],
    emergency: [
        { japanese: "åŠ©ã‘ã¦ãã ã•ã„", english: "Help me", hint: "ç·Šæ€¥æ™‚ã®åŠ©ã‘ã‚’æ±‚ã‚ã‚‹", level: "beginner" },
        { japanese: "æ•‘æ€¥è»Šã‚’å‘¼ã‚“ã§ãã ã•ã„", english: "Call an ambulance", hint: "æ•‘æ€¥è»Šã‚’è¦è«‹", level: "beginner" },
        { japanese: "è­¦å¯Ÿã‚’å‘¼ã‚“ã§ãã ã•ã„", english: "Call the police", hint: "è­¦å¯Ÿã‚’è¦è«‹", level: "beginner" },
        { japanese: "è²¡å¸ƒã‚’ç›—ã¾ã‚Œã¾ã—ãŸ", english: "My wallet was stolen", hint: "ç›—é›£ã‚’å ±å‘Š", level: "beginner" },
        { japanese: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆã‚’ãªãã—ã¾ã—ãŸ", english: "I lost my passport", hint: "ãƒ‘ã‚¹ãƒãƒ¼ãƒˆç´›å¤±ã‚’å ±å‘Š", level: "beginner" },
        { japanese: "æ°—åˆ†ãŒæ‚ªã„ã§ã™", english: "I feel sick", hint: "ä½“èª¿ä¸è‰¯ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "é ­ãŒç—›ã„ã§ã™", english: "I have a headache", hint: "é ­ç—›ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ãŠè…¹ãŒç—›ã„ã§ã™", english: "I have a stomachache", hint: "è…¹ç—›ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ç†±ãŒã‚ã‚Šã¾ã™", english: "I have a fever", hint: "ç™ºç†±ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "è–¬ã‚’ãã ã•ã„", english: "I need medicine", hint: "è–¬ã‚’æ±‚ã‚ã‚‹", level: "beginner" },
        { japanese: "ç—…é™¢ã«è¡ŒããŸã„ã§ã™", english: "I want to go to a hospital", hint: "ç—…é™¢ã¸ã®æ¡ˆå†…ã‚’æ±‚ã‚ã‚‹", level: "beginner" },
        { japanese: "æ—¥æœ¬èªã‚’è©±ã›ã‚‹äººã¯ã„ã¾ã™ã‹?", english: "Is there anyone who speaks Japanese?", hint: "æ—¥æœ¬èªå¯¾å¿œè€…ã‚’æ¢ã™", level: "beginner" },
        { japanese: "ä¿é™ºè¨¼ã‚’æŒã£ã¦ã„ã¾ã™", english: "I have insurance", hint: "ä¿é™ºåŠ å…¥ã‚’ä¼ãˆã‚‹", level: "advanced", context: "åŒ»ç™‚æ©Ÿé–¢ã§æ²»ç™‚ã‚’å—ã‘ã‚‹å ´åˆ" }
    ],
    smalltalk: [
        { japanese: "ã“ã‚“ã«ã¡ã¯", english: "Hello", hint: "åŸºæœ¬ã®æŒ¨æ‹¶", level: "beginner" },
        { japanese: "èª¿å­ã¯ã©ã†ã§ã™ã‹?", english: "How are you?", hint: "ç›¸æ‰‹ã®æ§˜å­ã‚’èã", level: "beginner" },
        { japanese: "å…ƒæ°—ã§ã™", english: "I'm fine", hint: "èª¿å­ã‚’ç­”ãˆã‚‹", level: "beginner" },
        { japanese: "ãŠåå‰ã¯ä½•ã§ã™ã‹?", english: "What's your name?", hint: "åå‰ã‚’èã", level: "beginner" },
        { japanese: "ç§ã®åå‰ã¯ã€œã§ã™", english: "My name is~", hint: "åå‰ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ã©ã¡ã‚‰ã‹ã‚‰æ¥ã¾ã—ãŸã‹?", english: "Where are you from?", hint: "å‡ºèº«åœ°ã‚’èã", level: "beginner" },
        { japanese: "æ—¥æœ¬ã‹ã‚‰æ¥ã¾ã—ãŸ", english: "I'm from Japan", hint: "å‡ºèº«åœ°ã‚’ç­”ãˆã‚‹", level: "beginner" },
        { japanese: "å¤©æ°—ãŒã„ã„ã§ã™ã­", english: "Nice weather", hint: "å¤©æ°—ã®è©±é¡Œ", level: "beginner" },
        { japanese: "åˆã‚ã¦ãƒãƒ¯ã‚¤ã«æ¥ã¾ã—ãŸ", english: "This is my first time in Hawaii", hint: "åˆè¨ªå•ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "ãƒãƒ¯ã‚¤ã¯ç¾ã—ã„ã§ã™ã­", english: "Hawaii is beautiful", hint: "æ„Ÿæƒ³ã‚’ä¼ãˆã‚‹", level: "beginner" },
        { japanese: "æ¥½ã—ã‚“ã§ã„ã¾ã™", english: "I'm having a great time", hint: "æ¥½ã—ã‚“ã§ã„ã‚‹ã“ã¨ã‚’ä¼ãˆã‚‹", level: "beginner" }
    ]
};

// ============================================
// ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»è¨­å®šé–¢æ•°
// ============================================

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(screen => {
        screen.classList.remove('active');
    });
    document.getElementById(screenId).classList.add('active');
}

function showMenu() {
    showScreen('menuScreen');
    currentMode = '';
    document.getElementById('quizSettings').style.display = 'none';
    
    // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.mode-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨ã‚¹ã‚³ã‚¢ã‚’éè¡¨ç¤º
    document.querySelector('.progress-bar').style.display = 'none';
    document.getElementById('progressText').style.display = 'none';
    document.getElementById('scoreDisplay').style.display = 'none';
}

function selectMode(mode) {
    currentMode = mode;
    
    // ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('.mode-card').forEach(card => {
        card.classList.remove('selected');
    });
    event.target.closest('.mode-card').classList.add('selected');
    
    // è¨­å®šç”»é¢ã‚’è¡¨ç¤ºï¼ˆAIãƒãƒ£ãƒƒãƒˆã®å ´åˆã¯åˆ¥ç”»é¢ã¸ï¼‰
    if (mode === 'aichat') {
        showScreen('aichatScreen');
        loadWorkerUrl();
    } else {
        document.getElementById('quizSettings').style.display = 'block';
    }
}

function selectScene(scene) {
    selectedScene = scene;
    
    // ã‚·ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-scene]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-scene="${scene}"]`).classList.add('active');
}

function selectLevel(level) {
    selectedLevel = level;
    
    // ãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-level]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-level="${level}"]`).classList.add('active');
}

function startSelectedMode() {
    if (currentMode === 'quiz') {
        startQuiz();
    } else if (currentMode === 'practice') {
        startPractice();
    }
}

// ============================================
// ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰é–¢æ•°
// ============================================

function startQuiz() {
    // è³ªå•ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    currentQuestions = [];
    
    if (selectedScene === 'all') {
        // å…¨ã‚·ãƒ¼ãƒ³ã‹ã‚‰è³ªå•ã‚’é›†ã‚ã‚‹
        for (let scene in phrasesDatabase) {
            currentQuestions = currentQuestions.concat(
                phrasesDatabase[scene].filter(q => 
                    selectedLevel === 'all' || q.level === selectedLevel
                )
            );
        }
    } else {
        // é¸æŠã•ã‚ŒãŸã‚·ãƒ¼ãƒ³ã‹ã‚‰è³ªå•ã‚’å–å¾—
        currentQuestions = phrasesDatabase[selectedScene].filter(q => 
            selectedLevel === 'all' || q.level === selectedLevel
        );
    }
    
    if (currentQuestions.length === 0) {
        alert('é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    currentQuestions = currentQuestions.sort(() => Math.random() - 0.5);
    
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    currentQuestionIndex = 0;
    correctCount = 0;
    incorrectCount = 0;
    
    // ç”»é¢ã‚’è¡¨ç¤º
    showScreen('quizScreen');
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨ã‚¹ã‚³ã‚¢ã‚’è¡¨ç¤º
    document.querySelector('.progress-bar').style.display = 'block';
    document.getElementById('progressText').style.display = 'block';
    document.getElementById('scoreDisplay').style.display = 'block';
    
    // æœ€åˆã®å•é¡Œã‚’è¡¨ç¤º
    displayQuestion();
    updateProgress();
}

function displayQuestion() {
    const question = currentQuestions[currentQuestionIndex];
    
    // ã‚·ãƒ¼ãƒ³åã‚’å–å¾—
    let sceneName = 'å…¨ã‚·ãƒ¼ãƒ³';
    for (let scene in phrasesDatabase) {
        if (phrasesDatabase[scene].includes(question)) {
            sceneName = sceneNames[scene] || scene;
            break;
        }
    }
    
    document.getElementById('scene').textContent = sceneName;
    document.getElementById('levelBadge').textContent = question.level === 'beginner' ? 'åˆç´š' : 'ä¸Šç´š';
    
    // è³ªå•ã‚’è¡¨ç¤º
    document.getElementById('japanese').textContent = question.japanese;
    
    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
    const contextBox = document.getElementById('contextBox');
    if (question.context) {
        contextBox.textContent = question.context;
        contextBox.classList.add('show');
    } else {
        contextBox.classList.remove('show');
    }
    
    // ãƒ’ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('hintBox').classList.add('hidden');
    document.getElementById('hintBox').textContent = '';
    
    // å›ç­”æ¬„ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('answerInput').value = '';
    document.getElementById('clearBtn').classList.remove('show');
    
    // çµæœã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('resultBox').classList.add('hidden');
    document.getElementById('resultBox').innerHTML = '';
    
    // æ­£è§£è¡¨ç¤ºã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('answerBox').classList.add('hidden');
    isAnswerShown = false;
    
    // çµ±è¨ˆã‚’æ›´æ–°
    updateStats();
}

function updateProgress() {
    const progress = ((currentQuestionIndex + 1) / currentQuestions.length) * 100;
    document.getElementById('progressFill').style.width = `${progress}%`;
    document.getElementById('progressText').textContent = `å•é¡Œ ${currentQuestionIndex + 1} / ${currentQuestions.length}`;
    
    document.getElementById('score').textContent = correctCount;
    document.getElementById('total').textContent = correctCount + incorrectCount;
}

function updateStats() {
    document.getElementById('correct').textContent = correctCount;
    document.getElementById('incorrect').textContent = incorrectCount;
    
    const total = correctCount + incorrectCount;
    const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    document.getElementById('accuracy').textContent = `${accuracy}%`;
}

function toggleHint() {
    const hintBox = document.getElementById('hintBox');
    const question = currentQuestions[currentQuestionIndex];
    
    if (hintBox.classList.contains('hidden')) {
        hintBox.textContent = question.hint;
        hintBox.classList.remove('hidden');
        document.getElementById('hintBtn').textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’éš ã™';
    } else {
        hintBox.classList.add('hidden');
        document.getElementById('hintBtn').textContent = 'ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹';
    }
}

function speakAnswer() {
    const question = currentQuestions[currentQuestionIndex];
    const utterance = new SpeechSynthesisUtterance(question.english);
    utterance.lang = 'en-US';
    utterance.rate = 1.0;
    speechSynthesis.speak(utterance);
}

function speakAnswerSlow() {
    const question = currentQuestions[currentQuestionIndex];
    const utterance = new SpeechSynthesisUtterance(question.english);
    utterance.lang = 'en-US';
    utterance.rate = 0.7;
    speechSynthesis.speak(utterance);
}

function toggleAnswer() {
    const answerBox = document.getElementById('answerBox');
    const question = currentQuestions[currentQuestionIndex];
    
    if (isAnswerShown) {
        answerBox.classList.add('hidden');
        isAnswerShown = false;
        document.getElementById('showAnswerBtn').innerHTML = 'ğŸ‘ï¸ æ­£è§£ã‚’è¦‹ã‚‹';
    } else {
        answerBox.textContent = question.english;
        answerBox.classList.remove('hidden');
        isAnswerShown = true;
        document.getElementById('showAnswerBtn').innerHTML = 'âŒ æ­£è§£ã‚’éš ã™';
    }
}

function isAnswerCorrect(userAnswer, correctAnswer) {
    // æ­£è¦åŒ–ï¼ˆå°æ–‡å­—å¤‰æ›ã€å‰å¾Œã®ç©ºç™½å‰Šé™¤ã€ä½™åˆ†ãªç©ºç™½ã‚’1ã¤ã«çµ±ä¸€ï¼‰
    const normalizeText = (text) => {
        return text.toLowerCase().trim().replace(/\s+/g, ' ');
    };
    
    const normalizedUser = normalizeText(userAnswer);
    const normalizedCorrect = normalizeText(correctAnswer);
    
    // å®Œå…¨ä¸€è‡´
    if (normalizedUser === normalizedCorrect) {
        return true;
    }
    
    // å¥èª­ç‚¹ã‚’é™¤å¤–ã—ã¦æ¯”è¼ƒ
    const removePunctuation = (text) => {
        return text.replace(/[.,!?;:'"]/g, '');
    };
    
    if (removePunctuation(normalizedUser) === removePunctuation(normalizedCorrect)) {
        return true;
    }
    
    // åŒç¾©èªãƒšã‚¢ã®ãƒã‚§ãƒƒã‚¯
    const synonymPairs = [
        ['meal', 'combo'],
        ['that\'s all', 'that\'s it'],
        ['thanks', 'thank you'],
        ['do you accept', 'can i use'],
        ['i\'ll have that one', 'that one please'],
        ['restroom', 'bathroom'],
        ['toilet', 'restroom'],
        ['hi', 'hello'],
        ['hey', 'hello'],
        ['check', 'bill'],
        ['receipt', 'bill']
    ];
    
    for (let [word1, word2] of synonymPairs) {
        const option1 = normalizedCorrect.replace(word1, word2);
        const option2 = normalizedCorrect.replace(word2, word1);
        
        if (normalizedUser === option1 || normalizedUser === option2) {
            return true;
        }
        
        // å¥èª­ç‚¹ãªã—ã§ã‚‚æ¯”è¼ƒ
        if (removePunctuation(normalizedUser) === removePunctuation(option1) ||
            removePunctuation(normalizedUser) === removePunctuation(option2)) {
            return true;
        }
    }
    
    return false;
}

function checkAnswer() {
    const userAnswer = document.getElementById('answerInput').value.trim();
    const question = currentQuestions[currentQuestionIndex];
    const resultBox = document.getElementById('resultBox');
    
    if (!userAnswer) {
        resultBox.innerHTML = '<div class="result warning">âš ï¸ å›ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
        resultBox.classList.remove('hidden');
        return;
    }
    
    if (isAnswerCorrect(userAnswer, question.english)) {
        correctCount++;
        resultBox.innerHTML = `
            <div class="result correct">
                âœ… æ­£è§£ã§ã™!ç´ æ™´ã‚‰ã—ã„!
            </div>
        `;
    } else {
        incorrectCount++;
        resultBox.innerHTML = `
            <div class="result incorrect">
                âŒ ä¸æ­£è§£ã§ã™
                <div class="correct-answer">æ­£è§£: ${question.english}</div>
            </div>
        `;
    }
    
    resultBox.classList.remove('hidden');
    updateStats();
    updateProgress();
    
    // çµ±è¨ˆã‚’ä¿å­˜
    saveStats();
}

function nextQuestion() {
    if (currentQuestionIndex < currentQuestions.length - 1) {
        currentQuestionIndex++;
        displayQuestion();
        updateProgress();
    } else {
        showResults();
    }
}

function previousQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
        updateProgress();
    }
}

function clearInput() {
    document.getElementById('answerInput').value = '';
    document.getElementById('clearBtn').classList.remove('show');
}

// å…¥åŠ›æ¬„ã®ç›£è¦–
document.addEventListener('DOMContentLoaded', function() {
    const answerInput = document.getElementById('answerInput');
    if (answerInput) {
        answerInput.addEventListener('input', function() {
            if (this.value.length > 0) {
                document.getElementById('clearBtn').classList.add('show');
            } else {
                document.getElementById('clearBtn').classList.remove('show');
            }
        });
        
        // Enterã‚­ãƒ¼ã§å›ç­”ã‚’ãƒã‚§ãƒƒã‚¯
        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                checkAnswer();
            }
        });
    }
});

function showResults() {
    const total = correctCount + incorrectCount;
    const accuracy = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    
    document.getElementById('finalCorrect').textContent = correctCount;
    document.getElementById('finalIncorrect').textContent = incorrectCount;
    document.getElementById('finalAccuracy').textContent = `${accuracy}%`;
    
    showScreen('resultsScreen');
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã¨ã‚¹ã‚³ã‚¢ã‚’éè¡¨ç¤º
    document.querySelector('.progress-bar').style.display = 'none';
    document.getElementById('progressText').style.display = 'none';
    document.getElementById('scoreDisplay').style.display = 'none';
}

function retryQuiz() {
    startQuiz();
}

// ============================================
// éŸ³å£°å…¥åŠ›é–¢æ•°
// ============================================

function toggleVoiceInput() {
    if (!recognition) {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }
    
    if (isRecording) {
        stopVoiceInput();
    } else {
        startVoiceInput();
    }
}

function startVoiceInput() {
    try {
        recognition.start();
        isRecording = true;
        document.getElementById('voiceBtn').textContent = 'ğŸ”´ éŒ²éŸ³ä¸­...';
    } catch (error) {
        console.error('Voice input start error:', error);
    }
}

function stopVoiceInput() {
    if (isRecording) {
        try {
            recognition.stop();
        } catch (error) {
            console.error('Voice input stop error:', error);
        }
        isRecording = false;
        document.getElementById('voiceBtn').textContent = 'ğŸ¤ éŸ³å£°å…¥åŠ›';
    }
}

// ============================================
// ã‚¹ãƒ”ãƒ¼ã‚­ãƒ³ã‚°ç·´ç¿’é–¢æ•°
// ============================================

function startPractice() {
    // è³ªå•ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    practiceQuestions = [];
    
    if (selectedScene === 'all') {
        for (let scene in phrasesDatabase) {
            practiceQuestions = practiceQuestions.concat(
                phrasesDatabase[scene].filter(q => 
                    selectedLevel === 'all' || q.level === selectedLevel
                )
            );
        }
    } else {
        practiceQuestions = phrasesDatabase[selectedScene].filter(q => 
            selectedLevel === 'all' || q.level === selectedLevel
        );
    }
    
    if (practiceQuestions.length === 0) {
        alert('é¸æŠã•ã‚ŒãŸæ¡ä»¶ã«è©²å½“ã™ã‚‹å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    
    // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
    practiceQuestions = practiceQuestions.sort(() => Math.random() - 0.5);
    
    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
    currentPracticeIndex = 0;
    practiceCorrectCount = 0;
    practiceIncorrectCount = 0;
    
    // ç”»é¢ã‚’è¡¨ç¤º
    showScreen('practiceScreen');
    displayPracticePhrase();
    updatePracticeStats();
}

function displayPracticePhrase() {
    const phrase = practiceQuestions[currentPracticeIndex];
    
    document.getElementById('practiceJapanese').textContent = phrase.japanese;
    document.getElementById('practiceEnglish').textContent = phrase.english;
    document.getElementById('recognitionResult').textContent = 'ã“ã“ã«éŸ³å£°èªè­˜çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
    
    // ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('scoreDisplay2').classList.add('hidden');
}

function updatePracticeStats() {
    document.getElementById('practiceCorrect').textContent = practiceCorrectCount;
    document.getElementById('practiceIncorrect').textContent = practiceIncorrectCount;
    
    const total = practiceCorrectCount + practiceIncorrectCount;
    const accuracy = total > 0 ? Math.round((practiceCorrectCount / total) * 100) : 0;
    document.getElementById('practiceAccuracy').textContent = `${accuracy}%`;
}

function togglePracticeRecording() {
    if (!practiceRecognition) {
        alert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
    }
    
    if (isPracticeRecording) {
        stopPracticeRecording();
    } else {
        startPracticeRecording();
    }
}

function startPracticeRecording() {
    try {
        practiceRecognition.start();
        isPracticeRecording = true;
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordIcon').textContent = 'ğŸ”´';
        document.getElementById('recordText').textContent = 'éŒ²éŸ³ä¸­...';
    } catch (error) {
        console.error('Practice recording start error:', error);
    }
}

function stopPracticeRecording() {
    if (isPracticeRecording) {
        try {
            practiceRecognition.stop();
        } catch (error) {
            console.error('Practice recording stop error:', error);
        }
        isPracticeRecording = false;
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordIcon').textContent = 'ğŸ¤';
        document.getElementById('recordText').textContent = 'éŒ²éŸ³é–‹å§‹';
    }
}

function speakPracticeAnswer() {
    const phrase = practiceQuestions[currentPracticeIndex];
    const utterance = new SpeechSynthesisUtterance(phrase.english);
    utterance.lang = 'en-US';
    utterance.rate = 0.9;
    speechSynthesis.speak(utterance);
}

function nextPracticePhrase() {
    if (currentPracticeIndex < practiceQuestions.length - 1) {
        currentPracticeIndex++;
        displayPracticePhrase();
    } else {
        currentPracticeIndex = 0;
        displayPracticePhrase();
    }
}

// ============================================
// AIãƒãƒ£ãƒƒãƒˆé–¢æ•°ï¼ˆGemini APIçµ±åˆç‰ˆï¼‰
// ============================================

// Worker URLè¨­å®šã®èª­ã¿è¾¼ã¿ã¨ä¿å­˜
function loadWorkerUrl() {
    const savedUrl = localStorage.getItem('workerApiUrl') || '';
    workerApiUrl = savedUrl;
    document.getElementById('workerUrl').value = savedUrl;
    updateApiStatus();
}

function saveWorkerUrl(url) {
    workerApiUrl = url;
    localStorage.setItem('workerApiUrl', url);
    updateApiStatus();
}

function updateApiStatus() {
    const statusEl = document.getElementById('apiStatus');
    if (workerApiUrl && workerApiUrl.startsWith('https://')) {
        statusEl.textContent = 'æ¥ç¶šæ¸ˆã¿';
        statusEl.className = 'api-status connected';
    } else {
        statusEl.textContent = 'æœªè¨­å®š';
        statusEl.className = 'api-status disconnected';
    }
}

// Worker URLå…¥åŠ›æ¬„ã®ç›£è¦–
document.addEventListener('DOMContentLoaded', function() {
    const workerUrlInput = document.getElementById('workerUrl');
    if (workerUrlInput) {
        workerUrlInput.addEventListener('input', function(e) {
            saveWorkerUrl(e.target.value.trim());
        });
    }
});

function selectAIScene(scene) {
    aiChatScene = scene;
    
    // AIã‚·ãƒ¼ãƒ³ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-aiscene]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-aiscene="${scene}"]`).classList.add('active');
}

function selectAILevel(level) {
    aiChatLevel = level;
    
    // AIãƒ¬ãƒ™ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
    document.querySelectorAll('[data-ailevel]').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-ailevel="${level}"]`).classList.add('active');
}

function startAIChat() {
    // Worker URLãƒã‚§ãƒƒã‚¯
    if (!workerApiUrl || !workerApiUrl.startsWith('https://')) {
        alert('Cloudflare Worker URLã‚’è¨­å®šã—ã¦ãã ã•ã„');
        return;
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
    chatHistory = [];
    
    // è¨­å®šç”»é¢ã‚’éè¡¨ç¤ºã€ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’è¡¨ç¤º
    document.getElementById('aichatSetup').classList.add('hidden');
    document.getElementById('aichatActive').classList.remove('hidden');
    
    // ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = '';
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆï¼ˆAIã‹ã‚‰ï¼‰
    const initialMessage = generateAIInitialMessage();
    addAIChatMessage(initialMessage, 'ai');
}

function generateAIInitialMessage() {
    const sceneMessages = {
        freetalk: `Hello! ğŸ˜Š Welcome to free talk!\n\nWhat would you like to talk about today? Travel, hobbies, daily life - anything you'd like to practice in English!\n\nLet's start with a simple self-introduction, shall we?\n\nï¼ˆã“ã‚“ã«ã¡ã¯!ä»Šæ—¥ã¯ä½•ã«ã¤ã„ã¦è©±ã—ãŸã„ã§ã™ã‹?ç°¡å˜ãªè‡ªå·±ç´¹ä»‹ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†!ï¼‰`,
        airport: `Welcome to the airport! âœˆï¸\n\nI'm a check-in staff member. How can I help you today?\n\nï¼ˆç©ºæ¸¯ã®ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒƒãƒ•ã§ã™ã€‚ã©ã®ã‚ˆã†ã«ãŠæ‰‹ä¼ã„ã—ã¾ã—ã‚‡ã†ã‹?ï¼‰`,
        hotel: `Welcome to our hotel! ğŸ¨\n\nI'm at the front desk. Are you checking in today?\n\nï¼ˆãƒ•ãƒ­ãƒ³ãƒˆãƒ‡ã‚¹ã‚¯ã§ã™ã€‚æœ¬æ—¥ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³ã•ã‚Œã¾ã™ã‹?ï¼‰`,
        restaurant: `Welcome to our restaurant! ğŸ½ï¸\n\nHi! I'll be your server today. Can I get you started with some drinks?\n\nï¼ˆã“ã‚“ã«ã¡ã¯!ä»Šæ—¥ã®ã‚µãƒ¼ãƒãƒ¼ã§ã™ã€‚ã¾ãšãŠé£²ã¿ç‰©ã¯ã„ã‹ãŒã§ã™ã‹?ï¼‰`,
        shopping: `Welcome! ğŸ›ï¸\n\nHi there! Looking for anything in particular today?\n\nï¼ˆã“ã‚“ã«ã¡ã¯!ä½•ã‹ãŠæ¢ã—ã§ã™ã‹?ï¼‰`,
        sightseeing: `Aloha! ğŸŒº\n\nWelcome to Hawaii! I'm a tour guide. Where would you like to visit today?\n\nï¼ˆãƒãƒ¯ã‚¤ã¸ã‚ˆã†ã“ã!ãƒ„ã‚¢ãƒ¼ã‚¬ã‚¤ãƒ‰ã§ã™ã€‚ä»Šæ—¥ã¯ã©ã¡ã‚‰ã¸è¡ŒããŸã„ã§ã™ã‹?ï¼‰`
    };
    
    return sceneMessages[aiChatScene] || sceneMessages.freetalk;
}

function addAIChatMessage(message, sender) {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.textContent = message;
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    
    // å±¥æ­´ã«è¿½åŠ 
    if (sender === 'user') {
        chatHistory.push({ role: 'user', content: message });
    } else {
        chatHistory.push({ role: 'assistant', content: message });
    }
}

function addLoadingMessage() {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    messageDiv.className = 'chat-message loading';
    messageDiv.id = 'loadingMessage';
    messageDiv.textContent = 'AIãŒå¿œç­”ã‚’ç”Ÿæˆä¸­...';
    chatContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
    return messageDiv;
}

function removeLoadingMessage() {
    const loadingMsg = document.getElementById('loadingMessage');
    if (loadingMsg) {
        loadingMsg.remove();
    }
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const message = input.value.trim();
    
    if (!message) {
        return;
    }
    
    // Worker URLãƒã‚§ãƒƒã‚¯
    if (!workerApiUrl || !workerApiUrl.startsWith('https://')) {
        alert('Cloudflare Worker URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
    }
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    addAIChatMessage(message, 'user');
    input.value = '';
    
    // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    sendBtn.disabled = true;
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    const loadingMsg = addLoadingMessage();
    
    try {
        // Cloudflare Workerã«é€ä¿¡
        const response = await fetch(workerApiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                scene: aiSceneNames[aiChatScene],
                level: aiLevelNames[aiChatLevel]
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‰Šé™¤
        removeLoadingMessage();
        
        // AIã®å¿œç­”ã‚’è¿½åŠ 
        if (data.error) {
            addAIChatMessage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.error}\n\nWorker URLã¨APIã‚­ãƒ¼ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'ai');
        } else {
            addAIChatMessage(data.response, 'ai');
        }
        
    } catch (error) {
        console.error('Chat error:', error);
        removeLoadingMessage();
        addAIChatMessage(`é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}\n\nWorker URLãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚`, 'ai');
    } finally {
        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        sendBtn.disabled = false;
    }
}

function endAIChat() {
    // ãƒãƒ£ãƒƒãƒˆç”»é¢ã‚’éè¡¨ç¤ºã€è¨­å®šç”»é¢ã‚’è¡¨ç¤º
    document.getElementById('aichatActive').classList.add('hidden');
    document.getElementById('aichatSetup').classList.remove('hidden');
}

// Enterã‚­ãƒ¼ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chatInput');
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
    }
});

// ============================================
// çµ±è¨ˆæ©Ÿèƒ½
// ============================================

function saveStats() {
    // localStorage ã«çµ±è¨ˆã‚’ä¿å­˜
    let stats = JSON.parse(localStorage.getItem('quizStats') || '{}');
    
    if (!stats.totalSessions) {
        stats.totalSessions = 0;
        stats.totalCorrect = 0;
        stats.totalQuestions = 0;
    }
    
    stats.totalSessions++;
    stats.totalCorrect += correctCount;
    stats.totalQuestions += correctCount + incorrectCount;
    
    localStorage.setItem('quizStats', JSON.stringify(stats));
}

function showStats() {
    const stats = JSON.parse(localStorage.getItem('quizStats') || '{}');
    
    document.getElementById('totalSessions').textContent = stats.totalSessions || 0;
    document.getElementById('totalCorrectStats').textContent = stats.totalCorrect || 0;
    document.getElementById('totalQuestionsStats').textContent = stats.totalQuestions || 0;
    
    const averageAccuracy = stats.totalQuestions > 0 
        ? Math.round((stats.totalCorrect / stats.totalQuestions) * 100)
        : 0;
    document.getElementById('averageAccuracy').textContent = `${averageAccuracy}%`;
    
    showScreen('statsScreen');
}

    </script>
</body>
</html>